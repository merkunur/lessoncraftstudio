<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find and Count Worksheet Generator</title>
    <script src="js/translations.js"></script>
    <!-- <script src="js/worksheet-base.js"></script> COMMENTED OUT LIKE SUBTRACTION-V2.HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&family=Fredoka:wght@400;500;600&family=Lexend+Deca&family=Nunito:wght@400;700&family=Quicksand:wght@300..700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        :root {
            --app-font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --app-bg-dark: #2c2c2e;
            --app-surface-dark: #3a3a3e;
            --app-border-dark: #4a4a4a;
            --app-text-primary-dark-theme: #e0e0e0;
            --app-text-secondary-dark-theme: #a0a0a0;
            --app-bg-light: #f0f2f5;
            --app-surface-light: #ffffff;
            --app-border-light: #dce1e6;
            --app-text-primary-light-theme: #1c1c1e;
            --app-text-secondary-light-theme: #545458;
            --app-accent-primary: #007aff;
            --app-accent-primary-hover: #005ecb;
            --app-accent-danger: #ff3b30;
            --app-accent-danger-hover: #d92c23;
            --sidebar-width: 340px;
        }

        /* Global Reset & Layout */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--app-font-stack);
            display: flex;
            margin: 0;
            height: 100vh;
            background-color: var(--app-bg-light);
            overflow: hidden;
            color: var(--app-text-primary-light-theme);
            position: relative;
        }
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Sidebar Panel */
        .panel {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background-color: var(--app-bg-dark);
            color: var(--app-text-primary-dark-theme);
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow-y: hidden;
            z-index: 10;
            padding: 0;
            transition: transform 0.3s ease-in-out;
        }

        .panel-header {
            padding: 20px 25px;
            text-align: left;
            border-bottom: 1px solid var(--app-border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--app-text-primary-dark-theme);
            margin: 0;
        }

        .panel-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 10px 15px;
        }

        /* Accordion Styles */
        .accordion-item {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--app-border-dark);
            margin-bottom: 0;
            border-radius: 0;
            overflow: hidden;
        }
        .accordion-item:last-child {
            border-bottom: none;
        }
        .accordion-button {
            background-color: transparent;
            color: var(--app-text-primary-dark-theme);
            width: 100%;
            border: none;
            text-align: left;
            padding: 18px 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.15s ease;
        }
        .accordion-button:hover {
            color: var(--app-text-primary-dark-theme);
            background-color: rgba(255,255,255,0.05);
        }
        .accordion-button::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            font-size: 12px;
            transition: transform 0.2s ease-in-out;
        }
        .accordion-button.active::after {
            transform: rotate(-180deg);
        }
        .accordion-content {
            padding: 10px 10px 20px 10px;
            display: none;
            background-color: transparent;
            border-top: none;
        }
        .accordion-content.active {
            display: block;
        }
        .accordion-content h4 {
            font-size: 13px;
            color: var(--app-text-secondary-dark-theme);
            margin-top: 15px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--app-border-dark);
            padding-bottom: 6px;
            font-weight: 500;
        }
        .accordion-content h4:first-child {
            margin-top: 0;
        }

        /* Form Elements */
        .accordion-content label {
            display: block;
            font-size: 13px;
            font-weight: 400;
            color: var(--app-text-secondary-dark-theme);
            margin-bottom: 6px;
        }
        .accordion-content input[type="text"],
        .accordion-content input[type="number"],
        .accordion-content textarea,
        .accordion-content select {
            width: 100%;
            padding: 8px 10px;
            font-size: 13px;
            border-radius: 5px;
            border: 1px solid var(--app-border-dark);
            background-color: var(--app-surface-dark);
            color: var(--app-text-primary-dark-theme);
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        .accordion-content input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            vertical-align: middle;
            accent-color: var(--app-accent-primary);
        }

        .accordion-content button {
            background-color: var(--app-surface-dark);
            color: var(--app-text-primary-dark-theme);
            border: 1px solid var(--app-border-dark);
            font-weight: 500;
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .accordion-content button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Main Content Area */
        .content {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            background-color: var(--app-bg-light);
        }

        /* Canvas Container */
        .canvas-container {
            width: 100%;
            max-width: 850px;
            margin: 0 auto 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-radius: 10px;
            background-color: var(--app-surface-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            border: 1px solid var(--app-border-light);
            background: white;
            margin: 0 auto;
            display: block;
        }

        /* Dictionary/Image Library Styles */
        .dictionary {
            background: white;
            border: 1px solid var(--app-border-light);
            border-radius: 8px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .dictionary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .dictionary-item:hover {
            background-color: rgba(0, 122, 255, 0.05);
            border-color: var(--app-accent-primary);
            transform: translateY(-2px);
        }

        .dictionary-item.selected {
            background-color: rgba(0, 122, 255, 0.1);
            border-color: var(--app-accent-primary);
        }

        .dictionary-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        .dictionary-item span {
            font-size: 11px;
            text-align: center;
            color: var(--app-text-secondary-light-theme);
            word-break: break-word;
            line-height: 1.2;
        }

        /* Border/Background Thumbnails */
        .border-thumbnail-item {
            display: inline-block;
            margin: 5px;
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }

        .border-thumbnail-item:hover {
            border-color: var(--app-accent-primary);
            transform: scale(1.05);
        }

        .border-thumbnail-item.selected {
            border-color: var(--app-accent-primary);
            background-color: rgba(0, 122, 255, 0.1);
        }

        .border-thumbnail-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            display: block;
        }

        /* Border/Background Dictionary containers */
        #borderDictionary, #backgroundDictionary {
            padding: 10px;
            min-height: 100px;
            background-color: var(--app-surface-dark);
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Loading State */
        .dictionary-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--app-text-secondary-light-theme);
        }

        .dictionary-message {
            text-align: center;
            color: var(--app-text-secondary-light-theme);
            padding: 40px;
            font-size: 14px;
        }

        /* Selected Images Preview */
        .selected-images-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: var(--app-surface-dark);
            border-radius: 5px;
            margin-bottom: 10px;
            min-height: 80px;
            justify-content: center;
            align-items: center;
        }

        .selected-images-preview img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border: 2px solid var(--app-accent-primary);
            border-radius: 5px;
            padding: 3px;
            background: white;
            cursor: pointer;
        }

        .selected-images-preview img:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .selected-count {
            color: var(--app-text-secondary-dark-theme);
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
        }

        /* Buttons */
        button {
            background-color: var(--app-accent-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 5px;
        }

        button:hover {
            background-color: var(--app-accent-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .danger-button {
            background-color: var(--app-accent-danger);
        }

        .danger-button:hover {
            background-color: var(--app-accent-danger-hover);
        }

        /* Message Toast */
        .message-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .message-toast.success {
            background-color: #10b981;
        }

        .message-toast.error {
            background-color: var(--app-accent-danger);
        }

        .message-toast.info {
            background-color: var(--app-accent-primary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .panel {
                position: absolute;
                transform: translateX(-100%);
            }
            .panel.mobile-open {
                transform: translateX(0);
            }
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="panel">
            <div class="panel-header">
                <h2 data-translate="find_count_worksheet">Find and Count Worksheet</h2>
            </div>
            <div class="panel-content">
                <!-- Worksheet Settings -->
                <div class="accordion-item">
                    <button class="accordion-button active" data-translate="worksheet_settings">Worksheet Settings</button>
                    <div class="accordion-content active">
                        <label data-translate="grid_size">Grid Size:</label>
                        <input type="number" id="gridSize" value="8" min="4" max="12" />

                        <label data-translate="total_images">Total Images to Place:</label>
                        <input type="number" id="totalImages" value="30" min="10" max="50" />

                        <label data-translate="target_images">Target Images to Find:</label>
                        <input type="number" id="targetCount" value="3" min="1" max="5" />

                        <label data-translate="show_grid_lines">Show Grid Lines:</label>
                        <input type="checkbox" id="showGridLines" />

                        <label data-translate="random_rotation">Random Rotation:</label>
                        <input type="checkbox" id="randomRotation" checked />
                    </div>
                </div>

                <!-- Image Library -->
                <div class="accordion-item">
                    <button class="accordion-button active" data-translate="image_library">Image Library</button>
                    <div class="accordion-content active">
                        <label data-translate="select_theme">Select Theme:</label>
                        <select id="themeSelect">
                            <option value="all" data-translate="all_themes">All Themes</option>
                        </select>

                        <label data-translate="search_images">Search Images:</label>
                        <input type="text" id="searchInput" placeholder="Search..." />

                        <div id="imageDictionary" class="dictionary">
                            <div class="dictionary-loading">Loading images...</div>
                        </div>

                        <h4 data-translate="selected_images">Selected Images</h4>
                        <div id="selectedImagesPreview" class="selected-images-preview">
                            <span class="dictionary-message">No images selected</span>
                        </div>
                        <div id="selectedCount" class="selected-count">Selected: 0</div>
                    </div>
                </div>

                <!-- Design Options -->
                <div class="accordion-item">
                    <button class="accordion-button" data-translate="design_options">Design Options</button>
                    <div class="accordion-content">
                        <label data-translate="worksheet_title">Worksheet Title:</label>
                        <input type="text" id="worksheetTitle" value="Find and Count!" />

                        <label data-translate="instruction_text">Instruction Text:</label>
                        <textarea id="instructionText" rows="2">Find and count all the items shown below:</textarea>

                        <label data-translate="font_family">Font Family:</label>
                        <select id="fontFamily">
                            <option value="Fredoka">Fredoka</option>
                            <option value="Baloo 2">Baloo 2</option>
                            <option value="Quicksand">Quicksand</option>
                            <option value="Nunito">Nunito</option>
                        </select>

                        <label data-translate="title_font_size">Title Font Size:</label>
                        <input type="number" id="titleFontSize" value="28" min="18" max="48" />

                        <label data-translate="image_size">Image Size:</label>
                        <input type="number" id="imageSize" value="50" min="30" max="80" />
                    </div>
                </div>

                <!-- Borders & Backgrounds -->
                <div class="accordion-item">
                    <button class="accordion-button active" data-translate="borders_backgrounds">Borders & Backgrounds</button>
                    <div class="accordion-content active">
                        <h4>Background</h4>
                        <label for="backgroundThemeSelect">Background Theme:</label>
                        <select id="backgroundThemeSelect">
                            <option value="none">None</option>
                        </select>
                        <button id="reloadBackgroundsBtn" style="margin-left: 10px; padding: 5px;">Reload Backgrounds</button>
                        <div id="backgroundDictionary"><p class="dictionary-message">Select a theme for backgrounds.</p></div>

                        <h4>Border</h4>
                        <label for="borderThemeSelect">Border Theme:</label>
                        <select id="borderThemeSelect">
                            <option value="none">None</option>
                        </select>
                        <button id="reloadBordersBtn" style="margin-left: 10px; padding: 5px;">Reload Borders</button>
                        <div id="borderDictionary"><p class="dictionary-message">Select a theme to see borders.</p></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="accordion-item">
                    <button class="accordion-button" data-translate="actions">Actions</button>
                    <div class="accordion-content">
                        <button id="generateBtn" data-translate="generate_worksheet">Generate Worksheet</button>
                        <button id="clearBtn" class="danger-button" data-translate="clear_worksheet">Clear Worksheet</button>
                        <button id="downloadPdfBtn" data-translate="download_pdf">Download PDF</button>
                        <button id="printBtn" data-translate="print">Print</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <h1 data-translate="find_count_title">Find and Count Worksheet Generator</h1>

            <div class="canvas-container">
                <canvas id="worksheetCanvas"></canvas>
            </div>

            <div class="canvas-container" style="display: none;">
                <h2 data-translate="answer_key">Answer Key</h2>
                <canvas id="answerCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        console.log('SCRIPT STARTED - find-and-count-v2.html');

        // IMMEDIATE TEST - Does JavaScript even work?
        window.onerror = function(msg, url, line, col, error) {
            console.error('Global error:', msg, 'at line', line);
            alert('Global JavaScript Error at line ' + line + ': ' + msg);
            return false;
        };

        // Initialize WorksheetBase - COMMENTED OUT BECAUSE worksheet-base.js IS NOT LOADED
        // const worksheetApp = new WorksheetBase({
        //     apiVersion: 'v2',
        //     enableCaching: true,
        //     cacheTTL: 5 * 60 * 1000,
        //     enableLazyLoad: true,
        //     defaultTheme: 'animals'
        // });

        // App-specific variables
        console.log('Setting currentLocale...');
        console.log('typeof getCurrentLocale:', typeof getCurrentLocale);
        let currentLocale = typeof getCurrentLocale !== 'undefined' ? getCurrentLocale() : 'en';
        console.log('currentLocale set to:', currentLocale);
        let worksheetCanvas, answerCanvas;
        let selectedImages = [];
        let targetImages = [];
        let placedImages = [];
        let currentBorder = null;
        let currentBackground = null;

        // Initialize canvases
        function initializeCanvases() {
            worksheetCanvas = new fabric.Canvas('worksheetCanvas', {
                width: 816,
                height: 1056,
                backgroundColor: 'white'
            });

            answerCanvas = new fabric.Canvas('answerCanvas', {
                width: 816,
                height: 1056,
                backgroundColor: 'white'
            });
        }

        // Load themes into dropdown - SIMPLIFIED WITHOUT WorksheetBase
        async function loadThemes() {
            const themeSelect = document.getElementById('themeSelect');

            try {
                // Fetch themes directly from API like subtraction-v2.html does
                const response = await fetch('/api/themes');
                if (!response.ok) {
                    console.error('Failed to load themes');
                    return Promise.resolve(); // ALWAYS return a promise
                }

                const themes = await response.json();

                // Keep "All Themes" option
                themeSelect.innerHTML = '<option value="all" data-translate="all_themes">All Themes</option>';

                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme.folder_name || theme;
                    option.textContent = theme.translations?.[currentLocale] || theme.folder_name || theme;
                    themeSelect.appendChild(option);
                });

                // Load initial images
                loadImages();
                return Promise.resolve(); // ALWAYS return a promise
            } catch (error) {
                console.error('Error loading themes:', error);
                return Promise.resolve(); // ALWAYS return a promise even on error
            }
        }

        // Add border to canvas
        function addBorderToCanvas(imagePath) {
            [worksheetCanvas, answerCanvas].forEach(canvas => {
                const existing = canvas.getObjects().find(obj => obj.isBorder);
                if (existing) canvas.remove(existing);

                fabric.Image.fromURL(imagePath, function(img) {
                    img.scaleToWidth(canvas.width);
                    img.scaleToHeight(canvas.height);
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false,
                        isBorder: true
                    });
                    canvas.add(img);
                    canvas.sendToBack(img);
                    if (canvas.getObjects().find(obj => obj.isBackground)) {
                        canvas.sendToBack(canvas.getObjects().find(obj => obj.isBackground));
                    }
                    canvas.renderAll();
                });
            });
            currentBorder = imagePath;
        }

        // Add background to canvas
        function addBackgroundToCanvas(imagePath) {
            [worksheetCanvas, answerCanvas].forEach(canvas => {
                const existing = canvas.getObjects().find(obj => obj.isBackground);
                if (existing) canvas.remove(existing);

                fabric.Image.fromURL(imagePath, function(img) {
                    img.scaleToWidth(canvas.width);
                    img.scaleToHeight(canvas.height);
                    img.set({
                        left: 0,
                        top: 0,
                        opacity: 0.3,
                        selectable: false,
                        evented: false,
                        isBackground: true
                    });
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();
                });
            });
            currentBackground = imagePath;
        }

        // Load images using WorksheetBase
        async function loadImages() {
            const theme = document.getElementById('themeSelect').value;
            const search = document.getElementById('searchInput').value.trim();
            const dictionary = document.getElementById('imageDictionary');

            dictionary.innerHTML = '<div class="dictionary-loading">Loading images...</div>';

            try {
                // Fetch images directly from API like subtraction-v2.html
                let url = `/api/images?locale=${currentLocale}`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                } else if (theme === 'all') {
                    url += `&theme=animals`; // Default to animals
                } else {
                    url += `&theme=${theme}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch images');
                }

                const data = await response.json();
                const images = data.images || data;

                if (!images || images.length === 0) {
                    dictionary.innerHTML = '<div class="dictionary-message">No images found</div>';
                    return;
                }

                dictionary.innerHTML = '';

                images.forEach(image => {
                    const item = document.createElement('div');
                    item.className = 'dictionary-item';
                    item.dataset.imageId = image.id;
                    item.dataset.imagePath = image.path;
                    item.dataset.imageName = image.name || image.word;

                    const img = document.createElement('img');
                    img.src = image.thumbnail || image.path;
                    img.alt = image.name || image.word;
                    img.loading = 'lazy';

                    const label = document.createElement('span');
                    label.textContent = image.name || image.word;

                    item.appendChild(img);
                    item.appendChild(label);

                    item.addEventListener('click', () => selectImage(image));

                    dictionary.appendChild(item);
                });

                // Highlight already selected items
                selectedImages.forEach(selImg => {
                    const item = document.querySelector(`[data-image-id="${selImg.id}"]`);
                    if (item) item.classList.add('selected');
                });

                // No worksheetApp.setupLazyLoading since we're not using WorksheetBase

            } catch (error) {
                console.error('Failed to load images:', error);
                dictionary.innerHTML = '<div class="dictionary-message">Failed to load images. Please try again.</div>';
            }
        }

        // Select image for worksheet
        function selectImage(image) {
            const maxImages = 10;
            const existingIndex = selectedImages.findIndex(img => img.id === image.id);

            if (existingIndex === -1) {
                if (selectedImages.length >= maxImages) {
                    showMessage(`Maximum ${maxImages} images allowed`, 'error');
                    return;
                }
                selectedImages.push(image);
                showMessage(`Selected: ${image.name}`, 'success');

                const item = document.querySelector(`[data-image-id="${image.id}"]`);
                if (item) item.classList.add('selected');
            } else {
                selectedImages.splice(existingIndex, 1);
                showMessage(`Deselected: ${image.name}`, 'info');

                const item = document.querySelector(`[data-image-id="${image.id}"]`);
                if (item) item.classList.remove('selected');
            }

            updateSelectedPreview();
        }

        // Update selected images preview
        function updateSelectedPreview() {
            const preview = document.getElementById('selectedImagesPreview');
            const count = document.getElementById('selectedCount');

            if (selectedImages.length === 0) {
                preview.innerHTML = '<span class="dictionary-message">No images selected</span>';
            } else {
                preview.innerHTML = '';
                selectedImages.forEach((img, index) => {
                    const imgEl = document.createElement('img');
                    imgEl.src = img.thumbnail || img.path;
                    imgEl.alt = img.name;
                    imgEl.title = img.name;
                    imgEl.onclick = () => {
                        selectedImages.splice(index, 1);
                        const item = document.querySelector(`[data-image-id="${img.id}"]`);
                        if (item) item.classList.remove('selected');
                        updateSelectedPreview();
                        showMessage(`Removed: ${img.name}`, 'info');
                    };
                    preview.appendChild(imgEl);
                });
            }

            count.textContent = `Selected: ${selectedImages.length}`;
        }

        // Generate worksheet
        function generateWorksheet() {
            const gridSize = parseInt(document.getElementById('gridSize').value);
            const totalImages = parseInt(document.getElementById('totalImages').value);
            const targetCount = parseInt(document.getElementById('targetCount').value);
            const showGridLines = document.getElementById('showGridLines').checked;
            const randomRotation = document.getElementById('randomRotation').checked;
            const title = document.getElementById('worksheetTitle').value;
            const instruction = document.getElementById('instructionText').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const titleFontSize = parseInt(document.getElementById('titleFontSize').value);
            const imageSize = parseInt(document.getElementById('imageSize').value);

            if (selectedImages.length < targetCount) {
                showMessage(`Please select at least ${targetCount} images`, 'error');
                return;
            }

            // Clear canvases
            worksheetCanvas.clear();
            answerCanvas.clear();
            worksheetCanvas.backgroundColor = 'white';
            answerCanvas.backgroundColor = 'white';

            // Re-add border and background if they exist
            if (currentBackground) addBackgroundToCanvas(currentBackground);
            if (currentBorder) addBorderToCanvas(currentBorder);

            // Select random target images
            targetImages = [];
            const tempImages = [...selectedImages];
            for (let i = 0; i < targetCount && tempImages.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * tempImages.length);
                targetImages.push(tempImages.splice(randomIndex, 1)[0]);
            }

            // Draw title
            const titleText = new fabric.Text(title, {
                left: worksheetCanvas.width / 2,
                top: 40,
                fontSize: titleFontSize,
                fontFamily: fontFamily,
                fontWeight: 'bold',
                fill: '#333',
                originX: 'center',
                originY: 'center',
                selectable: false
            });
            worksheetCanvas.add(titleText);
            answerCanvas.add(titleText.clone());

            // Draw instruction
            const instructionTextObj = new fabric.Text(instruction, {
                left: worksheetCanvas.width / 2,
                top: 80,
                fontSize: 16,
                fontFamily: fontFamily,
                fill: '#555',
                originX: 'center',
                originY: 'center',
                selectable: false
            });
            worksheetCanvas.add(instructionTextObj);
            answerCanvas.add(instructionTextObj.clone());

            // Draw target images to find
            const targetY = 140;
            const targetSpacing = 100;
            const startX = (worksheetCanvas.width - (targetImages.length * targetSpacing)) / 2;

            targetImages.forEach((img, index) => {
                const x = startX + (index * targetSpacing) + targetSpacing / 2;

                // Draw on worksheet
                fabric.Image.fromURL(img.path, function(fabricImg) {
                    fabricImg.set({
                        left: x,
                        top: targetY,
                        width: 60,
                        height: 60,
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    worksheetCanvas.add(fabricImg);

                    // Add count box
                    const box = new fabric.Rect({
                        left: x,
                        top: targetY + 50,
                        width: 40,
                        height: 30,
                        fill: 'transparent',
                        stroke: '#999',
                        strokeWidth: 2,
                        strokeDashArray: [5, 5],
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    worksheetCanvas.add(box);
                });

                // Draw on answer key with count
                fabric.Image.fromURL(img.path, function(fabricImg) {
                    fabricImg.set({
                        left: x,
                        top: targetY,
                        width: 60,
                        height: 60,
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    answerCanvas.add(fabricImg);
                });
            });

            // Create grid for find and count area
            const gridStartY = 250;
            const gridHeight = 700;
            const cellSize = gridHeight / gridSize;
            const gridStartX = (worksheetCanvas.width - (gridSize * cellSize)) / 2;

            // Draw grid lines if enabled
            if (showGridLines) {
                for (let i = 0; i <= gridSize; i++) {
                    // Horizontal lines
                    const hLine = new fabric.Line(
                        [gridStartX, gridStartY + i * cellSize, gridStartX + gridSize * cellSize, gridStartY + i * cellSize],
                        { stroke: '#e0e0e0', strokeWidth: 1, selectable: false }
                    );
                    worksheetCanvas.add(hLine);
                    answerCanvas.add(hLine.clone());

                    // Vertical lines
                    const vLine = new fabric.Line(
                        [gridStartX + i * cellSize, gridStartY, gridStartX + i * cellSize, gridStartY + gridHeight],
                        { stroke: '#e0e0e0', strokeWidth: 1, selectable: false }
                    );
                    worksheetCanvas.add(vLine);
                    answerCanvas.add(vLine.clone());
                }
            }

            // Place images randomly in grid
            placedImages = [];
            const positions = [];
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    positions.push({ row, col });
                }
            }

            // Shuffle positions
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }

            // Track counts for answer key
            const imageCounts = {};
            targetImages.forEach(img => {
                imageCounts[img.id] = 0;
            });

            // Place images
            for (let i = 0; i < Math.min(totalImages, positions.length); i++) {
                const pos = positions[i];
                const x = gridStartX + pos.col * cellSize + cellSize / 2;
                const y = gridStartY + pos.row * cellSize + cellSize / 2;

                // Choose random image (favoring target images)
                let chosenImage;
                if (Math.random() < 0.6 && targetImages.length > 0) {
                    // 60% chance to place a target image
                    chosenImage = targetImages[Math.floor(Math.random() * targetImages.length)];
                    if (imageCounts[chosenImage.id] !== undefined) {
                        imageCounts[chosenImage.id]++;
                    }
                } else {
                    // Place a random image from selected pool
                    chosenImage = selectedImages[Math.floor(Math.random() * selectedImages.length)];
                }

                const rotation = randomRotation ? (Math.random() - 0.5) * 60 : 0;

                // Place on worksheet
                fabric.Image.fromURL(chosenImage.path, function(fabricImg) {
                    fabricImg.set({
                        left: x,
                        top: y,
                        width: imageSize,
                        height: imageSize,
                        angle: rotation,
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    worksheetCanvas.add(fabricImg);
                });

                // Place on answer key (with highlight for target images)
                fabric.Image.fromURL(chosenImage.path, function(fabricImg) {
                    // Add highlight circle for target images
                    if (imageCounts[chosenImage.id] !== undefined) {
                        const circle = new fabric.Circle({
                            left: x,
                            top: y,
                            radius: imageSize / 2 + 5,
                            fill: 'transparent',
                            stroke: '#00cc00',
                            strokeWidth: 3,
                            originX: 'center',
                            originY: 'center',
                            selectable: false
                        });
                        answerCanvas.add(circle);
                    }

                    fabricImg.set({
                        left: x,
                        top: y,
                        width: imageSize,
                        height: imageSize,
                        angle: rotation,
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    answerCanvas.add(fabricImg);
                });
            }

            // Add counts to answer key
            targetImages.forEach((img, index) => {
                const x = startX + (index * targetSpacing) + targetSpacing / 2;
                const count = imageCounts[img.id] || 0;

                const countText = new fabric.Text(count.toString(), {
                    left: x,
                    top: targetY + 50,
                    fontSize: 20,
                    fontFamily: fontFamily,
                    fontWeight: 'bold',
                    fill: '#00cc00',
                    originX: 'center',
                    originY: 'center',
                    selectable: false
                });
                answerCanvas.add(countText);
            });

            // Show answer key
            document.querySelector('.canvas-container:nth-child(2)').style.display = 'block';

            showMessage('Worksheet generated!', 'success');
        }

        // Clear worksheet
        function clearWorksheet() {
            worksheetCanvas.clear();
            answerCanvas.clear();
            worksheetCanvas.backgroundColor = 'white';
            answerCanvas.backgroundColor = 'white';
            selectedImages = [];
            targetImages = [];
            placedImages = [];
            currentBorder = null;
            currentBackground = null;

            document.querySelectorAll('.dictionary-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.querySelectorAll('.border-thumbnail-item').forEach(item => {
                item.classList.remove('selected');
            });

            updateSelectedPreview();

            document.querySelector('.canvas-container:nth-child(2)').style.display = 'none';

            showMessage('Worksheet cleared', 'info');
        }

        // Download as PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'letter');

            const worksheetData = worksheetCanvas.toDataURL('image/png');
            pdf.addImage(worksheetData, 'PNG', 0, 0, 612, 792);

            if (document.querySelector('.canvas-container:nth-child(2)').style.display !== 'none') {
                pdf.addPage();
                const answerData = answerCanvas.toDataURL('image/png');
                pdf.addImage(answerData, 'PNG', 0, 0, 612, 792);
            }

            pdf.save('find_and_count_worksheet.pdf');
            showMessage('PDF downloaded!', 'success');
        }

        // Print worksheet
        function printWorksheet() {
            const printWindow = window.open('', '_blank');
            const worksheetData = worksheetCanvas.toDataURL('image/png');
            const answerData = answerCanvas.toDataURL('image/png');

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Find and Count Worksheet</title>
                        <style>
                            @media print {
                                .page-break { page-break-after: always; }
                            }
                            img { max-width: 100%; height: auto; }
                        </style>
                    </head>
                    <body>
                        <img src="${worksheetData}" />
                        ${document.querySelector('.canvas-container:nth-child(2)').style.display !== 'none' ?
                            `<div class="page-break"></div><img src="${answerData}" />` : ''}
                    </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // Show message toast
        function showMessage(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `message-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Initialize accordion
        function initializeAccordion() {
            document.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    content.classList.toggle('active');
                });
            });
        }

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Border and background loading functions - MUST be defined before init()
        // Make them global so they can be called from anywhere
        window.populateBorderThemes = async function populateBorderThemes() {
            console.log('populateBorderThemes called');
            console.log('currentLocale value:', currentLocale);
            console.log('typeof currentLocale:', typeof currentLocale);

            const borderThemeSelect = document.getElementById('borderThemeSelect');
            console.log('borderThemeSelect element:', borderThemeSelect);
            console.log('borderThemeSelect exists:', !!borderThemeSelect);

            if (!borderThemeSelect) {
                console.error('ERROR: borderThemeSelect element not found!');
                return;
            }

            try {
                // Clear and add None option
                borderThemeSelect.innerHTML = '';
                const noneOption = document.createElement('option');
                noneOption.value = 'none';
                noneOption.textContent = 'None';
                borderThemeSelect.appendChild(noneOption);

                const url = `/api/borders/themes?locale=${currentLocale}`;
                console.log('Fetching from URL:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Failed to load border themes');
                    return;
                }

                const themes = await response.json();
                console.log('Border themes received:', themes);

                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = typeof theme === 'object' ? theme.value : theme;
                    option.textContent = typeof theme === 'object' ? theme.displayName : theme;
                    borderThemeSelect.appendChild(option);
                    console.log('Added border option:', option.value, option.textContent);
                });

                console.log('Border themes loaded, select has', borderThemeSelect.options.length, 'options');
                console.log('Border select HTML:', borderThemeSelect.innerHTML);
            } catch (error) {
                console.error('Error loading border themes:', error);
                console.error('Stack:', error.stack);
            }
        }

        window.populateBackgroundThemes = async function populateBackgroundThemes() {
            console.log('populateBackgroundThemes called');
            const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');

            if (!backgroundThemeSelect) {
                console.error('ERROR: backgroundThemeSelect element not found!');
                return;
            }

            try {
                // Clear and add None option
                backgroundThemeSelect.innerHTML = '';
                const noneOption = document.createElement('option');
                noneOption.value = 'none';
                noneOption.textContent = 'None';
                backgroundThemeSelect.appendChild(noneOption);

                const response = await fetch(`/api/backgrounds/themes?locale=${currentLocale}`);
                if (!response.ok) {
                    console.error('Failed to load background themes');
                    return;
                }

                const themes = await response.json();
                console.log('Background themes received:', themes);

                themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = typeof theme === 'object' ? theme.value : theme;
                    option.textContent = typeof theme === 'object' ? theme.displayName : theme;
                    backgroundThemeSelect.appendChild(option);
                    console.log('Added background option:', option.value, option.textContent);
                });

                console.log('Background themes loaded, select has', backgroundThemeSelect.options.length, 'options');
                console.log('Background select HTML:', backgroundThemeSelect.innerHTML);
            } catch (error) {
                console.error('Error loading background themes:', error);
                console.error('Stack:', error.stack);
            }
        }

        // Load border images
        async function loadBorderImages() {
            const borderThemeSelect = document.getElementById('borderThemeSelect');
            const borderDictionary = document.getElementById('borderDictionary');
            const theme = borderThemeSelect.value;

            console.log('Loading border images for theme:', theme);

            if (theme === 'none') {
                borderDictionary.innerHTML = '<p class="dictionary-message">Select a theme to see borders.</p>';
                return;
            }

            borderDictionary.innerHTML = '<div class="dictionary-loading">Loading borders...</div>';

            try {
                const url = `/api/borders/images?theme=${theme}`;
                console.log('Fetching borders from:', url);
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('Border fetch failed:', response.status);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Border response data:', data);
                const borders = data.images || data;

                if (!borders || borders.length === 0) {
                    borderDictionary.innerHTML = '<p class="dictionary-message">No borders found for this theme.</p>';
                    return;
                }

                borderDictionary.innerHTML = '';
                borders.forEach(border => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `<img src="${border.url || border.path}" alt="${border.name}" />`;
                    item.onclick = () => {
                        addBorderToCanvas(border.url || border.path);
                        document.querySelectorAll('#borderDictionary .image-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    };
                    borderDictionary.appendChild(item);
                });

                console.log('Border images loaded successfully:', borders.length);
            } catch (error) {
                console.error('Error loading border images:', error);
                borderDictionary.innerHTML = '<p class="dictionary-message">Error loading borders.</p>';
            }
        }

        // Load background images
        async function loadBackgroundImages() {
            const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');
            const backgroundDictionary = document.getElementById('backgroundDictionary');
            const theme = backgroundThemeSelect.value;

            console.log('Loading background images for theme:', theme);

            if (theme === 'none') {
                backgroundDictionary.innerHTML = '<p class="dictionary-message">Select a theme for backgrounds.</p>';
                return;
            }

            backgroundDictionary.innerHTML = '<div class="dictionary-loading">Loading backgrounds...</div>';

            try {
                const url = `/api/backgrounds/images?theme=${theme}`;
                console.log('Fetching backgrounds from:', url);
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('Background fetch failed:', response.status);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Background response data:', data);
                const backgrounds = data.images || data;

                if (!backgrounds || backgrounds.length === 0) {
                    backgroundDictionary.innerHTML = '<p class="dictionary-message">No backgrounds found for this theme.</p>';
                    return;
                }

                backgroundDictionary.innerHTML = '';
                backgrounds.forEach(bg => {
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    item.innerHTML = `<img src="${bg.url || bg.path}" alt="${bg.name}" />`;
                    item.onclick = () => {
                        addBackgroundToCanvas(bg.url || bg.path);
                        document.querySelectorAll('#backgroundDictionary .image-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    };
                    backgroundDictionary.appendChild(item);
                });

                console.log('Background images loaded successfully:', backgrounds.length);
            } catch (error) {
                console.error('Error loading background images:', error);
                backgroundDictionary.innerHTML = '<p class="dictionary-message">Error loading backgrounds.</p>';
            }
        }

        // Initialize app
        async function init() {
            console.log('init() function called');
            initializeCanvases();
            initializeAccordion();

            // Load themes sequentially to ensure proper initialization
            console.log('Loading main themes...');
            try {
                await loadThemes();
            } catch (error) {
                console.error('Error loading main themes:', error);
            }

            // Load border and background themes IMMEDIATELY
            console.log('Loading border/background themes immediately...');
            console.log('typeof populateBorderThemes:', typeof populateBorderThemes);
            console.log('typeof populateBackgroundThemes:', typeof populateBackgroundThemes);

            // Call populate functions without await, like subtraction-v2.html does
            try {
                console.log('About to call populateBorderThemes...');
                populateBorderThemes().then(() => {
                    console.log('populateBorderThemes completed');
                    const select = document.getElementById('borderThemeSelect');
                    console.log('After populate, border select has', select ? select.options.length : 0, 'options');
                }).catch(error => {
                    console.error('ERROR in populateBorderThemes:', error);
                    console.error('Stack:', error.stack);
                });
            } catch (error) {
                console.error('SYNC ERROR calling populateBorderThemes:', error);
            }

            try {
                console.log('About to call populateBackgroundThemes...');
                populateBackgroundThemes().then(() => {
                    console.log('populateBackgroundThemes completed');
                    const select = document.getElementById('backgroundThemeSelect');
                    console.log('After populate, background select has', select ? select.options.length : 0, 'options');
                }).catch(error => {
                    console.error('ERROR in populateBackgroundThemes:', error);
                    console.error('Stack:', error.stack);
                });
            } catch (error) {
                console.error('SYNC ERROR calling populateBackgroundThemes:', error);
            }

            console.log('Border/background themes loading attempted');

            // Set up event listeners
            document.getElementById('themeSelect').addEventListener('change', loadImages);
            document.getElementById('searchInput').addEventListener('input', debounce(loadImages, 300));
            document.getElementById('borderThemeSelect').addEventListener('change', loadBorderImages);
            document.getElementById('backgroundThemeSelect').addEventListener('change', loadBackgroundImages);
            document.getElementById('generateBtn').addEventListener('click', generateWorksheet);
            document.getElementById('clearBtn').addEventListener('click', clearWorksheet);
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
            document.getElementById('printBtn').addEventListener('click', printWorksheet);

            // Apply translations if available
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }

            console.log('===== INIT COMPLETED SUCCESSFULLY =====');
            console.log('Border select final options:', document.getElementById('borderThemeSelect').options.length);
            console.log('Background select final options:', document.getElementById('backgroundThemeSelect').options.length);

            // Set a timer to check if selects get cleared later
            setTimeout(() => {
                console.log('===== 1 SECOND LATER CHECK =====');
                console.log('Border select options now:', document.getElementById('borderThemeSelect').options.length);
                console.log('Background select options now:', document.getElementById('backgroundThemeSelect').options.length);

                // If they're empty, try to repopulate
                if (document.getElementById('borderThemeSelect').options.length <= 1) {
                    console.log('Border select was cleared! Repopulating...');
                    populateBorderThemes();
                }
                if (document.getElementById('backgroundThemeSelect').options.length <= 1) {
                    console.log('Background select was cleared! Repopulating...');
                    populateBackgroundThemes();
                }
            }, 1000);
        }

        // Wait for DOM to be REALLY ready, then start
        setTimeout(function() {
            console.log('Starting after delay to ensure DOM is ready');
            console.log('DOMContentLoaded fired');

            // Define currentLocale HERE, inside DOMContentLoaded
            const currentLocale = typeof getCurrentLocale !== 'undefined' ? getCurrentLocale() : 'en';
            console.log('currentLocale inside DOMContentLoaded:', currentLocale);

            // Get DOM elements FIRST, just like subtraction-v2.html
            const borderThemeSelect = document.getElementById('borderThemeSelect');
            const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');
            const borderDictionary = document.getElementById('borderDictionary');
            const backgroundDictionary = document.getElementById('backgroundDictionary');

            console.log('Elements found:', {
                borderThemeSelect: !!borderThemeSelect,
                backgroundThemeSelect: !!backgroundThemeSelect,
                borderDictionary: !!borderDictionary,
                backgroundDictionary: !!backgroundDictionary
            });

            // Load border themes IMMEDIATELY, just like subtraction-v2.html
            async function loadBorderThemes() {
                console.log('loadBorderThemes called');
                if (!borderThemeSelect) return;

                try {
                    borderThemeSelect.innerHTML = '<option value="none">None</option>';
                    const response = await fetch(`/api/borders/themes?locale=${currentLocale}`);
                    const themes = await response.json();

                    themes.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme.value || theme;
                        option.textContent = theme.displayName || theme;
                        borderThemeSelect.appendChild(option);
                    });

                    console.log('Border themes loaded:', borderThemeSelect.options.length);
                } catch (error) {
                    console.error('Error loading border themes:', error);
                }
            }

            // Load background themes IMMEDIATELY, just like subtraction-v2.html
            async function loadBackgroundThemes() {
                console.log('loadBackgroundThemes called');
                if (!backgroundThemeSelect) return;

                try {
                    backgroundThemeSelect.innerHTML = '<option value="none">None</option>';
                    const response = await fetch(`/api/backgrounds/themes?locale=${currentLocale}`);
                    const themes = await response.json();

                    themes.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme.value || theme;
                        option.textContent = theme.displayName || theme;
                        backgroundThemeSelect.appendChild(option);
                    });

                    console.log('Background themes loaded:', backgroundThemeSelect.options.length);
                } catch (error) {
                    console.error('Error loading background themes:', error);
                }
            }

            // Call them IMMEDIATELY, just like subtraction-v2.html
            loadBorderThemes();
            loadBackgroundThemes();

            // Add event listeners for reload buttons
            const reloadBordersBtn = document.getElementById('reloadBordersBtn');
            const reloadBackgroundsBtn = document.getElementById('reloadBackgroundsBtn');

            if (reloadBordersBtn) {
                reloadBordersBtn.addEventListener('click', loadBorderThemes);
            }
            if (reloadBackgroundsBtn) {
                reloadBackgroundsBtn.addEventListener('click', loadBackgroundThemes);
            }

            // Then call init for the rest
            try {
                init();
            } catch (error) {
                console.error('CRITICAL ERROR in init:', error);
                console.error('Stack trace:', error.stack);
            }
        }, 100); // 100ms delay to ensure DOM is ready
    </script>
</body>
</html>
