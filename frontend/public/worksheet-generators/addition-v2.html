<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Addition Worksheet Generator</title>
  <script src="js/translations.js"></script>
  <script src="js/worksheet-base.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&family=Fredoka:wght@400;500;600&family=Lexend+Deca&family=Nunito:wght@400;700&family=Quicksand:wght@300..700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    :root {
        /* New Theme Colors */
        --app-font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --app-bg-dark: #2c2c2e;
        --app-surface-dark: #3a3a3e;
        --app-border-dark: #4a4a4a;
        --app-text-primary-dark-theme: #e0e0e0;
        --app-text-secondary-dark-theme: #a0a0a0;
        --app-bg-light: #f0f2f5;
        --app-surface-light: #ffffff;
        --app-border-light: #dce1e6;
        --app-text-primary-light-theme: #1c1c1e;
        --app-text-secondary-light-theme: #545458;
        --app-accent-primary: #007aff;
        --app-accent-primary-hover: #005ecb;
        --app-accent-secondary: #5856d6;
        --app-accent-danger: #ff3b30;
        --app-accent-danger-hover: #d92c23;
        --sidebar-width: 340px;
    }

    /* Global Reset & Layout */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--app-font-stack);
      display: flex;
      margin: 0;
      height: 100vh;
      background-color: var(--app-bg-light);
      overflow: hidden;
      color: var(--app-text-primary-light-theme);
      position: relative;
    }
    .layout {
        display: flex;
        flex: 1;
        overflow: hidden;
        height: 100vh;
        position: relative;
    }

    /* Sidebar Panel */
    .panel {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background-color: var(--app-bg-dark);
      color: var(--app-text-primary-dark-theme);
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      overflow-y: hidden;
      z-index: 10;
      padding: 0;
      transition: transform 0.3s ease-in-out;
    }

    .panel-header {
        padding: 20px 25px;
        text-align: left;
        border-bottom: 1px solid var(--app-border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-header h2 {
        font-size: 22px;
        font-weight: 600;
        color: var(--app-text-primary-dark-theme);
        margin: 0;
    }

    .panel-content {
        overflow-y: auto;
        flex-grow: 1;
        padding: 10px 15px;
    }

    /* Accordion Styles */
    .accordion-item {
        background-color: transparent;
        border: none;
        border-bottom: 1px solid var(--app-border-dark);
        margin-bottom: 0;
        border-radius: 0;
        overflow: hidden;
    }
    .accordion-item:last-child {
        border-bottom: none;
    }
    .accordion-button {
        background-color: transparent;
        color: var(--app-text-primary-dark-theme);
        width: 100%;
        border: none;
        text-align: left;
        padding: 18px 10px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.15s ease;
    }
    .accordion-button:hover {
        color: var(--app-text-primary-dark-theme);
        background-color: rgba(255,255,255,0.05);
    }
    .accordion-button::after {
        content: '\f078';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        font-size: 12px;
        transition: transform 0.2s ease-in-out;
    }
    .accordion-button.active::after {
        transform: rotate(-180deg);
    }
    .accordion-content {
        padding: 10px 10px 20px 10px;
        display: none;
        background-color: transparent;
        border-top: none;
    }
    .accordion-content.active {
        display: block;
    }

    /* Form Elements */
    .accordion-content label {
        display: block;
        font-size: 13px;
        font-weight: 400;
        color: var(--app-text-secondary-dark-theme);
        margin-bottom: 6px;
    }
    .accordion-content input[type="text"],
    .accordion-content input[type="number"],
    .accordion-content textarea,
    .accordion-content select {
        width: 100%;
        padding: 8px 10px;
        font-size: 13px;
        border-radius: 5px;
        border: 1px solid var(--app-border-dark);
        background-color: var(--app-surface-dark);
        color: var(--app-text-primary-dark-theme);
        box-sizing: border-box;
        margin-bottom: 12px;
    }

    /* Main Content Area */
    .content {
      flex-grow: 1;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-y: auto;
      background-color: var(--app-bg-light);
    }

    /* Canvas Container */
    .canvas-container {
      width: 100%;
      max-width: 850px;
      margin: 0 auto 30px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border-radius: 10px;
      background-color: var(--app-surface-light);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas {
      border: 1px solid var(--app-border-light);
      background: white;
      margin: 0 auto;
      display: block;
    }

    /* Dictionary/Image Library Styles */
    .dictionary {
      background: white;
      border: 1px solid var(--app-border-light);
      border-radius: 8px;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .dictionary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .dictionary-item:hover {
      background-color: rgba(0, 122, 255, 0.05);
      border-color: var(--app-accent-primary);
      transform: translateY(-2px);
    }

    .dictionary-item img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 5px;
    }

    .dictionary-item span {
      font-size: 11px;
      text-align: center;
      color: var(--app-text-secondary-light-theme);
      word-break: break-word;
      line-height: 1.2;
    }

    /* Loading State */
    .dictionary-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: var(--app-text-secondary-light-theme);
    }

    .dictionary-message {
      text-align: center;
      color: var(--app-text-secondary-light-theme);
      padding: 40px;
      font-size: 14px;
    }

    /* Buttons */
    button {
      background-color: var(--app-accent-primary);
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      margin: 5px;
    }

    button:hover {
      background-color: var(--app-accent-primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .danger-button {
      background-color: var(--app-accent-danger);
    }

    .danger-button:hover {
      background-color: var(--app-accent-danger-hover);
    }

    /* Action Buttons Container */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* Message Toast */
    .message-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .message-toast.success {
      background-color: #10b981;
    }

    .message-toast.error {
      background-color: var(--app-accent-danger);
    }

    .message-toast.info {
      background-color: var(--app-accent-primary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .panel {
        position: absolute;
        transform: translateX(-100%);
      }
      .panel.mobile-open {
        transform: translateX(0);
      }
      .content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel">
      <div class="panel-header">
        <h2 data-translate="addition_worksheet_generator">Addition Worksheet</h2>
      </div>
      <div class="panel-content">
        <!-- Problem Settings -->
        <div class="accordion-item">
          <button class="accordion-button active" data-translate="problem_settings">Problem Settings</button>
          <div class="accordion-content active">
            <label data-translate="number_of_problems">Number of Problems:</label>
            <input type="number" id="problemCount" value="10" min="1" max="30" />

            <label data-translate="max_sum">Maximum Sum:</label>
            <input type="number" id="maxSum" value="10" min="2" max="100" />

            <label data-translate="columns">Columns:</label>
            <input type="number" id="columnCount" value="2" min="1" max="5" />
          </div>
        </div>

        <!-- Image Library -->
        <div class="accordion-item">
          <button class="accordion-button active" data-translate="image_library">Image Library</button>
          <div class="accordion-content active">
            <label data-translate="select_theme">Select Theme:</label>
            <select id="themeSelect">
              <option value="all" data-translate="all_themes">All Themes</option>
            </select>

            <label data-translate="search_images">Search Images:</label>
            <input type="text" id="searchInput" placeholder="Search..." />

            <div id="imageDictionary" class="dictionary">
              <div class="dictionary-loading">Loading images...</div>
            </div>
          </div>
        </div>

        <!-- Design Options -->
        <div class="accordion-item">
          <button class="accordion-button" data-translate="design_options">Design Options</button>
          <div class="accordion-content">
            <label data-translate="font_family">Font Family:</label>
            <select id="fontFamily">
              <option value="Fredoka">Fredoka</option>
              <option value="Baloo 2">Baloo 2</option>
              <option value="Quicksand">Quicksand</option>
              <option value="Nunito">Nunito</option>
            </select>

            <label data-translate="font_size">Font Size:</label>
            <input type="number" id="fontSize" value="24" min="12" max="48" />

            <label data-translate="show_equation_lines">Show Equation Lines:</label>
            <input type="checkbox" id="showLines" checked />
          </div>
        </div>

        <!-- Actions -->
        <div class="accordion-item">
          <button class="accordion-button" data-translate="actions">Actions</button>
          <div class="accordion-content">
            <button id="generateBtn" data-translate="generate_worksheet">Generate Worksheet</button>
            <button id="clearBtn" class="danger-button" data-translate="clear_worksheet">Clear Worksheet</button>
            <button id="downloadPdfBtn" data-translate="download_pdf">Download PDF</button>
            <button id="printBtn" data-translate="print">Print</button>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <h1 data-translate="addition_worksheet_title">Addition Worksheet</h1>

      <div class="canvas-container">
        <canvas id="worksheetCanvas"></canvas>
      </div>

      <div class="canvas-container" style="display: none;">
        <h2 data-translate="answer_key">Answer Key</h2>
        <canvas id="answerCanvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Initialize WorksheetBase
    const worksheetApp = new WorksheetBase({
      apiVersion: 'v2',
      enableCaching: true,
      cacheTTL: 5 * 60 * 1000,
      enableLazyLoad: true,
      defaultTheme: 'animals'
    });

    // App-specific variables
    let currentLocale = typeof getCurrentLocale !== 'undefined' ? getCurrentLocale() : 'en';
    let worksheetCanvas, answerCanvas;
    let selectedImages = [];
    let generatedProblems = [];

    // Initialize canvases
    function initializeCanvases() {
      worksheetCanvas = new fabric.Canvas('worksheetCanvas', {
        width: 816,
        height: 1056,
        backgroundColor: 'white'
      });

      answerCanvas = new fabric.Canvas('answerCanvas', {
        width: 816,
        height: 1056,
        backgroundColor: 'white'
      });
    }

    // Load themes into dropdown
    async function loadThemes() {
      const themeSelect = document.getElementById('themeSelect');
      const themes = await worksheetApp.getThemes();

      // Keep "All Themes" option
      themeSelect.innerHTML = '<option value="all" data-translate="all_themes">All Themes</option>';

      themes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme.folder_name;
        option.textContent = theme.translations[currentLocale] || theme.folder_name;
        themeSelect.appendChild(option);
      });

      // Load initial images
      loadImages();
    }

    // Load images using WorksheetBase
    async function loadImages() {
      const theme = document.getElementById('themeSelect').value;
      const search = document.getElementById('searchInput').value.trim();
      const dictionary = document.getElementById('imageDictionary');

      // Show loading state
      dictionary.innerHTML = '<div class="dictionary-loading">Loading images...</div>';

      try {
        let images;

        if (search) {
          // Search across all themes
          images = await worksheetApp.searchImages(search);
        } else if (theme === 'all') {
          // Load default theme when "All" is selected
          images = await worksheetApp.getImagesByTheme('animals');
        } else {
          // Load specific theme
          images = await worksheetApp.getImagesByTheme(theme);
        }

        if (!images || images.length === 0) {
          dictionary.innerHTML = '<div class="dictionary-message">No images found</div>';
          return;
        }

        // Clear dictionary
        dictionary.innerHTML = '';

        // Render images
        images.forEach(image => {
          const item = document.createElement('div');
          item.className = 'dictionary-item';
          item.dataset.imageId = image.id;
          item.dataset.imagePath = image.path;
          item.dataset.imageName = image.name;

          const img = document.createElement('img');
          img.src = image.thumbnail || image.path;
          img.alt = image.name;
          img.loading = 'lazy';

          const label = document.createElement('span');
          label.textContent = image.name;

          item.appendChild(img);
          item.appendChild(label);

          item.addEventListener('click', () => selectImage(image));

          dictionary.appendChild(item);
        });

        // Set up lazy loading
        worksheetApp.setupLazyLoading(dictionary);

      } catch (error) {
        console.error('Failed to load images:', error);
        dictionary.innerHTML = '<div class="dictionary-message">Failed to load images. Please try again.</div>';
      }
    }

    // Select image for worksheet
    function selectImage(image) {
      if (selectedImages.length >= 2) {
        showMessage('Maximum 2 different images allowed', 'error');
        return;
      }

      if (!selectedImages.find(img => img.id === image.id)) {
        selectedImages.push(image);
        showMessage(`Selected: ${image.name}`, 'success');

        // Highlight selected items
        document.querySelectorAll('.dictionary-item').forEach(item => {
          if (selectedImages.find(img => img.id === item.dataset.imageId)) {
            item.style.backgroundColor = 'rgba(0, 122, 255, 0.1)';
            item.style.borderColor = 'var(--app-accent-primary)';
          }
        });
      }
    }

    // Generate worksheet
    async function generateWorksheet() {
      const problemCount = parseInt(document.getElementById('problemCount').value);
      const maxSum = parseInt(document.getElementById('maxSum').value);
      const columns = parseInt(document.getElementById('columnCount').value);
      const fontFamily = document.getElementById('fontFamily').value;
      const fontSize = parseInt(document.getElementById('fontSize').value);
      const showLines = document.getElementById('showLines').checked;

      if (selectedImages.length === 0) {
        showMessage('Please select at least one image', 'error');
        return;
      }

      // Clear canvases
      worksheetCanvas.clear();
      answerCanvas.clear();
      worksheetCanvas.backgroundColor = 'white';
      answerCanvas.backgroundColor = 'white';

      // Generate problems
      generatedProblems = [];
      for (let i = 0; i < problemCount; i++) {
        const sum = Math.floor(Math.random() * (maxSum - 1)) + 2;
        const addend1 = Math.floor(Math.random() * sum) + 1;
        const addend2 = sum - addend1;
        generatedProblems.push({ addend1, addend2, sum });
      }

      // Layout problems on canvas
      const rowHeight = 150;
      const colWidth = worksheetCanvas.width / columns;
      const imageSize = 40;
      const spacing = 10;

      generatedProblems.forEach((problem, index) => {
        const col = index % columns;
        const row = Math.floor(index / columns);
        const x = col * colWidth + colWidth / 2;
        const y = row * rowHeight + 80;

        // Draw problem on worksheet
        drawProblem(worksheetCanvas, problem, x, y, imageSize, fontFamily, fontSize, showLines, false);

        // Draw problem with answer on answer key
        drawProblem(answerCanvas, problem, x, y, imageSize, fontFamily, fontSize, showLines, true);
      });

      // Show answer key
      document.querySelector('.canvas-container:nth-child(2)').style.display = 'block';

      showMessage('Worksheet generated!', 'success');
    }

    // Draw a single problem
    async function drawProblem(canvas, problem, x, y, imageSize, fontFamily, fontSize, showLines, showAnswer) {
      const { addend1, addend2, sum } = problem;

      // Draw first addend images
      for (let i = 0; i < addend1; i++) {
        const imgX = x - (addend1 * (imageSize + spacing)) / 2 + i * (imageSize + spacing);
        const imgY = y - imageSize - 20;

        const image = selectedImages[0];
        fabric.Image.fromURL(image.path, function(img) {
          img.set({
            left: imgX,
            top: imgY,
            width: imageSize,
            height: imageSize,
            selectable: false
          });
          canvas.add(img);
        });
      }

      // Draw plus sign
      const plusText = new fabric.Text('+', {
        left: x,
        top: y,
        fontSize: fontSize,
        fontFamily: fontFamily,
        fill: '#333',
        originX: 'center',
        originY: 'center',
        selectable: false
      });
      canvas.add(plusText);

      // Draw second addend images
      const secondImage = selectedImages[1] || selectedImages[0];
      for (let i = 0; i < addend2; i++) {
        const imgX = x - (addend2 * (imageSize + spacing)) / 2 + i * (imageSize + spacing);
        const imgY = y + 20;

        fabric.Image.fromURL(secondImage.path, function(img) {
          img.set({
            left: imgX,
            top: imgY,
            width: imageSize,
            height: imageSize,
            selectable: false
          });
          canvas.add(img);
        });
      }

      // Draw equals line
      if (showLines) {
        const line = new fabric.Line([x - 60, y + imageSize + 30, x + 60, y + imageSize + 30], {
          stroke: '#333',
          strokeWidth: 2,
          selectable: false
        });
        canvas.add(line);
      }

      // Draw equals sign
      const equalsText = new fabric.Text('=', {
        left: x - 80,
        top: y + imageSize + 45,
        fontSize: fontSize,
        fontFamily: fontFamily,
        fill: '#333',
        originX: 'center',
        originY: 'center',
        selectable: false
      });
      canvas.add(equalsText);

      // Draw answer or blank
      if (showAnswer) {
        const answerText = new fabric.Text(sum.toString(), {
          left: x,
          top: y + imageSize + 45,
          fontSize: fontSize,
          fontFamily: fontFamily,
          fill: '#d00',
          fontWeight: 'bold',
          originX: 'center',
          originY: 'center',
          selectable: false
        });
        canvas.add(answerText);
      } else {
        // Draw blank box
        const box = new fabric.Rect({
          left: x - 30,
          top: y + imageSize + 30,
          width: 60,
          height: 30,
          fill: 'transparent',
          stroke: '#999',
          strokeWidth: 1,
          strokeDashArray: [5, 5],
          originX: 'center',
          originY: 'center',
          selectable: false
        });
        canvas.add(box);
      }
    }

    // Clear worksheet
    function clearWorksheet() {
      worksheetCanvas.clear();
      answerCanvas.clear();
      worksheetCanvas.backgroundColor = 'white';
      answerCanvas.backgroundColor = 'white';
      selectedImages = [];
      generatedProblems = [];

      // Clear selection highlights
      document.querySelectorAll('.dictionary-item').forEach(item => {
        item.style.backgroundColor = '';
        item.style.borderColor = 'transparent';
      });

      // Hide answer key
      document.querySelector('.canvas-container:nth-child(2)').style.display = 'none';

      showMessage('Worksheet cleared', 'info');
    }

    // Download as PDF
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'letter');

      // Add worksheet page
      const worksheetData = worksheetCanvas.toDataURL('image/png');
      pdf.addImage(worksheetData, 'PNG', 0, 0, 612, 792);

      // Add answer key page if visible
      if (document.querySelector('.canvas-container:nth-child(2)').style.display !== 'none') {
        pdf.addPage();
        const answerData = answerCanvas.toDataURL('image/png');
        pdf.addImage(answerData, 'PNG', 0, 0, 612, 792);
      }

      pdf.save('addition_worksheet.pdf');
      showMessage('PDF downloaded!', 'success');
    }

    // Print worksheet
    function printWorksheet() {
      const printWindow = window.open('', '_blank');
      const worksheetData = worksheetCanvas.toDataURL('image/png');
      const answerData = answerCanvas.toDataURL('image/png');

      printWindow.document.write(`
        <html>
          <head>
            <title>Addition Worksheet</title>
            <style>
              @media print {
                .page-break { page-break-after: always; }
              }
              img { max-width: 100%; height: auto; }
            </style>
          </head>
          <body>
            <img src="${worksheetData}" />
            ${document.querySelector('.canvas-container:nth-child(2)').style.display !== 'none' ?
              `<div class="page-break"></div><img src="${answerData}" />` : ''}
          </body>
        </html>
      `);

      printWindow.document.close();
      printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
      };
    }

    // Show message toast
    function showMessage(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `message-toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Initialize accordion
    function initializeAccordion() {
      document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.classList.toggle('active');
        });
      });
    }

    // Initialize app
    async function init() {
      initializeCanvases();
      initializeAccordion();

      // Load themes and initial images
      await loadThemes();

      // Set up event listeners
      document.getElementById('themeSelect').addEventListener('change', loadImages);
      document.getElementById('searchInput').addEventListener('input', debounce(loadImages, 300));
      document.getElementById('generateBtn').addEventListener('click', generateWorksheet);
      document.getElementById('clearBtn').addEventListener('click', clearWorksheet);
      document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
      document.getElementById('printBtn').addEventListener('click', printWorksheet);

      // Apply translations if available
      if (typeof applyTranslations === 'function') {
        applyTranslations();
      }
    }

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Start app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>