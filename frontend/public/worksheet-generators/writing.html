<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page.title">Writing Worksheet Generator</title>
    <script src="js/translations-writing.js"></script>
    <script src="js/bulletproof-loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&family=Fredoka:wght@400;500;600&family=Lexend+Deca&family=Nunito:wght@400;700&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" xintegrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      :root {
          --app-font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
          --app-bg-dark: #2c2c2e;
          --app-surface-dark: #3a3a3e;
          --app-border-dark: #4a4a4a;
          --app-text-primary-dark-theme: #e0e0e0;
          --app-text-secondary-dark-theme: #a0a0a0;
          --app-bg-light: #f0f2f5;
          --app-surface-light: #ffffff;
          --app-border-light: #dce1e6;
          --app-text-primary-light-theme: #1c1c1e;
          --app-text-secondary-light-theme: #545458;
          --app-accent-primary: #007aff;
          --app-accent-primary-hover: #005ecb;
          --app-accent-danger: #ff3b30;
          --sidebar-width: 340px;
      }
      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body {
          font-family: 'Quicksand', sans-serif;
          height: 100%;
          overflow: hidden;
      }
      body {
        background-color: var(--app-bg-light);
        color: var(--app-text-primary-light-theme);
        display: flex;
        min-height: 100vh;
      }

      .layout { display: flex; flex: 1; overflow: hidden; height: 100vh; }
      .panel {
        width: var(--sidebar-width);
        min-width: var(--sidebar-width);
        background-color: var(--app-bg-dark);
        color: var(--app-text-primary-dark-theme);
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        padding: 0;
        transition: transform 0.3s ease-in-out;
      }
      .panel-header {
        padding: 20px 25px;
        text-align: left;
        border-bottom: 1px solid var(--app-border-dark);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .panel-header h2 { font-size: 22px; font-weight: 600; font-family: 'Fredoka', sans-serif; color: var(--app-text-primary-dark-theme); margin: 0; }
      .panel-content { overflow-y: auto; flex-grow: 1; padding: 15px; }
      .accordion-item {
        background-color: transparent; border: none;
        border-bottom: 1px solid var(--app-border-dark);
        margin-bottom: 0; border-radius: 0; overflow: hidden;
      }
      .accordion-item:last-child { border-bottom: none; }
      .accordion-button {
        background-color: transparent; color: var(--app-text-primary-dark-theme);
        width: 100%; border: none; text-align: left;
        padding: 18px 10px; font-size: 15px; font-weight: 500;
        cursor: pointer; display: flex; justify-content: space-between;
        align-items: center; transition: background-color: 0.15s ease;
      }
      .accordion-button:hover { background-color: rgba(255,255,255,0.05); }
      .accordion-button::after {
        content: '\f078'; font-family: 'Font Awesome 5 Free';
        font-weight: 900; font-size: 12px; transition: transform 0.2s ease-in-out;
      }
      .accordion-button.active::after { transform: rotate(-180deg); }
      .accordion-content { padding: 10px 10px 20px 10px; display: none; background-color: transparent; flex-direction: column; gap: 10px;}
      .accordion-content.active { display: flex; }
      .accordion-content label {
        display: block; font-size: 13px; font-weight: 400;
        color: var(--app-text-secondary-dark-theme); margin-bottom: 6px;
      }
      .accordion-content h4 {
        font-size: 13px; color: var(--app-text-secondary-dark-theme); margin-top: 15px;
        margin-bottom: 8px; border-bottom: 1px solid var(--app-border-dark);
        padding-bottom: 6px; font-weight: 500;
      }
      .accordion-content input,
      .accordion-content textarea,
      .accordion-content select {
        width: 100%; padding: 8px 10px; font-size: 13px;
        border-radius: 5px; border: 1px solid var(--app-border-dark);
        background-color: var(--app-surface-dark); color: var(--app-text-primary-dark-theme);
        box-sizing: border-box;
      }
      .accordion-content input[type="color"] { padding: 2px; height: 38px; }
      .accordion-content input[type="range"] { padding: 0; }
      .accordion-content input[type="file"] {
        color: var(--app-text-secondary-dark-theme);
        background-color: var(--app-surface-dark);
        border: 1px solid var(--app-border-dark);
        border-radius: 5px;
        padding: 8px;
        font-size: 13px;
      }
      .accordion-content input[type="file"]::file-selector-button {
        margin-right: 10px; border: 1px solid var(--app-border-dark);
        background: var(--app-bg-dark); padding: 4px 8px;
        border-radius: 3px; color: var(--app-text-primary-dark-theme); cursor: pointer;
      }

       .accordion-content .radio-group label { color: var(--app-text-secondary-dark-theme); }
       .accordion-content .radio-group input { width: auto; }

      .accordion-content button {
        background-color: var(--app-surface-dark); color: var(--app-text-primary-dark-theme);
        border: 1px solid var(--app-border-dark); font-weight: 500;
        width: 100%; padding: 8px 12px; font-size: 13px;
        border-radius: 5px; margin-top: 10px;
      }
      .panel-footer {
        padding: 15px 25px; border-top: 1px solid var(--app-border-dark);
        margin-top: auto; background-color: var(--app-bg-dark);
      }
      #message {
        padding: 10px 15px; border-radius: 5px; font-size: 13px; text-align: center;
        min-height: 20px; font-weight: 500; display: none; margin-bottom: 10px;
        border-width: 1px; border-style: solid;
      }
      #message.error { background-color:rgba(255, 59, 48, 0.2); color: var(--app-accent-danger); border-color: var(--app-accent-danger); }
      #message.success { background-color:rgba(52, 199, 89, 0.2); color: #34c759; border-color: #34c759; }
      #message.info { background-color:rgba(0, 122, 255, 0.15); color:var(--app-accent-primary); border-color: var(--app-accent-primary); }
      .main {
        flex-grow: 1; display: flex; flex-direction: column;
        position: relative; overflow: hidden; padding: 0;
      }
       .menu-toggle-btn {
        display: none; position: absolute;
        top: 12px; left: 20px; z-index: 20;
        background-color: var(--app-surface-light); color: var(--app-text-primary-light-theme);
        border: 1px solid var(--app-border-light); border-radius: 6px;
        width: 38px; height: 38px; font-size: 18px;
        cursor: pointer; align-items: center; justify-content: center;
    }
     .menu-toggle-btn:hover { background-color: #e8e8ed; }

    .menu-close-btn {
        display: none; background: none; border: none;
        color: var(--app-text-secondary-dark-theme); font-size: 28px;
        line-height: 1; cursor: pointer; padding: 0 5px;
    }
    .menu-close-btn:hover { color: var(--app-text-primary-dark-theme); }
    .menu-overlay {
        display: none; position: fixed; top: 0; left: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);
        z-index: 999;
    }
    .menu-overlay.is-active { display: block; }
      .top-right-actions {
        position: absolute; top: 12px; right: 20px; z-index: 20;
        display: flex; gap: 10px; align-items: center;
      }
      .top-right-actions .action-button {
        padding: 7px 14px; font-size: 13px; font-weight: 500;
        border-radius: 6px; border: none; color: white; cursor: pointer;
        transition: background-color: 0.2s ease, transform 0.1s ease;
        display: flex; align-items: center; gap: 6px;
      }
      .top-right-actions .action-button:active { transform: scale(0.98); }
      .top-right-actions .action-button.accent { background-color: var(--app-accent-primary); }
      .top-right-actions .action-button.accent:hover { background-color: var(--app-accent-primary-hover); }
      .top-right-actions .action-button.danger {
        background-color: var(--app-surface-light); color: var(--app-text-primary-light-theme);
        border: 1px solid var(--app-border-light);
      }
      .top-right-actions .action-button.danger:hover { background-color: #e8e8ed; }
      .top-right-actions .action-button.secondary {
        background-color: var(--app-surface-light); color: var(--app-text-primary-light-theme);
        border: 1px solid var(--app-border-light);
      }
      .top-right-actions .action-button.secondary:hover { background-color: #e8e8ed; }
      .top-right-actions .action-button:disabled {
        background-color: #cccccc !important; color: #888888 !important;
        border-color: #cccccc !important; cursor: not-allowed;
      }
      /* New Dropdown Styles */
      .dropdown-container { position: relative; display: inline-block; }
      .dropdown-content {
        display: none; position: absolute; right: 0; top: calc(100% + 5px);
        background-color: var(--app-surface-light); min-width: 200px;
        box-shadow: 0px 5px 15px rgba(0,0,0,0.15); border: 1px solid var(--app-border-light);
        border-radius: 6px; padding: 8px; z-index: 25;
      }
      .dropdown-content button {
        width: 100%; padding: 8px 12px; font-size: 13px; border-radius: 4px;
        box-sizing: border-box; margin-bottom: 6px; background-color: transparent;
        color: var(--app-text-primary-light-theme); border: none; cursor: pointer;
        text-align: left; font-weight: 400; transition: background-color: 0.15s ease;
      }
      .dropdown-content button:last-of-type { margin-bottom: 0; }
      .dropdown-content button:hover { background-color: rgba(0,0,0,0.05); }
      .dropdown-content .checkbox-label {
        display: flex; align-items: center; font-size: 13px; font-weight: 400;
        padding: 6px 12px; margin-top: 4px; margin-bottom: 0; cursor: pointer;
        color: var(--app-text-primary-light-theme); border-radius: 4px;
      }
      .dropdown-content .checkbox-label:hover { background-color: rgba(0,0,0,0.05); }
      .dropdown-content .checkbox-label input[type="checkbox"] {
        width: auto; margin-right: 8px; vertical-align: middle; accent-color: var(--app-accent-primary);
      }

      .tab-content-wrapper {
        flex-grow: 1; display: flex; align-items: flex-start; justify-content: center;
        padding: 25px; overflow-y: auto; margin-top: 50px;
      }
      .canvas-container-wrapper {
        border: 1px solid var(--app-border-light);
        background-color: var(--app-surface-light);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: visible;
        margin: auto;
        display: inline-block;
        /* Wrapper will size to fit the worksheet */
      }

      #worksheet {
        position: relative;
        background-color: white;
        transform-origin: top left;
        display: block;
        /* Width, height, and transform scale set dynamically by JavaScript */
      }

      #object-context-toolbar {
          position: absolute;
          top: 12px;
          left: 50%;
          transform: translateX(-50%);
          background-color: var(--app-surface-light);
          border-radius: 6px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.15);
          padding: 5px;
          display: none;
          gap: 4px;
          z-index: 100;
          align-items: center;
          border: 1px solid var(--app-border-light);
      }
      .toolbar-group {
          display: flex;
          gap: 2px;
          align-items: center;
          padding: 0 4px;
      }
      .toolbar-group + .toolbar-group {
          border-left: 1px solid var(--app-border-light);
      }
      .toolbar-item {
        position: relative;
      }
      .context-btn {
          background: none;
          border: 1px solid transparent;
          border-radius: 4px;
          padding: 5px 7px;
          cursor: pointer;
          font-size: 15px;
          color: var(--app-text-secondary-light-theme);
          line-height: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          min-width: 32px;
          transition: background-color: 0.2s, color 0.2s;
      }
      .context-btn:disabled {
          color: #c5c5c7;
          cursor: not-allowed;
      }
      .context-btn:not(:disabled):hover {
          background-color: #e8e8ed;
          color: var(--app-text-primary-light-theme);
      }
       .context-btn.active-dropdown {
          background-color: #ddeeff;
          color: var(--app-accent-primary);
      }
      #toolbarDeleteBtn:not(:disabled) {
          color: var(--app-accent-danger);
      }
      #object-context-toolbar .dropdown-content {
        display: none; position: absolute; top: calc(100% + 5px); left: 50%;
        transform: translateX(-50%); background-color: var(--app-surface-light);
        min-width: 150px; box-shadow: 0px 5px 15px rgba(0,0,0,0.15);
        border: 1px solid var(--app-border-light); border-radius: 6px;
        padding: 8px; z-index: 101;
      }
      #object-context-toolbar .dropdown-content button {
        width: 100%; padding: 8px 12px; font-size: 13px; border-radius: 4px;
        box-sizing: border-box; margin-bottom: 6px; background-color: transparent;
        color: var(--app-text-primary-light-theme); border: none; cursor: pointer;
        text-align: left; font-weight: 400; transition: background-color: 0.15s ease;
      }
      .dropdown-content button:last-of-type { margin-bottom: 0; }
      .dropdown-content button:hover { background-color: rgba(0,0,0,0.05); }


      #dictionary, #uploadedImagesPreview {
        border: 1px solid var(--app-border-dark); padding: 10px; max-height: 180px;
        overflow-y: auto; background-color: var(--app-surface-dark);
        border-radius: 5px; margin-top: 10px;
      }
      .dictionary-item {
        display: flex; align-items: center; gap: 8px;
        cursor: pointer; padding: 6px;
        border-bottom: 1px solid var(--app-border-dark);
        color: var(--app-text-secondary-dark-theme);
        border-radius: 3px; transition: background-color: 0.15s ease;
      }
      .dictionary-item:last-child { border-bottom: none; }
      .dictionary-item:hover {
        background-color: rgba(255,255,255,0.05);
        color: var(--app-text-primary-dark-theme);
      }
      .dictionary-item img {
        width: 35px; height: 35px; object-fit: contain;
        border: 1px solid var(--app-border-dark);
        background-color: var(--app-surface-light);
        border-radius: 3px;
      }
      .radio-group { display: flex; align-items: center; margin-bottom: 5px; }
      .radio-group label { margin-left: 5px; margin-right: 15px; margin-bottom: 0 !important; font-weight: normal !important; }
      .radio-group input[type="radio"] { width: auto; margin: 0; vertical-align: middle; }

       @media (max-width: 1024px) {
        .panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            transform: translateX(-100%);
        }
        .panel.is-open {
            transform: translateX(0);
        }
        .menu-toggle-btn {
            display: flex;
        }
        .menu-close-btn {
            display: block;
        }
    }

    /* NEW: Styles for Border and Background dictionaries */
    #borderDictionary, #backgroundDictionary {
        border: 1px solid var(--app-border-dark);
        padding: 8px;
        max-height: 140px;
        overflow-y: auto;
        background-color: var(--app-surface-dark);
        border-radius: 5px;
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-content: flex-start;
    }
    .border-thumbnail-item {
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 4px;
        padding: 2px;
        transition: border-color .15s ease;
        width: 60px;
        height: 60px;
    }
    .border-thumbnail-item:hover, .border-thumbnail-item.selected {
        border-color: var(--app-accent-primary);
    }
    .border-thumbnail-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: var(--app-surface-light);
        border-radius: 2px;
    }

    /******************************************
     * PRESERVED FUNCTIONAL CSS FOR WRITING APP
     ******************************************/
    .editable-block {
        position: absolute;
        border: 1px dashed transparent;
        transition: border-color: 0.2s;
        cursor: move; /* Make the whole block indicate movability */
    }
    .editable-block:hover { border-color: var(--app-accent-primary); }
    .editable-block.selected { border: 2px solid var(--app-accent-primary); z-index: 100; }
    .editable-block.locked { border: 2px solid var(--app-text-secondary-light-theme) !important; cursor: not-allowed !important; }
    .editable-block.locked > * { cursor: not-allowed !important; }
    .editable-block.custom-image-block, .editable-block.text-block-wrapper, .editable-block.background-block, .editable-block.border-block { overflow: hidden; }
    .editable-block.row-block { overflow: visible; }
    .editable-block .resize-handle {
        position: absolute; width: 12px; height: 12px;
        background: var(--app-accent-primary); border: 2px solid white; border-radius: 50%;
        display: none; z-index: 101;
    }
    .editable-block.selected .resize-handle { display: block; }
    .resize-handle-se { bottom: -6px; right: -6px; cursor: se-resize; }
    .editable-block > *:not(.resize-handle) { width: 100%; height: 100%; } /* Removed cursor:move from here */
    .text-block-wrapper { display: flex; align-items: center; justify-content: center; }
    .editable-text-box {
        width: 100%;
        height: 100%;
        padding: 8px;
        white-space: nowrap; /* Force single line */
        overflow: hidden; /* Hide overflow */
        text-overflow: ellipsis; /* Show ellipsis for long text */
        border: none;
        background: transparent;
        text-align: center;
        cursor: inherit; /* Inherit cursor from parent .editable-block */
        display: flex;
        align-items: center; /* Vertically center the text */
        justify-content: center; /* Horizontally center the text */
        line-height: 1.2;
    }
    .editable-text-box.selected, .editable-block.selected .editable-text-box { outline: none; }
    .editable-text-box:focus {
        outline: none;
        background-color: rgba(0, 122, 255, 0.07);
        box-shadow: inset 0 0 0 1px var(--app-accent-primary);
        cursor: text; /* Set cursor to text only when focused for editing */
    }
    .editable-block:has(.editable-text-box:focus) .resize-handle {
        display: none !important;
    }
    #worksheet img.preview { display: block; width: auto; object-fit: contain; }
    .row {
      position: relative;
      height: var(--row-height-px, 40.32px);
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      justify-content: flex-start;
      overflow: visible;
    }
    .row .guide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .row .guide .line-top,
    .row .guide .line-bottom { position: absolute; left: 0; width: 100%; height: 2px; background: #aaa; }
    .row .guide .line-bottom { bottom: 0; }
    .row .guide .line-middle { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; transform: translateY(-50%); border-top: 2px dashed #aaa; background: none; }
    .row.trace .letters, .row.fading-trace .letters, .row.guided-copy .letters { display: flex; justify-content: flex-start; align-items: center; height: 100%; gap: 0; padding-left: 8px; position: relative; z-index: 2; }
    .row.trace .letters img:not(.lowercase), .row.fading-trace .letters img:not(.lowercase), .row.guided-copy .letters img:not(.lowercase),
    .row.trace .letters canvas:not(.lowercase), .row.fading-trace .letters canvas:not(.lowercase), .row.guided-copy .letters canvas:not(.lowercase) {
        position: relative;
        top: 0;
        transform: translateY(0); /* Universal baseline alignment */
    }

    .row.trace .letters img, .row.fading-trace .letters img, .row.guided-copy .letters img,
    .row.trace .letters canvas, .row.fading-trace .letters canvas, .row.guided-copy .letters canvas {
      height: 85%; width: auto; object-fit: contain; display: inline-block; flex-shrink: 0;
    }

    /* Increase height by 5% for specific uppercase Print Arrow letters, expanding downward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"] {
        height: 93.7125% !important; /* 89.25% * 1.05 = another 5% increase */
        transform: translateY(4.35625%) !important; /* Shift down to keep top position fixed */
    }

    /* Move "A" down by 7% of its height */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"] {
        transform: translateY(10.916125%) !important; /* 4.35625% + 7% of height (6.559875%) */
    }

    /* Move "S" down by 7% of its height */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"] {
        transform: translateY(10.916125%) !important; /* 4.35625% + 7% of height (6.559875%) */
    }

    /* Increase "V" height by 8% (95.4975% * 1.08 = 103.1373%), expanding downward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="V"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="V"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="V"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="V"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="V"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="V"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="V"] {
        height: 103.1373% !important; /* 95.4975% * 1.08 */
        transform: translateY(-0.954975%) !important; /* -4.774875% + 3.8199% (expanding downward) */
    }

    /* Increase "X" height by 5% (93.7125% * 1.05 = 98.398125%), expanding upward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="X"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="X"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="X"] {
        height: 98.398125% !important; /* 93.7125% * 1.05 */
        transform: translateY(-0.563656%) !important; /* 4.35625% - 4.919906% (expanding upward) */
    }

    /* Increase "C" height by 8% (98.398125% * 1.08 = 106.269975%), expanding downward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"] {
        height: 106.269975% !important; /* 98.398125% * 1.08 */
        transform: translateY(3.372269%) !important; /* -0.563656% + 3.935925% (expanding downward) */
    }

    /* Increase "I" height by 10% (133.8353929% * 1.10 = 147.21893219%), expanding downward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"] {
        height: 147.21893219% !important; /* 133.8353929% * 1.10 */
        transform: translateY(4.566575%) !important; /* Keeping top position fixed while expanding downward */
    }

    /* Increase "L" height by 5% (85% * 1.05 = 89.25%), expanding downward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"] {
        height: 89.25% !important; /* 85% * 1.05 */
        transform: translateY(4.4625%) !important; /* Expanding downward */
    }

    /* Increase "W" height by 7% (89.25% * 1.07 = 95.4975%), expanding upward */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="W"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="W"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="W"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="W"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="W"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="W"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="W"] {
        height: 95.4975% !important; /* 89.25% * 1.07 */
        transform: translateY(-1.9975%) !important; /* 4.25% - 6.2475% (moving up) */
    }

    /* Move "Y" up by 7% of its height */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Y"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Y"],
    .row.guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Y"] {
        height: 98.398125% !important; /* 93.7125% * 1.05 */
        transform: translateY(2.154006%) !important; /* 9.041875% - 6.887869% (moving up by 7%) */
    }

    /* Filter for tracing images is now handled conditionally in JS createLetterImg */


    /* New styling for text-based cursive fonts to adjust baseline and size */
    .row .letters.cursive-font {
        font-size: calc(var(--row-height-px, 40.32px) * 1.279202);
        line-height: 1;
        white-space: nowrap;
        color: #333; /* Default text color */
        align-items: flex-end; /* Align cursive to baseline */
        position: relative; /* Needed for 'top' property to work */
        top: calc(var(--row-height-px) * 0.2); /* Reduced from 0.33 to better align with writing lines */
    }
    .row .letters.cursive-font.tracing {
        color: #ccc; /* Lighter color for tracing */
    }
    .row.fading-trace .letters.cursive-font {
        color: rgba(51, 51, 51, 0.7); /* General faded color for text */
    }
    .row.guided-copy .letters.cursive-font span {
        display: inline-block; /* Ensure spans within guided copy behave correctly */
    }
    .row.guided-copy .letters.cursive-font span:not(:first-child) {
        opacity: 0.4;
    }
    /* Optimize cursive beginning letters size */
    .row.trace[data-content="beginning"] .letters.cursive-font,
    .row.fading-trace[data-content="beginning"] .letters.cursive-font,
    .row.guided-copy[data-content="beginning"] .letters.cursive-font {
        font-size: calc(var(--row-height-px, 40.32px) * 1.05 + 3px) !important;
    }
    /* Lowercase cursive letters need additional height */
    .row.trace[data-content="beginning"][data-casing="lowercase"] .letters.cursive-font,
    .row.fading-trace[data-content="beginning"][data-casing="lowercase"] .letters.cursive-font,
    .row.guided-copy[data-content="beginning"][data-casing="lowercase"] .letters.cursive-font {
        font-size: calc(var(--row-height-px, 40.32px) * 1.05 + 6px) !important;
    }
    /* Ensure Lexend Deca font is used for general print text rows */
    .row.trace .letters.lexend-deca-font,
    .row.fading-trace .letters.lexend-deca-font,
    .row.guided-copy .letters.lexend-deca-font,
    .row.fill .text-line.lexend-deca-font {
        font-family: 'Lexend Deca', sans-serif;
    }


    .row.fill .text-line {
      position: absolute;
      top: 50%;
      left: 8px;
      transform: translateY(calc(-50% - 2px));
      width: 100%;
      font-size: calc(var(--row-height-px, 40.32px) * 1.337);
      line-height: 1;
      white-space: nowrap;
      overflow: visible;
    }
    .row.fill .text-line.cursive-font {
        position: relative;
        transform: none;
        top: calc(var(--row-height-px) * 0.2); /* Reduced from 0.33 to match other cursive alignment */
        left: 0;
        padding-left: 8px;
        font-size: calc(var(--row-height-px, 40.32px) * 1.279202);
        color: #333;
    }
    .row.fill .text-line .uppercase-fill { font-weight: 300; }
    .row.fill .text-line .lowercase-fill {
        font-weight: 400;
        font-size: 69%;
        display: inline-block;
    }
    .row.trace .letters img.lowercase, .row.fading-trace .letters img.lowercase, .row.guided-copy .letters img.lowercase,
    .row.trace .letters canvas.lowercase, .row.fading-trace .letters canvas.lowercase, .row.guided-copy .letters canvas.lowercase {
      height: 50%; align-self: flex-end; box-sizing: border-box; padding-bottom: 2px; top: 0;
      transform: translateY(0);
    }
    .row.trace .letters .punctuation-fill {
        font-size: calc(var(--row-height-px, 40.32px) * 1.387);
        line-height: var(--row-height-px, 40.32px);
        font-weight: 300;
        color: #333;
        align-self: center;
        padding-bottom: calc(var(--row-height-px, 40.32px) * 0.078);
    }
    .row.trace[data-content="filename"] .letters, .row.fading-trace[data-content="filename"] .letters, .row.guided-copy[data-content="filename"] .letters { display: flex !important; gap: 8.5px !important; align-items: center !important; }
    /* Beginning letters distributed across full width of writing block */
    .row.trace[data-content="beginning"] .letters,
    .row.fading-trace[data-content="beginning"] .letters,
    .row.guided-copy[data-content="beginning"] .letters {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        gap: 0 !important;
        padding-left: 12px !important;
        padding-right: 12px !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }

    /* Letter sizing - space-between handles all spacing */
    .row.trace[data-content="beginning"] .letters img, .row.fading-trace[data-content="beginning"] .letters img, .row.guided-copy[data-content="beginning"] .letters img,
    .row.trace[data-content="beginning"] .letters canvas, .row.fading-trace[data-content="beginning"] .letters canvas, .row.guided-copy[data-content="beginning"] .letters canvas {
        max-width: 90px !important;
        flex-shrink: 0 !important;
    }

    /* Uppercase letters */
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img, .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img, .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas, .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas, .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas {
        max-width: 80px !important;
        flex-shrink: 0 !important;
        align-self: flex-end !important;
        margin-bottom: 2px !important;
    }

    /* Increase height by 18% for uppercase beginning letters (non-cursive fonts only) */
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.cursive-font),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.cursive-font),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img:not(.cursive-font),
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.cursive-font),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.cursive-font),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.cursive-font) {
        height: 101% !important;
    }

    /* Adjusted height for Print Regular and Print Tracing (decreased by 8% total) */
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow),
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow),
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow) {
        height: 98% !important;
        transform: translateY(2%) !important;
    }

    /* Adjusted height for Print Tracing Arrow (decreased by 4%) */
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-tracing-arrow,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-tracing-arrow {
        height: 103% !important;
        transform: translateY(12%) !important;
    }

    /* Adjusted height for Print Regular Arrow (decreased by 4%) */
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img.font-print-regular-arrow,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas.font-print-regular-arrow {
        height: 108% !important;
        transform: translateY(12%) !important;
    }

    /* Adjusted height for specific lowercase 'b' and 'h' letters in Print Regular Arrow beginning letters */
    .row.trace[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="b"],
    .row.trace[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="h"],
    .row.fading-trace[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="b"],
    .row.fading-trace[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="h"],
    .row.guided-copy[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="b"],
    .row.guided-copy[data-content="beginning"][data-casing="lowercase"] .letters img.lowercase.font-print-regular-arrow[alt="h"],
    .row.trace[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="b"],
    .row.trace[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="h"],
    .row.fading-trace[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="b"],
    .row.fading-trace[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="h"],
    .row.guided-copy[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="b"],
    .row.guided-copy[data-content="beginning"][data-casing="lowercase"] .letters canvas.lowercase.font-print-regular-arrow[alt="h"] {
        height: 111% !important;
        align-self: flex-end !important;
    }

    /* Adjusted height for Print Regular and Print Tracing uppercase letters in custom text content */
    .row.trace[data-content="custom"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.fading-trace[data-content="custom"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.guided-copy[data-content="custom"][data-casing="uppercase"] .letters img.font-print-regular:not(.font-print-regular-arrow),
    .row.trace[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.fading-trace[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.guided-copy[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-regular:not(.font-print-regular-arrow),
    .row.trace[data-content="custom"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.fading-trace[data-content="custom"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.guided-copy[data-content="custom"][data-casing="uppercase"] .letters img.font-print-tracing:not(.font-print-tracing-arrow),
    .row.trace[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow),
    .row.fading-trace[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow),
    .row.guided-copy[data-content="custom"][data-casing="uppercase"] .letters canvas.font-print-tracing:not(.font-print-tracing-arrow) {
        height: 110% !important;
        align-self: flex-end !important;
    }

    /* REMOVED: Incorrect positioning override that made letters sit too low
     * All modes now use the correct custom mode positioning (translateY(2px))
     * This was causing inconsistency between beginning/filename/custom modes
     */
    /* .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="beginning"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow {
        top: -3% !important;
    } */
    .row.trace .letters img.larger, .row.fading-trace .letters img.larger, .row.guided-copy .letters img.larger { height: 65% !important; align-self: flex-end !important; }
    .row.fill[data-content="filename"] .text-line span,
    .row.fill[data-content="custom"] .text-line span { font-family: 'Quicksand', sans-serif; color: #555; }
    
    /* Match special lowercase overrides for both img and canvas elements */
    /* Full height ascenders */
    .row.trace .letters img.lowercase[alt="b"], .row.trace .letters canvas.lowercase[alt="b"], .row.trace .letters img.lowercase[alt="d"], .row.trace .letters canvas.lowercase[alt="d"], .row.trace .letters img.lowercase[alt="f"], .row.trace .letters canvas.lowercase[alt="f"], .row.trace .letters img.lowercase[alt="h"], .row.trace .letters canvas.lowercase[alt="h"], .row.trace .letters img.lowercase[alt="k"], .row.trace .letters canvas.lowercase[alt="k"], .row.trace .letters img.lowercase[alt="l"], .row.trace .letters canvas.lowercase[alt="l"],
    .fading-trace .letters img.lowercase[alt="b"], .fading-trace .letters canvas.lowercase[alt="b"], .fading-trace .letters img.lowercase[alt="d"], .fading-trace .letters canvas.lowercase[alt="d"], .fading-trace .letters img.lowercase[alt="f"], .fading-trace .letters canvas.lowercase[alt="f"], .fading-trace .letters img.lowercase[alt="h"], .fading-trace .letters canvas.lowercase[alt="h"], .fading-trace .letters img.lowercase[alt="k"], .fading-trace .letters canvas.lowercase[alt="k"], .fading-trace .letters img.lowercase[alt="l"], .fading-trace .letters canvas.lowercase[alt="l"],
    .guided-copy .letters img.lowercase[alt="b"], .guided-copy .letters canvas.lowercase[alt="b"], .guided-copy .letters img.lowercase[alt="d"], .guided-copy .letters canvas.lowercase[alt="d"], .guided-copy .letters img.lowercase[alt="f"], .guided-copy .letters canvas.lowercase[alt="f"], .guided-copy .letters img.lowercase[alt="h"], .guided-copy .letters canvas.lowercase[alt="h"], .guided-copy .letters img.lowercase[alt="k"], .guided-copy .letters canvas.lowercase[alt="k"], .guided-copy .letters img.lowercase[alt="l"], .guided-copy .letters canvas.lowercase[alt="l"] {
      height: 98% !important; width: auto !important; object-fit: contain !important; align-self: flex-end !important;
    }
    
    /* Regular height ascenders and descenders (restored) */
    .row.trace .letters img.lowercase[alt="g"], .row.trace .letters canvas.lowercase[alt="g"], .row.trace .letters img.lowercase[alt="p"], .row.trace .letters canvas.lowercase[alt="p"], .row.trace .letters img.lowercase[alt="q"], .row.trace .letters canvas.lowercase[alt="q"], .row.trace .letters img.lowercase[alt="t"], .row.trace .letters canvas.lowercase[alt="t"], .row.trace .letters img.lowercase[alt="y"], .row.trace .letters canvas.lowercase[alt="y"],
    .fading-trace .letters img.lowercase[alt="g"], .fading-trace .letters canvas.lowercase[alt="g"], .fading-trace .letters img.lowercase[alt="p"], .fading-trace .letters canvas.lowercase[alt="p"], .fading-trace .letters img.lowercase[alt="q"], .fading-trace .letters canvas.lowercase[alt="q"], .fading-trace .letters img.lowercase[alt="t"], .fading-trace .letters canvas.lowercase[alt="t"], .fading-trace .letters img.lowercase[alt="y"], .fading-trace .letters canvas.lowercase[alt="y"],
    .guided-copy .letters img.lowercase[alt="g"], .guided-copy .letters canvas.lowercase[alt="g"], .guided-copy .letters img.lowercase[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"], .guided-copy .letters img.lowercase[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"], .guided-copy .letters img.lowercase[alt="t"], .guided-copy .letters canvas.lowercase[alt="t"], .guided-copy .letters img.lowercase[alt="y"], .guided-copy .letters canvas.lowercase[alt="y"] {
      height: 72% !important; width: auto !important; object-fit: contain !important; align-self: flex-end !important;
    }

    /* Special positioning for descenders */
    .row.trace .letters img.lowercase[alt="g"], .row.trace .letters canvas.lowercase[alt="g"], .row.trace .letters img.lowercase[alt="p"], .row.trace .letters canvas.lowercase[alt="p"], .row.trace .letters img.lowercase[alt="q"], .row.trace .letters canvas.lowercase[alt="q"], .row.trace .letters img.lowercase[alt="y"], .row.trace .letters canvas.lowercase[alt="y"],
    .fading-trace .letters img.lowercase[alt="g"], .fading-trace .letters canvas.lowercase[alt="g"], .fading-trace .letters img.lowercase[alt="p"], .fading-trace .letters canvas.lowercase[alt="p"], .fading-trace .letters img.lowercase[alt="q"], .fading-trace .letters canvas.lowercase[alt="q"], .fading-trace .letters img.lowercase[alt="y"], .fading-trace .letters canvas.lowercase[alt="y"],
    .guided-copy .letters img.lowercase[alt="g"], .guided-copy .letters canvas.lowercase[alt="g"], .guided-copy .letters img.lowercase[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"], .guided-copy .letters img.lowercase[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"], .guided-copy .letters img.lowercase[alt="y"], .guided-copy .letters canvas.lowercase[alt="y"] {
      position: relative !important; top: calc(var(--row-height-px, 40.32px) * 0.24) !important; padding-bottom: 0 !important;
    }
    .row.trace .letters img.lowercase[alt="i"], .row.trace .letters canvas.lowercase[alt="i"], .fading-trace .letters img.lowercase[alt="i"], .fading-trace .letters canvas.lowercase[alt="i"], .guided-copy .letters img.lowercase[alt="i"], .guided-copy .letters canvas.lowercase[alt="i"] {
      height: 62% !important; width: auto !important; object-fit: contain !important; align-self: flex-end !important;
    }
    .row.trace .letters img.lowercase[alt="j"], .row.trace .letters canvas.lowercase[alt="j"], .fading-trace .letters img.lowercase[alt="j"], .fading-trace .letters canvas.lowercase[alt="j"], .guided-copy .letters img.lowercase[alt="j"], .guided-copy .letters canvas.lowercase[alt="j"] {
      height: 88% !important; width: auto !important; object-fit: contain !important; align-self: flex-end !important; position: relative !important; top: calc(var(--row-height-px) * 0.288) !important; padding-bottom: 0 !important;
    }
    /* Descender override for specific letters p, q, y */
    .row.trace .letters img.lowercase[alt="p"], .row.trace .letters canvas.lowercase[alt="p"],
    .row.trace .letters img.lowercase[alt="q"], .row.trace .letters canvas.lowercase[alt="q"],
    .row.trace .letters img.lowercase[alt="y"], .row.trace .letters canvas.lowercase[alt="y"],
    .fading-trace .letters img.lowercase[alt="p"], .fading-trace .letters canvas.lowercase[alt="p"],
    .fading-trace .letters img.lowercase[alt="q"], .fading-trace .letters canvas.lowercase[alt="q"],
    .fading-trace .letters img.lowercase[alt="y"], .fading-trace .letters canvas.lowercase[alt="y"],
    .guided-copy .letters img.lowercase[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"],
    .guided-copy .letters img.lowercase[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"],
    .guided-copy .letters img.lowercase[alt="y"], .guided-copy .letters canvas.lowercase[alt="y"] {
        height: 80% !important;
        top: calc(var(--row-height-px) * 0.32) !important;
    }
    .row.trace .letters img.lowercase[alt="g"], .row.trace .letters canvas.lowercase[alt="g"],
    .fading-trace .letters img.lowercase[alt="g"], .fading-trace .letters canvas.lowercase[alt="g"],
    .guided-copy .letters img.lowercase[alt="g"], .guided-copy .letters canvas.lowercase[alt="g"] {
        height: 80% !important;
        top: calc(var(--row-height-px) * 0.32) !important;
    }


    /* New styling for punctuation and symbols */
    .row.trace .letters img[alt="1"], .row.trace .letters canvas[alt="1"],
    .fading-trace .letters img[alt="1"], .fading-trace .letters canvas[alt="1"],
    .guided-copy .letters img[alt="1"], .guided-copy .letters canvas[alt="1"],
    .row.trace .letters img[alt="("], .row.trace .letters canvas[alt="("],
    .row.trace .letters img[alt=")"], .row.trace .letters canvas[alt=")"],
    .row.trace .letters img[alt="!"], .row.trace .letters canvas[alt="!"],
    .fading-trace .letters img[alt="("], .fading-trace .letters canvas[alt="("],
    .fading-trace .letters img[alt=")"], .fading-trace .letters canvas[alt=")"],
    .fading-trace .letters img[alt="!"], .fading-trace .letters canvas[alt="!"],
    .guided-copy .letters img[alt="("], .guided-copy .letters canvas[alt="("],
    .guided-copy .letters img[alt=")"], .guided-copy .letters canvas[alt=")"],
    .guided-copy .letters img[alt="!"] {
        height: 98% !important;
        align-self: center !important;
    }

    .row.trace .letters img[alt="+"], .row.trace .letters canvas[alt="+"],
    .row.trace .letters img[alt="-"], .row.trace .letters canvas[alt="-"],
    .fading-trace .letters img[alt="+"], .fading-trace .letters canvas[alt="+"],
    .fading-trace .letters img[alt="-"], .fading-trace .letters canvas[alt="-"],
    .guided-copy .letters img[alt="+"], .guided-copy .letters canvas[alt="+"],
    .guided-copy .letters img[alt="-"], .guided-copy .letters canvas[alt="-"] {
        height: 45% !important;
        align-self: center !important;
    }
    
    .row.trace .letters img[alt="="], .row.trace .letters canvas[alt="="],
    .fading-trace .letters img[alt="="], .fading-trace .letters canvas[alt="="],
    .guided-copy .letters img[alt="="], .guided-copy .letters canvas[alt="="] {
        height: 35% !important;
        width: 25px !important;
        align-self: center !important;
    }
    
    .row.trace .letters img[alt=":"], .row.trace .letters canvas[alt=":"],
    .fading-trace .letters img[alt=":"], .fading-trace .letters canvas[alt=":"],
    .guided-copy .letters img[alt=":"], .guided-copy .letters canvas[alt=":"] {
        height: 45% !important;
        align-self: flex-end !important;
        padding-bottom: 4px !important;
    }

    .row.trace .letters img[alt="."], .row.trace .letters canvas[alt="."],
    .fading-trace .letters img[alt="."], .fading-trace .letters canvas[alt="."],
    .guided-copy .letters img[alt="."], .guided-copy .letters canvas[alt="."] {
        height: 12.5% !important;
        align-self: flex-end !important;
        padding-bottom: 4px !important;
    }

    .row.trace .letters img[alt=";"], .row.trace .letters canvas[alt=";"],
    .fading-trace .letters img[alt=";"], .fading-trace .letters canvas[alt=";"],
    .guided-copy .letters img[alt=";"], .guided-copy .letters canvas[alt=";"] {
        height: 65% !important;
        position: relative !important;
        top: calc(var(--row-height-px) * 0.25) !important;
        padding-bottom: 0 !important;
    }

    .row.trace .letters img[alt=","], .row.trace .letters canvas[alt=","],
    .fading-trace .letters img[alt=","], .fading-trace .letters canvas[alt=","],
    .guided-copy .letters img[alt=","], .guided-copy .letters canvas[alt=","] {
        height: 27% !important;
        position: relative !important;
        top: calc(var(--row-height-px) * 0.30) !important;
        padding-bottom: 0 !important;
    }
    
    /* Font-specific overrides ONLY for "print regular" font */
    .row.trace .letters img.lowercase.font-print-regular[alt="g"], .row.trace .letters canvas.lowercase.font-print-regular[alt="g"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="g"], .fading-trace .letters canvas.lowercase.font-print-regular[alt="g"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="g"], .guided-copy .letters canvas.lowercase[alt="g"],
    .row.trace .letters img.lowercase.font-print-regular[alt="p"], .row.trace .letters canvas.lowercase.font-print-regular[alt="p"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="p"], .fading-trace .letters canvas.lowercase.font-print-regular[alt="p"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"],
    .row.trace .letters img.lowercase.font-print-regular[alt="q"], .row.trace .letters canvas.lowercase.font-print-regular[alt="q"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="q"], .fading-trace .letters canvas.lowercase.font-print-regular[alt="q"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"] {
        height: 94.4% !important;
        top: calc(var(--row-height-px) * 0.44) !important;
    }

    .row.trace .letters img.lowercase.font-print-regular[alt="j"], .row.trace .letters canvas.lowercase[alt="j"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="j"], .fading-trace .letters canvas.lowercase[alt="j"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="j"], .guided-copy .letters canvas.lowercase[alt="j"] {
        height: 121.4% !important;
        top: calc(var(--row-height-px) * 0.488) !important;
    }
    /* Font-specific override for p, q */
    .row.trace .letters img.lowercase.font-print-regular[alt="p"], .row.trace .letters canvas.lowercase.font-print-regular[alt="p"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="p"], .fading-trace .letters canvas.lowercase.font-print-regular[alt="p"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"],
    .row.trace .letters img.lowercase.font-print-regular[alt="q"], .row.trace .letters canvas.lowercase.font-print-regular[alt="q"],
    .fading-trace .letters img.lowercase.font-print-regular[alt="q"], .fading-trace .letters canvas.lowercase.font-print-regular[alt="q"],
    .guided-copy .letters img.lowercase.font-print-regular[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"] {
        height: 94.4% !important;
        top: calc(var(--row-height-px) * 0.44) !important;
    }
    .row.trace .letters img.lowercase[alt="t"], .row.trace .letters canvas.lowercase[alt="t"],
    .fading-trace .letters img.lowercase[alt="t"], .fading-trace .letters canvas.lowercase[alt="t"],
    .guided-copy .letters img.lowercase[alt="t"], .guided-copy .letters canvas.lowercase[alt="t"] {
        height: 75% !important;
    }
    .row.trace .letters img.lowercase[alt="i"], .row.trace .letters canvas.lowercase[alt="i"],
    .fading-trace .letters img.lowercase[alt="i"], .fading-trace .letters canvas.lowercase[alt="i"],
    .guided-copy .letters img.lowercase[alt="i"], .guided-copy .letters canvas.lowercase[alt="i"] {
        height: 65% !important;
    }

    /* Height adjustments for arrow fonts (cumulative) */
    /* Height: 54% (v) */
    .row.trace .letters img.lowercase[alt="v"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="v"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="v"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="v"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="v"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="v"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="v"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="v"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="v"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="v"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="v"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="v"].font-print-tracing-arrow {
        height: 54% !important;
    }
    /* Height: 56% (c, e) */
    .row.trace .letters img.lowercase[alt="c"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="c"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="e"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="e"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="c"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="c"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="e"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="e"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="c"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="c"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="e"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="e"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="c"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="c"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="e"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="e"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="c"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="c"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="e"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="e"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="c"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="c"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="e"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="e"].font-print-tracing-arrow {
        height: 56% !important;
    }
    /* Height: 59.4% (u) */
    .row.trace .letters img.lowercase[alt="u"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="u"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="u"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="u"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="u"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="u"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="u"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="u"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="u"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="u"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="u"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="u"].font-print-tracing-arrow {
        height: 59.4% !important;
    }
    /* Height: 60.48% (s) */
    .row.trace .letters img.lowercase[alt="s"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="s"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="s"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="s"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="s"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="s"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="s"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="s"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="s"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="s"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="s"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="s"].font-print-tracing-arrow {
        height: 60.48% !important;
    }
    /* Height: 61.6% (a, o) */
    .row.trace .letters img.lowercase[alt="a"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="a"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="o"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="o"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="a"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="a"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="o"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="o"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="a"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="a"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="o"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="o"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="a"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="a"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="o"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="o"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="a"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="a"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="o"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="o"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="a"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="a"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="o"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="o"].font-print-tracing-arrow {
        height: 61.6% !important;
    }
    /* Height: 66.528% (m, n, r, z) */
    .row.trace .letters img.lowercase[alt="m"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="m"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="n"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="n"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="r"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="r"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="z"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="z"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="m"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="m"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="n"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="n"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="r"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="r"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="z"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="z"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="m"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="m"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="n"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="n"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="r"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="r"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="z"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="z"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="m"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="m"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="n"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="n"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="r"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="r"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="z"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="z"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="m"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="m"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="n"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="n"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="r"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="r"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="z"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="z"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="m"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="m"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="n"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="n"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="r"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="r"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="z"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="z"].font-print-tracing-arrow {
        height: 66.528% !important;
    }
    /* Height: 73.656% (i) */
    .row.trace .letters img.lowercase[alt="i"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="i"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="i"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="i"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="i"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="i"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="i"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="i"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="i"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="i"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="i"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="i"].font-print-tracing-arrow {
        height: 73.656% !important;
    }
    /* Height: 80.64% (t) */
    .row.trace .letters img.lowercase[alt="t"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="t"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="t"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="t"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="t"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="t"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="t"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="t"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="t"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="t"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="t"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="t"].font-print-tracing-arrow {
        height: 80.64% !important;
    }
    /* Height: 95.79% (g, p, q) */
    .row.trace .letters img.lowercase[alt="g"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="g"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="p"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="p"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="q"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="q"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="g"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="g"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="p"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="p"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="q"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="q"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="g"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="g"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="p"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="p"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="q"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="q"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="g"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="g"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="p"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="p"].font-print-tracing-arrow,
    .row.trace .letters img.lowercase[alt="q"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="q"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="g"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="g"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="p"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="p"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="q"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="q"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="g"], .guided-copy .letters canvas.lowercase[alt="g"],
    .guided-copy .letters img.lowercase[alt="p"], .guided-copy .letters canvas.lowercase[alt="p"],
    .guided-copy .letters img.lowercase[alt="q"], .guided-copy .letters canvas.lowercase[alt="q"] {
        height: 95.79% !important;
    }
    /* Height: 106.445% (j) */
    .row.trace .letters img.lowercase[alt="j"].font-print-regular-arrow, .row.trace .letters canvas.lowercase[alt="j"].font-print-regular-arrow,
    .fading-trace .letters img.lowercase[alt="j"].font-print-regular-arrow, .fading-trace .letters canvas.lowercase[alt="j"].font-print-regular-arrow,
    .guided-copy .letters img.lowercase[alt="j"].font-print-regular-arrow, .guided-copy .letters canvas.lowercase[alt="j"].font-print-regular-arrow,
    .row.trace .letters img.lowercase[alt="j"].font-print-tracing-arrow, .row.trace .letters canvas.lowercase[alt="j"].font-print-tracing-arrow,
    .fading-trace .letters img.lowercase[alt="j"].font-print-tracing-arrow, .fading-trace .letters canvas.lowercase[alt="j"].font-print-tracing-arrow,
    .guided-copy .letters img.lowercase[alt="j"].font-print-tracing-arrow, .guided-copy .letters canvas.lowercase[alt="j"].font-print-tracing-arrow {
        height: 106.445% !important;
    }
    /* Height adjustments for UPPERCASE arrow fonts */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"], .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"], .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"] {
        height: 112.7% !important;
    }

    /* REMOVED: Filename-specific height and transform overrides (lines 1140-1338)
     * These overrides created inconsistency with custom and beginning modes.
     * All modes now use the same baseline positioning (transform: translateY(2px) from custom mode).
     * This eliminates 200+ lines of per-letter compensation that were needed because
     * the height: 115% and translateY(-4px) approach was fundamentally incompatible.
     */
    /*
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-regular-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-regular-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.fading-trace[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters img:not(.lowercase).font-print-tracing-arrow,
    .row.guided-copy[data-content="filename"][data-casing="uppercase"] .letters canvas:not(.lowercase).font-print-tracing-arrow {
        height: 115% !important;
        transform: translateY(-4px) !important;
    }

    [... plus 180+ lines of per-letter adjustments for I, A, Y, S, W, C, G, V, X, L, H ...]
    */

    /* Original rule for specified UPPERCASE arrow fonts to move them up by 15% */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="B"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="B"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="D"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="D"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="E"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="E"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="F"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="F"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="J"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="J"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="M"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="M"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="N"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="N"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="O"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="O"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="P"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="P"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Q"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="R"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="R"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="T"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="T"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="U"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="U"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="Z"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="B"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="D"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="E"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="F"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="J"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="M"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="N"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="O"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="P"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Q"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="R"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="T"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="U"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="Z"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="Z"] {
        position: relative !important;
        top: -15% !important; /* Move up by 15% of the row height */
    }

    /* Move down by 3% for specified uppercase arrow letters */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="S"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="A"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="C"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="G"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="H"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="K"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="L"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="S"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="S"] {
        top: -12% !important; /* -15% + 3% = -12% */
    }

    /* Increase height of 'I' for arrow fonts by 8% and move down by 8% */
    .row.trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .fading-trace .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .fading-trace .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters img:not(.lowercase).font-print-regular-arrow[alt="I"],
    .guided-copy .letters canvas:not(.lowercase).font-print-regular-arrow[alt="I"],
    .row.trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .row.trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .fading-trace .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .fading-trace .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .guided-copy .letters img:not(.lowercase).font-print-tracing-arrow[alt="I"],
    .guided-copy .letters canvas:not(.lowercase).font-print-tracing-arrow[alt="I"] {
        height: calc(112.7% + 8%) !important; /* Original 112.7% + 8% */
        top: calc(-15% + 8%) !important; /* Adjust top position: -15% (original moved up) + 8% (moved down) = -7% */
    }


    </style>
</head>
<body>
<div id="menuOverlay" class="menu-overlay"></div>
<div class="layout">
    <div class="panel">
        <div class="panel-header">
            <h2 data-translate="settings.title">Writing Worksheet</h2>
            <button id="menuCloseBtn" class="menu-close-btn">&times;</button>
        </div>
        <div class="panel-content">
            <div class="accordion-item">
                <button class="accordion-button" data-translate="settings.pageSetup">Page Setup</button>
                <div class="accordion-content">
                    <label for="pageSizeSelect" data-translate="settings.pageSize">Page Size:</label>
                    <select id="pageSizeSelect">
                        <option value="letter" selected data-translate="pageSize.letterPortrait">Letter Portrait (8.511")</option>
                        <option value="letter-landscape" data-translate="pageSize.letterLandscape">Letter Landscape (118.5")</option>
                        <option value="a4" data-translate="pageSize.a4Portrait">A4 Portrait (210297mm)</option>
                        <option value="a4-landscape" data-translate="pageSize.a4Landscape">A4 Landscape (297210mm)</option>
                        <option value="custom" data-translate="pageSize.custom">Custom</option>
                    </select>
                    <div id="customPageSizeInputs" style="display:none; margin-top: 10px; display:flex; flex-direction:column; gap:10px;">
                        <div>
                            <label for="customWidth" data-translate="settings.width">Width (px):</label>
                            <input type="number" id="customWidth" value="816" min="100">
                        </div>
                        <div>
                            <label for="customHeight" data-translate="settings.height">Height (px):</label>
                            <input type="number" id="customHeight" value="1056" min="100">
                        </div>
                    </div>
                    <h4 style="margin-top:20px;" data-translate="decoration.background">Background</h4>
                    <label for="backgroundThemeSelect" data-translate="decoration.backgroundTheme">Background Theme:</label>
                    <select id="backgroundThemeSelect">
                        <option value="none" data-translate="decoration.none">None</option>
                    </select>
                    <div id="backgroundDictionary"><div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);" data-translate="message.selectBackgroundTheme">Select a theme for backgrounds.</div></div>
                    <label for="backgroundOpacitySlider" data-translate="decoration.backgroundOpacity">Background Opacity:</label>
                    <input type="range" id="backgroundOpacitySlider" min="0" max="1" step="0.05" value="1" disabled>

                    <h4 style="margin-top:20px;" data-translate="decoration.border">Border</h4>
                    <label for="borderThemeSelect" data-translate="decoration.borderTheme">Border Theme:</label>
                    <select id="borderThemeSelect">
                        <option value="none" data-translate="decoration.none">None</option>
                    </select>
                    <div id="borderDictionary"><div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);" data-translate="message.selectBorderTheme">Select a theme to see borders.</div></div>
                    <label for="borderOpacitySlider" data-translate="decoration.borderOpacity">Border Opacity:</label>
                    <input type="range" id="borderOpacitySlider" min="0" max="1" value="1" step="0.05" disabled>
                </div>
            </div>

            <div class="accordion-item">
                <button class="accordion-button" data-translate="library.title">Image Library</button>
                <div class="accordion-content">
                    <label data-translate="library.imageMode">Image Mode:</label>
                    <div class="radio-group">
                        <input type="radio" id="exerciseImageMode" name="imageMode" value="exercise" checked>
                        <label for="exerciseImageMode" data-translate="imageMode.exercise">Exercise Image</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="customImageMode" name="imageMode" value="custom">
                        <label for="customImageMode" data-translate="imageMode.custom">Custom Images</label>
                    </div>

                    <div id="exerciseImageSection" style="margin-top: 15px;">
                        <label data-translate="library.pickExercise">Pick an exercise image (optional):</label>
                        <select id="themeSelect"></select>
                        <input id="searchInput" data-translate-placeholder="library.searchPlaceholder" placeholder="Search images..." style="margin-top:10px;"/>
                        <div id="imageFeedback" style="display:none; border:1px solid var(--app-border-dark); padding:10px; text-align:center; margin-top:10px;">
                            <img id="thumbnailPreview" style="width:100%; height:140px; object-fit:contain; margin-bottom:8px; background:white; border-radius:4px;"/>
                            <div id="imageStatusText" style="margin-bottom:8px;"></div>
                            <button onclick="unselectImage()" style="background:var(--app-accent-danger); border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" data-translate="button.unselectImage">Unselect Image</button>
                        </div>
                        <div id="imagePrompt" style="font-size:13px; color:var(--app-text-secondary-dark-theme); margin-top:10px;" data-translate="message.selectImageToInclude">Please select an image to include.</div>
                    </div>
                     <div id="customImageSection" style="display: none; margin-top: 15px;">
                        <div id="customImageSelectionPreview" style="display:none; border:1px solid var(--app-border-dark); padding:10px; text-align:center; margin-bottom:10px;">
                            <img id="customImageThumbnailPreview" style="width:100%; height:80px; object-fit:contain; margin-bottom:8px; background:white; border-radius:4px;"/>
                            <div id="customImageStatusText" style="margin-bottom:8px;"></div>
                            <button id="clearCustomImageSelectionBtn" style="background:var(--app-accent-danger); border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" data-translate="button.clearSelection">Clear Selection</button>
                        </div>
                        <p style="font-size:13px; color:var(--app-text-secondary-dark-theme); margin-bottom:10px;">Select an image below and click 'Add' to place it on the page.</p>
                        <button id="addSelectedCustomImageBtn" style="background: var(--app-accent-primary); color: white;" disabled data-translate="button.addSelectedImage">Add Selected Image</button>
                    </div>
                    <div id="dictionary"></div>
                </div>
            </div>

            <div class="accordion-item">
                <button class="accordion-button" data-translate="library.uploadTitle">Upload Custom Images</button>
                <div class="accordion-content">
                    <label data-translate="library.selectUpload">Select image(s) to upload:</label>
                    <div style="margin: 10px 0;">
                        <button type="button" id="customFileButton" class="action-button" style="padding: 8px 16px; font-size: 14px;" data-translate="library.chooseFiles">Choose Files</button>
                        <span id="fileSelectionText" style="margin-left: 10px; color: var(--app-text-secondary-dark-theme);" data-translate="library.noFileChosen">No file chosen</span>
                        <input type="file" id="imageUploadInput" multiple accept="image/*" style="position: absolute; left: -9999px;">
                    </div>
                    <label style="margin-top:10px;" data-translate="library.uploadedImages">Your Uploaded Images:</label>
                    <div id="uploadedImagesPreview"></div>
                </div>
            </div>

            <div id="textToolsContainer" class="accordion-item"></div>
            <div id="rowsContainer"></div>
        </div>
        <div class="panel-footer">
            <div id="message"></div>
        </div>
    </div>
    <div class="main">
        <button id="menuToggleBtn" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>

        <div id="object-context-toolbar">
            <div class="toolbar-group">
                <button id="bringForwardBtn" data-translate-title="toolbar.bringForward" title="Bring Forward" class="context-btn"><i class="fas fa-layer-group" style="transform: translateY(-2px);"></i></button>
                <button id="sendBackwardBtn" data-translate-title="toolbar.sendBackward" title="Send Backward" class="context-btn"><i class="fas fa-layer-group" style="transform: translateY(2px) scaleY(-1);"></i></button>
            </div>
            <div class="toolbar-group">
                <div class="toolbar-item">
                    <button class="context-btn" id="alignBtn" data-translate-title="toolbar.align" title="Align"><i class="fas fa-th"></i></button>
                    <div class="dropdown-content" id="alignDropdown" style="min-width: 220px; padding: 12px;">
                        <p style="font-size:11px; margin-bottom:5px; color:#555;">Align Selected:</p>
                        <div>
                            <button class="context-btn" id="alignLeftBtn" data-translate-title="toolbar.alignLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
                            <button class="context-btn" id="alignHCenterBtn" data-translate-title="toolbar.centerH" title="Center Horizontally"><i class="fas fa-align-center"></i></button>
                            <button class="context-btn" id="alignRightBtn" data-translate-title="toolbar.alignRight" title="Align Right"><i class="fas fa-align-right"></i></button>
                        </div>
                        <div style="margin-top: 5px;">
                            <button class="context-btn" id="alignTopBtn" data-translate-title="toolbar.alignTop" title="Align Top"><i class="fas fa-long-arrow-alt-up"></i></button>
                            <button class="context-btn" id="alignVCenterBtn" data-translate-title="toolbar.centerV" title="Center Vertically"><i class="fas fa-grip-lines-vertical"></i></button>
                            <button class="context-btn" id="alignBottomBtn" data-translate-title="toolbar.alignBottom" title="Align Bottom"><i class="fas fa-long-arrow-alt-down"></i></button>
                        </div>
                        <hr style="margin:8px 0; border:none; border-top:1px solid #eee;">
                        <p style="font-size:11px; margin-bottom:5px; color:#555;">Align to Page:</p>
                        <div>
                            <button class="context-btn" id="centerHCanvasBtn" data-translate-title="toolbar.centerPageH" title="Center on Page Horizontally"><i class="fas fa-arrows-alt-h"></i></button>
                            <button class="context-btn" id="centerVCanvasBtn" data-translate-title="toolbar.centerPageV" title="Center on Page Vertically"><i class="fas fa-arrows-alt-v"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="toolbar-group">
                <button id="cropBtn" data-translate-title="toolbar.cropOverflow" title="Crop Overflow" class="context-btn" style="display: none;"><i class="fas fa-crop-alt"></i></button>
                <button id="lockBtn" data-translate-title="toolbar.lock" title="Lock" class="context-btn">
                    <i id="lockIcon" class="fas fa-lock-open"></i>
                </button>
                <button id="toolbarDeleteBtn" data-translate-title="toolbar.delete" title="Delete" class="context-btn"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>

        <div class="top-right-actions">
            <button id="addRowBtn" class="action-button accent" data-translate="button.addRow"><i class="fas fa-pen-square"></i> Add Row</button>
            <div class="dropdown-container">
                <button id="downloadDropdownBtn" class="action-button secondary" data-translate="button.download">Download <i class="fas fa-caret-down" style="margin-left: 5px;"></i></button>
                <div id="downloadDropdownContent" class="dropdown-content">
                    <button id="downloadPdfBtn" data-translate="button.downloadPdf">Download as PDF</button>
                    <button id="downloadJpegBtn" data-translate="button.downloadJpeg">Download as JPEG</button>
                    <label class="checkbox-label">
                        <input type="checkbox" id="grayscaleToggle" /><span data-translate="settings.grayscale">Grayscale</span>
                    </label>
                </div>
            </div>
            <button id="clearAllBtn" class="action-button danger" data-translate="button.clearAll">Clear All</button>
        </div>

        <div class="tab-content-wrapper">
            <div class="canvas-container-wrapper">
                <div id="worksheet"></div>
            </div>
        </div>
    </div>
</div>

<template id="rowTpl">
    <div class="accordion-item">
        <button class="accordion-button">Row 1</button>
        <div class="accordion-content">
            <label data-translate="row.type">Row Type:</label>
            <select class="mode">
                <option value="trace" data-translate="rowType.trace">Trace</option>
                <option value="fading-trace" data-translate="rowType.fadingTrace">Fading Trace</option>
                <option value="guided-copy" data-translate="rowType.guidedCopy">Guided Copy</option>
            </select>
            <label data-translate="row.fontStyle">Font Style:</label>
            <select class="font-style">
                <option value="print/regular" data-translate="fontStyle.printRegular">Print Regular</option>
                <option value="print/regular arrow" data-translate="fontStyle.printRegularArrow">Print Regular Arrow</option>
                <option value="print/tracing" data-translate="fontStyle.printTracing">Print Tracing</option>
                <option value="print/tracing arrow" data-translate="fontStyle.printTracingArrow">Print Tracing Arrow</option>
                <option value="cursive" data-translate="fontStyle.cursive">Cursive</option>
            </select>
            <label data-translate="row.content">Content:</label>
            <select class="content">
                <option value="empty" data-translate="content.empty">Empty</option>
                <option value="beginning" data-translate="content.beginningLetter">Beginning Letter</option>
                <option value="filename" data-translate="content.wholeFileName">Whole File Name</option>
                <option value="custom" data-translate="content.customText">Custom Text</option>
            </select>
            <div class="case-options">
                <label data-translate="row.case">Case:</label>
                <select class="case">
                    <option value="uppercase" data-translate="case.uppercase">Upper-case</option>
                    <option value="lowercase" data-translate="case.lowercase">Lower-case</option>
                    <option value="title" data-translate="case.titleCase">Title Case</option>
                </select>
            </div>
            <div class="stroke-options" style="display:none;">
                <label data-translate="row.strokeType">Stroke Type:</label>
                <select class="stroke-type">
                    <option value="vertical" data-translate="stroke.vertical">Vertical Line</option>
                    <option value="horizontal" data-translate="stroke.horizontal">Horizontal Line</option>
                    <option value="circle" data-translate="stroke.circle">Circle</option>
                    <option value="zigzag" data-translate="stroke.zigzag">Zig-Zag Line</option>
                </select>
            </div>
            <textarea class="custom-text-input" data-translate-placeholder="row.customTextPlaceholder" placeholder="Enter custom trace text here..." style="display:none; margin-top: 10px;"></textarea>
            <button class="delete-row-btn" style="background-color: var(--app-accent-danger); color: white; border: none;" data-translate="button.deleteRow">Delete Row</button>
        </div>
    </div>
</template>

<template id="textToolsTpl">
    <div class="accordion-item">
        <button class="accordion-button" data-translate="settings.textTools">Text Tools</button>
        <div class="accordion-content">
            <h4 data-translate="text.addNewTitle">Add New Text</h4>
            <label for="textInput" data-translate="text.content">Content:</label><input type="text" id="textInput" data-translate-placeholder="text.placeholder" placeholder="New Text">
            <button id="addTextBtn" data-translate="button.addText">Add Text to Worksheet</button>
            <h4 style="margin-top:20px;" data-translate="text.selectedProperties">Selected Text Properties</h4>
            <label for="textColor" data-translate="text.color">Color:</label><input type="color" id="textColor" value="#333333" disabled>
            <label for="fontSize" data-translate="text.size">Size:</label><input type="number" id="fontSize" value="48" min="8" disabled readonly>
            <label for="fontFamily" data-translate="text.font">Font:</label>
            <select id="fontFamily" disabled>
                <option value="Arial" selected>Arial</option>
                <option value="Verdana">Verdana</option>
                <option value="Lexend Deca">Lexend Deca</option>
                <option value="Baloo 2">Baloo 2</option>
                <option value="Nunito">Nunito</option>
                <option value="Quicksand">Quicksand</option>
                <option value="Fredoka">Fredoka</option>
            </select>
            <label for="textStrokeColor" data-translate="text.outlineColor">Outline Color:</label><input type="color" id="textStrokeColor" value="#000000" disabled>
            <label for="textStrokeWidth" data-translate="text.outlineWidth">Outline (0-10):</label><input type="range" id="textStrokeWidth" min="0" max="10" value="0" step="0.5" disabled>
            <button id="toolbarDeleteSelectedTextBtn" style="background:var(--app-accent-danger); color:white; margin-top:15px; display:none;" data-translate="button.deleteSelectedText">Delete Selected Text</button>
        </div>
    </div>
</template>

<script>
// NOTE: The entire JavaScript block from the original "writing app.html" has been ported over.
// Minor modifications have been made to align with the new, consistent HTML structure and IDs.

/**
 * FIX: Re-engineered function to ensure high-quality rasterization of letter SVGs.
 * It now renders the SVG onto a high-resolution canvas, then styles it to fit the
 * on-screen row, preserving quality regardless of UI scaling.
 * It also "bakes in" the opacity for trace/guided modes to ensure correct download rendering.
 */
async function replaceLetterImagesWithCanvases() {
  // Only target SVG images that are still being used (i.e., not for cursive font which is now text)
  const letterImgs = document.querySelectorAll('#worksheet img[src$=".svg"]');
  for (const img of letterImgs) {
    try {
      // FIX: Get computed opacity and filter from the original element before it's replaced.
      const computedStyle = window.getComputedStyle(img);
      const opacity = parseFloat(computedStyle.opacity);
      const filter = computedStyle.filter; // This will capture the new strong filter from CSS

      const response = await fetch(img.src);
      const svgText = await response.text();
      const svgBlob = new Blob([svgText], { type: "image/svg+xml" });
      const url = URL.createObjectURL(svgBlob);
      const image = new Image();
      image.src = url;
      await new Promise(resolve => image.onload = resolve);

      const canvas = document.createElement('canvas');

      const RENDER_HEIGHT = 150;
      canvas.height = RENDER_HEIGHT;
      canvas.width = image.width * (canvas.height / image.height);

      const ctx = canvas.getContext("2d");
      // Apply the captured filter to the canvas context before drawing for optimal download clarity
      if (filter && filter !== 'none') {
        ctx.filter = filter;
      }
      ctx.globalAlpha = opacity;


      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      ctx.filter = 'none'; // Reset filter after drawing for subsequent operations

      canvas.className = img.className;
      canvas.setAttribute("alt", img.getAttribute("alt") || "");

      // *** CHANGE MADE HERE TO FIX THE CORE PROBLEM ***
      // Instead of copying all styles (which includes a 'height' that overrides the stylesheet),
      // we copy the styles but then remove the inline height, allowing the stylesheet to take control.
      const computed = window.getComputedStyle(img);
      canvas.style.cssText = computed.cssText;
      canvas.style.height = ''; // Allow stylesheet height to apply to the canvas.

      canvas.style.opacity = '1';
      // Do not apply filter to canvas.style, it was already baked into ctx.filter
      if (canvas.style.filter) canvas.style.filter = 'none'; // Clear filter from display style

      img.replaceWith(canvas);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Failed to replace SVG with canvas for:", img.src, e);
    }
  }
}

/**
 * Captures the worksheet element as a high-resolution canvas,
 * applying special fixes to ensure content visibility.
 * @returns {Promise<HTMLCanvasElement>} A promise that resolves with the captured canvas element.
 */
async function captureWorksheetAsCanvas() {
    window.scrollTo(0, 0);
    deselectAll();

    return new Promise(async (resolve, reject) => {
        // We call the replacement function on the REAL DOM before cloning.
        // This ensures all visual styles like opacity are baked in correctly for SVG/canvas elements.
        await replaceLetterImagesWithCanvases();

        setTimeout(async () => {
            const worksheet = document.getElementById('worksheet');
            const originalTransform = worksheet.style.transform;
            worksheet.style.transform = 'scale(1)';

            try {
                const canvas = await html2canvas(worksheet, {
                    scale: 6, // For ~300 DPI quality
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    logging: false,
                    onclone: (clonedDoc) => {
                        clonedDoc.querySelectorAll('.editable-block.row-block').forEach(block => {
                            const containerWidth = block.clientWidth;
                            const contentContainer = block.querySelector('.letters, .text-line');
                            if (contentContainer) {
                                const items = Array.from(contentContainer.children);
                                for (const item of items) {
                                    // Handle text overflow within text elements that are not image/canvas (e.g. fill mode)
                                    if (item.nodeType === Node.ELEMENT_NODE && (item.matches('.text-line') || item.matches('.letters.cursive-font'))) {
                                        if (item.scrollWidth > item.clientWidth + 1) { // Check for horizontal overflow
                                            let textContent = item.textContent;
                                            let tempSpan = document.createElement('span');
                                            tempSpan.style.font = window.getComputedStyle(item).font; // Use computed font
                                            tempSpan.style.whiteSpace = 'nowrap';
                                            tempSpan.style.visibility = 'hidden';
                                            tempSpan.style.position = 'absolute';
                                            document.body.appendChild(tempSpan);

                                            while (textContent.length > 0 && tempSpan.offsetWidth > item.clientWidth) {
                                                textContent = textContent.slice(0, -1);
                                                tempSpan.textContent = textContent;
                                            }
                                            item.textContent = textContent;
                                            document.body.removeChild(tempSpan);
                                        }
                                    }
                                }
                            }
                        });

                        clonedDoc.querySelectorAll('.row').forEach(row => {
                            row.style.overflow = 'visible';
                            row.style.clipPath = 'none';
                        });
                        
                        clonedDoc.querySelectorAll('.row.fill .text-line').forEach(line => {
                            line.style.overflow = 'visible';
                            line.style.zIndex = '2';
                            line.style.transform = 'translateY(calc(-50% - 2px))';
                        });
                        
                        // Ensure cloned elements retain their font styles for canvas rendering
                        clonedDoc.querySelectorAll('.row .letters, .row .text-line').forEach(el => {
                            el.style.fontFamily = window.getComputedStyle(el).fontFamily;
                            el.style.fontSize = window.getComputedStyle(el).fontSize;
                            el.style.lineHeight = window.getComputedStyle(el).lineHeight;
                        });

                        // Explicitly set font-family for text elements before html2canvas capture to ensure webfonts render
                        clonedDoc.querySelectorAll('.row .letters.cursive-font').forEach(el => {
                            el.style.fontFamily = `'Great Vibes', cursive`;
                        });
                        clonedDoc.querySelectorAll('.row .letters.lexend-deca-font').forEach(el => {
                            el.style.fontFamily = `'Lexend Deca', sans-serif`;
                        });
                        clonedDoc.querySelectorAll('.row .text-line.lexend-deca-font').forEach(el => {
                            el.style.fontFamily = `'Lexend Deca', sans-serif`;
                        });
                    }
                });
                worksheet.style.transform = originalTransform;
                // Re-render the worksheet to restore original interactive elements (like SVGs)
                // after the canvas capture is complete.
                justDownloaded = true;
                renderWorksheet();
                justDownloaded = false;
                resolve(canvas);
            } catch (error) {
                worksheet.style.transform = originalTransform;
                renderWorksheet();
                reject(error);
            }
        }, 100);
    });
}

/**
 * Converts a data URL to grayscale.
 * @param {string} dataURL - The original data URL of the image.
 * @returns {Promise<string>} A promise that resolves with the grayscaled data URL.
 */
async function applyGrayscaleToDataURL(dataURL) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.2126 + data[i + 1] * 0.7152 + data[i + 2] * 0.0722;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            ctx.putImageData(imageData, 0, 0);
            resolve(canvas.toDataURL('image/jpeg', 1.0));
        };
        img.src = dataURL;
    });
}

/**
 * Handles the download process for both PDF and JPEG formats.
 * @param {'pdf' | 'jpeg'} format - The desired output format.
 */
async function downloadFile(format) {
    try {
        const capturedCanvas = await captureWorksheetAsCanvas();
        let imageDataURL = capturedCanvas.toDataURL('image/jpeg', 1.0); // High quality JPEG

        if (document.getElementById('grayscaleToggle').checked) {
            imageDataURL = await applyGrayscaleToDataURL(imageDataURL);
        }

        if (format === 'jpeg') {
            const link = document.createElement('a');
            link.href = imageDataURL;
            link.download = 'worksheet.jpeg';
            link.click();
        } else if (format === 'pdf') {
            const pageSize = document.getElementById('pageSizeSelect').value;
            let pdfWidth, pdfHeight, pdfOrientation;

            if (pageSize === 'a4') {
                pdfWidth = 210 * 2.83465; pdfHeight = 297 * 2.83465; pdfOrientation = 'portrait';
            } else if (pageSize === 'a4-landscape') {
                pdfWidth = 297 * 2.83465; pdfHeight = 210 * 2.83465; pdfOrientation = 'landscape';
            } else if (pageSize === 'letter-landscape') {
                pdfWidth = 11 * 72; pdfHeight = 8.5 * 72; pdfOrientation = 'landscape';
            } else if (pageSize === 'custom') {
                pdfWidth = parseFloat(document.getElementById('customWidth').value) || (8.5 * 72);
                pdfHeight = parseFloat(document.getElementById('customHeight').value) || (11 * 72);
                pdfOrientation = pdfWidth > pdfHeight ? 'landscape' : 'portrait';
            } else {
                pdfWidth = 8.5 * 72; pdfHeight = 11 * 72; pdfOrientation = 'portrait';
            }

            const pdf = new jspdf.jsPDF({
                orientation: pdfOrientation, unit: 'pt', format: [pdfWidth, pdfHeight]
            });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const ratio = Math.min(pageWidth / capturedCanvas.width, pageHeight / capturedCanvas.height);
            const finalWidth = capturedCanvas.width * ratio;
            const finalHeight = capturedCanvas.height * ratio;
            const marginX = (pageWidth - finalWidth) / 2;
            const marginY = (pageHeight - finalHeight) / 2;

            pdf.addImage(imageDataURL, 'JPEG', marginX, marginY, finalWidth, finalHeight);
            pdf.save('worksheet.pdf');
        }
    } catch (error) {
        console.error("Download error:", error);
    }
}


// --- Main App Logic ---
let images = [], themes = [], selectedImage = null, uploadedImages = [];
let currentMode = 'exercise';
let selectedCustomImage = null;
let lastSelectedDictItem = null;
let blocksState = [];
let blockIdCounter = 0;
let highestZ = 1;
let justDownloaded = false;

const themeSelect   = document.getElementById('themeSelect');
const searchInput   = document.getElementById('searchInput');
const dictDiv       = document.getElementById('dictionary');
const thumbnailPreview = document.getElementById('thumbnailPreview');
const worksheetEl   = document.getElementById('worksheet');
console.log('[INIT] worksheetEl:', worksheetEl);
const rowsContainer = document.getElementById('rowsContainer');
const rowTpl        = document.getElementById('rowTpl').content;
const addRowBtn     = document.getElementById('addRowBtn');
const exerciseImageMode = document.getElementById('exerciseImageMode');
const customImageMode = document.getElementById('customImageMode');
const exerciseImageSection = document.getElementById('exerciseImageSection');
const customImageSection = document.getElementById('customImageSection');
const customImageThumbnailPreview = document.getElementById('customImageThumbnailPreview');
const customImageStatusText = document.getElementById('customImageStatusText');
const customImageSelectionPreview = document.getElementById('customImageSelectionPreview');
const clearCustomImageSelectionBtn = document.getElementById('clearCustomImageSelectionBtn');
const addSelectedCustomImageBtn = document.getElementById('addSelectedCustomImageBtn');
const pageSizeSelect = document.getElementById('pageSizeSelect');
const customPageSizeInputs = document.getElementById('customPageSizeInputs');
const customWidthInput = document.getElementById('customWidth');
const customHeightInput = document.getElementById('customHeight');
const contextualToolbar = document.getElementById('object-context-toolbar');
const lockBtn = document.getElementById('lockBtn');
const lockIcon = document.getElementById('lockIcon');
const imageUploadInput = document.getElementById('imageUploadInput');
const uploadedImagesPreviewDiv = document.getElementById('uploadedImagesPreview');

// NEW: DOM elements for background and border features
const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');
const backgroundDictionary = document.getElementById('backgroundDictionary');
const backgroundOpacitySlider = document.getElementById('backgroundOpacitySlider');
const borderThemeSelect = document.getElementById('borderThemeSelect');
const borderDictionary = document.getElementById('borderDictionary');
const borderOpacitySlider = document.getElementById('borderOpacitySlider');


// --- Editable Block & Text Box Logic ---
let selectedBlocks = [];
let actionState = {};
let activePopover = null;

function vhToPixels(vh) {
    return Math.round(window.innerHeight * (vh / 100));
}

function onBlockMouseMove(e) {
    e.preventDefault();
    if (actionState.elements && actionState.elements.some(el => el.classList.contains('locked'))) return;
    const { action, elements, startX, startY, initialPositions } = actionState;
    if (!action || !elements || elements.length === 0) return;

    const worksheetTransform = window.getComputedStyle(worksheetEl).transform;
    const matrix = new DOMMatrixReadOnly(worksheetTransform);
    const currentScale = matrix.a;
    const dx = (e.clientX - startX) / currentScale;
    const dy = (e.clientY - startY) / currentScale;

    if (action === 'move') {
        elements.forEach((element, index) => {
            const initialPos = initialPositions[index];
            const newX = initialPos.x + dx;
            const newY = initialPos.y + dy;

            const blockId = parseInt(element.dataset.blockId);
            let state = blocksState.find(s => s.id === blockId);
            if (state) {
                state.x = newX;
                state.y = newY;
            }
            element.style.left = `${newX}px`;
            element.style.top = `${newY}px`;
        });
    } else if (action === 'resize' && elements.length === 1) {
        const element = elements[0];
        const initialWidth = actionState.initialWidth;
        const initialHeight = actionState.initialHeight;
        const newWidth = initialWidth + dx;
        const newHeight = initialHeight + dy;
        const finalWidth = newWidth > 50 ? newWidth : 50;
        const finalHeight = newHeight > 20 ? newHeight : 20;

        const blockId = parseInt(element.dataset.blockId);
        let state = blocksState.find(s => s.id === blockId);
        if (state) {
            state.width = finalWidth;
            state.height = finalHeight;
        }
        element.style.width = `${finalWidth}px`;
        element.style.height = `${finalHeight}px`;
        
        const textBox = element.querySelector('.editable-text-box');
        if (textBox) {
            textBox.dispatchEvent(new Event('input', { bubbles: true }));
        }

        const row = element.querySelector('.row');
        if (row) {
             element.style.setProperty('--row-height-px', `${element.clientHeight}px`);
        }
    }
}

function onBlockMouseUp() {
    actionState = {};
    document.removeEventListener('mousemove', onBlockMouseMove);
    document.removeEventListener('mouseup', onBlockMouseUp);
}

/**
 * FIX: This function has been rewritten to correctly handle event listeners
 * for all block types, including background and border.
 */
function makeBlockEditable(block) {
    const handle = block.querySelector('.resize-handle');

    // Attach MOVE listener directly to the block itself.
    block.addEventListener('mousedown', (e) => {
        // PREVENT MOVE if the target is a resize handle or an editable text box.
        if (e.target.classList.contains('resize-handle') || e.target.isContentEditable) {
            return;
        }
        if (block.classList.contains('locked')) {
            return;
        }
        // Prevent default image drag behavior
        if (e.target.tagName === 'IMG') {
            e.preventDefault();
        }
        e.stopPropagation();

        // If not multi-selecting, clear other selections and select the current block.
        if (!e.shiftKey && !block.classList.contains('selected')) {
             deselectAll();
             selectBlock(block);
        }

        // Set up the state for the move action.
        actionState = {
            action: 'move',
            elements: selectedBlocks,
            startX: e.clientX,
            startY: e.clientY,
            initialPositions: selectedBlocks.map(b => ({ x: b.offsetLeft, y: b.offsetTop }))
        };
        document.addEventListener('mousemove', onBlockMouseMove);
        document.addEventListener('mouseup', onBlockMouseUp);
    });

    // Attach RESIZE listener only to the handle.
    if (handle) {
        handle.addEventListener('mousedown', (e) => {
            if (block.classList.contains('locked')) return;
            e.preventDefault();
            e.stopPropagation();
            actionState = {
                action: 'resize',
                elements: [block],
                startX: e.clientX,
                startY: e.clientY,
                initialWidth: block.clientWidth,
                initialHeight: block.clientHeight
            };
            document.addEventListener('mousemove', onBlockMouseMove);
            document.addEventListener('mouseup', onBlockMouseUp);
        });
    }

    // Attach CLICK listener for selection logic.
    block.addEventListener('click', (e) => {
        // Do not trigger selection change if a resize is happening
        if (actionState.action === 'resize') return;

        e.stopPropagation();
        if (e.shiftKey) {
            toggleBlockSelection(block);
        } else {
            if (!block.classList.contains('selected')) {
                deselectAll();
                selectBlock(block);
            }
        }
        updateContextualToolbar();
    });
}


function selectBlock(block) {
    const box = block.querySelector('.editable-text-box');
    if (!selectedBlocks.includes(block)) {
        selectedBlocks.push(block);
        block.classList.add('selected');
    }
    if (box) updateTextToolState();
}

function deselectBlock(block) {
    const index = selectedBlocks.indexOf(block);
    if (index > -1) {
        selectedBlocks.splice(index, 1);
        block.classList.remove('selected');
    }
    updateTextToolState();
}

function toggleBlockSelection(block) {
    if (selectedBlocks.includes(block)) {
        deselectBlock(block);
    } else {
        selectBlock(block);
    }
}

function makeTextBoxEditable(box) {
    const wrapper = box.parentElement;

    box.addEventListener('dblclick', e => {
        if (wrapper.classList.contains('locked')) return;
        e.stopPropagation();
        box.contentEditable = true;
        box.focus();
        box.style.cursor = 'text';
    });

    // Prevent Enter key from creating new lines
    box.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            box.blur(); // Exit editing mode on Enter
        }
    });

    box.addEventListener('input', () => {
        // Keep height fixed for single-line text
        // Don't auto-adjust height
        const blockId = parseInt(wrapper.dataset.blockId);
        let state = blocksState.find(s => s.id === blockId);
        if (state) {
            state.text = box.innerText;
        }
    });

    box.addEventListener('blur', () => {
        box.contentEditable = false;
        box.style.cursor = 'move';
        const blockId = parseInt(wrapper.dataset.blockId);
        const state = blocksState.find(s => s.id === blockId);
        if (state) {
            state.text = box.innerText;
            state.style = box.style.cssText;
            state.height = wrapper.clientHeight;
        }
    });
}

function addTextToCanvas() {
    const textInput = document.getElementById('textInput');

    // Standardized text box properties
    const textContent = textInput.value.trim() || 'New Text';
    const standardWidth = 250;
    const standardHeight = 60; // Fixed height for single line
    const standardFontSize = 48;
    const standardFontFamily = 'Arial';
    const standardColor = '#333333';

    // Get actual worksheet dimensions
    const worksheetWidth = parseFloat(worksheetEl.style.width) || 612;
    const worksheetHeight = parseFloat(worksheetEl.style.height) || 792;

    // Center the text box on the worksheet
    const initialLeft = (worksheetWidth - standardWidth) / 2;
    const initialTop = (worksheetHeight - standardHeight) / 2;

    // Create text box with standardized properties
    const box = document.createElement('div');
    box.contentEditable = false;
    box.className = 'editable-text-box';
    box.innerText = textContent;
    box.style.fontFamily = standardFontFamily;
    box.style.fontSize = `${standardFontSize}px`;
    box.style.color = standardColor;
    box.style.lineHeight = '1.2';
    box.style.whiteSpace = 'nowrap'; // Prevent text wrapping
    box.style.overflow = 'hidden'; // Hide overflow text
    box.style.textOverflow = 'ellipsis'; // Show ellipsis for long text

    const state = {
        id: blockIdCounter++,
        type: 'text',
        x: initialLeft,
        y: initialTop,
        width: standardWidth,
        height: standardHeight,
        zIndex: highestZ++,
        locked: false,
        text: box.innerText,
        style: box.style.cssText
    };
    blocksState.push(state);

    const block = createBlockFromState(state);
    worksheetEl.appendChild(block);

    // Update the form fields to reflect standard values
    document.getElementById('fontSize').value = standardFontSize;
    document.getElementById('fontFamily').value = standardFontFamily;
    document.getElementById('textColor').value = standardColor;

    const newBox = block.querySelector('.editable-text-box');
    if(newBox) {
        newBox.dispatchEvent(new Event('input', { bubbles: true }));
    }

    deselectAll();
    selectBlock(block);
    updateContextualToolbar();
}

function updateTextToolState() {
    const selectedTextBox = selectedBlocks.length === 1 ? selectedBlocks[0].querySelector('.editable-text-box') : null;
    const isDisabled = !selectedTextBox;
    const controls = ['textColor', 'fontSize', 'fontFamily', 'textStrokeColor', 'textStrokeWidth'];
    controls.forEach(id => document.getElementById(id).disabled = isDisabled);

    const deleteBtn = document.getElementById('toolbarDeleteSelectedTextBtn');
    if (deleteBtn) {
        deleteBtn.style.display = isDisabled ? 'none' : 'block';
    }

    if (selectedTextBox) {
        document.getElementById('textColor').value = rgbToHex(selectedTextBox.style.color) || '#333333';
        document.getElementById('fontSize').value = parseInt(selectedTextBox.style.fontSize, 10) || 48;
        document.getElementById('fontFamily').value = selectedTextBox.style.fontFamily.replace(/"/g, '').replace(/, sans-serif/g, '') || 'Quicksand';
        const stroke = selectedTextBox.style.webkitTextStroke.split(' ');
        document.getElementById('textStrokeWidth').value = parseFloat(stroke[0]) || 0;
        document.getElementById('textStrokeColor').value = rgbToHex(stroke[1]) || '#000000';
    }
}
function rgbToHex(rgb) {
    if (!rgb || !rgb.startsWith('rgb')) return rgb || '#000000';
    let sep = rgb.indexOf(",") > -1 ? "," : " ";
    rgb = rgb.substr(4).split(")")[0].split(sep);
    let r = (+rgb[0]).toString(16).padStart(2, '0');
    let g = (+rgb[1]).toString(16).padStart(2, '0');
    let b = (+rgb[2]).toString(16).padStart(2, '0');
    return "#" + r + g + b;
}
function updateSelectedText(event) {
    if (selectedBlocks.length !== 1) return;
    const selectedTextBox = selectedBlocks[0].querySelector('.editable-text-box');
    if (!selectedTextBox) return;

    const prop = event.target.id;
    const val = event.target.value;

    switch (prop) {
        case 'textColor': selectedTextBox.style.color = val; break;
        case 'fontSize': 
            selectedTextBox.style.fontSize = `${val}px`; 
            selectedTextBox.dispatchEvent(new Event('input', { bubbles: true }));
            break;
        case 'fontFamily': 
            selectedTextBox.style.fontFamily = val; 
            selectedTextBox.dispatchEvent(new Event('input', { bubbles: true }));
            break;
        case 'textStrokeColor':
        case 'textStrokeWidth':
            const width = document.getElementById('textStrokeWidth').value;
            const color = document.getElementById('textStrokeColor').value;
            selectedTextBox.style.webkitTextStroke = `${width}px ${color}`;
            break;
    }
     const parentBlock = selectedTextBox.closest('.editable-block');
     const blockId = parseInt(parentBlock.dataset.blockId);
     let state = blocksState.find(s => s.id === blockId);
     if (state) state.style = selectedTextBox.style.cssText;
}

function deleteSelectedTextBox() {
    if (selectedBlocks.length === 1 && selectedBlocks[0].querySelector('.editable-text-box')) {
        deleteSelectedBlocks();
    }
}

function deselectAll() {
    [...document.querySelectorAll('.editable-text-box')].forEach(box => {
        if(box.isContentEditable) box.blur();
    });
    [...selectedBlocks].forEach(b => deselectBlock(b));
    updateContextualToolbar();
}

worksheetEl.addEventListener('click', (e) => {
    if (e.target === worksheetEl) {
        deselectAll();
    }
});

document.addEventListener('keydown', (e) => {
    if (selectedBlocks.length === 0) return;
    if (e.key === 'Delete' || e.key === 'Backspace') {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && !e.target.isContentEditable) {
             e.preventDefault();
             deleteSelectedBlocks();
        }
    }
});

function showImageFeedback() {
  const existingImageState = blocksState.find(b => b.type === 'exerciseImage');
  if (existingImageState) {
      blocksState = blocksState.filter(b => b.type !== 'exerciseImage');
  }

  const img = document.createElement('img');
  img.src = selectedImage.path;
  img.onload = () => {
    const topOffset = 20;
    const currentHeight = worksheetEl.clientHeight * 0.29575;
    const currentWidth = (img.width / img.height) * currentHeight;
    const state = {
        id: blockIdCounter++,
        type: 'exerciseImage',
        src: selectedImage.path,
        alt: selectedImage.word,
        x: (worksheetEl.clientWidth - currentWidth) / 2,
        y: topOffset,
        width: currentWidth, height: currentHeight,
        zIndex: highestZ++,
        locked: false
    };
    blocksState.push(state);
    renderWorksheet();
  };

  document.getElementById('imageFeedback').style.display = 'block';
  document.getElementById('imagePrompt').style.display = 'none';
  thumbnailPreview.src = selectedImage.path;
  document.getElementById('imageStatusText').textContent = `Selected: ${selectedImage.word}`;
}
function unselectImage() {
  selectedImage = null;
  blocksState = blocksState.filter(b => b.type !== 'exerciseImage');
  renderWorksheet();
  document.getElementById('imageFeedback').style.display = 'none';
  document.getElementById('imagePrompt').style.display = 'block';
}

function clearCustomImageSelection() {
    selectedCustomImage = null;
    customImageSelectionPreview.style.display = 'none';
    addSelectedCustomImageBtn.disabled = true;
    if (lastSelectedDictItem) {
        lastSelectedDictItem.style.backgroundColor = '';
        lastSelectedDictItem = null;
    }
}

function addSelectedCustomImageToWorksheet() {
    if (!selectedCustomImage) return;
    const img = new Image();
    const imageToAdd = { ...selectedCustomImage };
    img.src = imageToAdd.path;

    img.onload = () => {
        const state = {
            id: blockIdCounter++,
            type: 'customImage',
            x: 100, y: 100,
            width: 150,
            height: (img.height / img.width) * 150,
            zIndex: highestZ++,
            locked: false,
            src: img.src,
            alt: imageToAdd.word
        };
        blocksState.push(state);
        renderWorksheet();
        const block = worksheetEl.querySelector(`.editable-block[data-block-id="${state.id}"]`);
        if (block) {
            deselectAll();
            selectBlock(block);
            updateContextualToolbar();
        }
        clearCustomImageSelection();
    };
}

function addNewRowControl() {
    const defaultRowHeight = vhToPixels(4.48);
    const worksheetWidth = worksheetEl.clientWidth;
    const worksheetHeight = worksheetEl.clientHeight;
    const rowWidth = worksheetWidth * 0.9;

    // Calculate center position for the new row
    const centerX = (worksheetWidth - rowWidth) / 2;
    const centerY = (worksheetHeight - defaultRowHeight) / 2;

    const state = {
        id: blockIdCounter++,
        type: 'row',
        x: centerX,
        y: centerY,
        width: rowWidth,
        height: defaultRowHeight,
        zIndex: highestZ++,
        locked: false,
        rowConfig: {
            mode: 'trace',
            fontStyle: 'print/regular',
            content: 'empty',
            case: 'lowercase',
            strokeType: 'vertical',
            customText: '',
            letterCount: null,
            strokeCount: null
        }
    };
    blocksState.push(state);
    renderWorksheet();

    setTimeout(() => {
        const newBlock = worksheetEl.querySelector(`.editable-block[data-block-id="${state.id}"]`);
        if (newBlock) {
             deselectAll();
             selectBlock(newBlock);
             updateContextualToolbar();
        }
    }, 0);
}

function deleteRow(blockId) {
    blocksState = blocksState.filter(b => b.id !== blockId);
    renderWorksheet();
}

function setExclusiveAccordion(activeHeader) {
    const parentContainer = document.querySelector('.panel-content');
    parentContainer.querySelectorAll('.accordion-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.nextElementSibling) btn.nextElementSibling.style.display = 'none';
    });
    if (activeHeader) {
        activeHeader.classList.add('active');
        if (activeHeader.nextElementSibling) activeHeader.nextElementSibling.style.display = 'flex';
    }
}

function setupAccordion(headerElement) {
    headerElement.addEventListener('click', () => {
        const isActive = headerElement.classList.contains('active');
        setExclusiveAccordion(isActive ? null : headerElement);
    });
}

function renderRowControls() {
    const openAccordionHeaders = [...document.querySelectorAll('#rowsContainer .accordion-button.active')];

    rowsContainer.innerHTML = '';
    const rowStates = blocksState.filter(b => b.type === 'row');
    rowStates.sort((a,b) => a.y - b.y);

    rowStates.forEach((state, index) => {
        const fragment = rowTpl.cloneNode(true);
        const newAccordion = fragment.querySelector('.accordion-item');
        const header = newAccordion.querySelector('.accordion-button');
        const panel = newAccordion.querySelector('.accordion-content');

        newAccordion.dataset.stateId = state.id;
        header.textContent = formatTranslation(t('row.title'), { number: index + 1 });

        const wasOpen = openAccordionHeaders.some(h => h.parentElement.dataset.stateId === String(state.id));
        if (wasOpen) {
            header.classList.add('active');
            panel.style.display = 'flex';
        }

        const modeSel = newAccordion.querySelector('.mode');
        const fontStyleSel = newAccordion.querySelector('.font-style');
        const contentSel = newAccordion.querySelector('.content');
        const caseSel = newAccordion.querySelector('.case');
        const strokeSel = newAccordion.querySelector('.stroke-type');
        const customInput = newAccordion.querySelector('.custom-text-input');
        const caseOptions = newAccordion.querySelector('.case-options');
        const strokeOptions = newAccordion.querySelector('.stroke-options');

        modeSel.value = state.rowConfig.mode;
        fontStyleSel.value = state.rowConfig.fontStyle;
        contentSel.value = state.rowConfig.content;
        caseSel.value = state.rowConfig.case;
        strokeSel.value = state.rowConfig.strokeType;
        customInput.value = state.rowConfig.customText;

        const updateRowState = () => {
            state.rowConfig.mode = modeSel.value;
            state.rowConfig.fontStyle = fontStyleSel.value;
            state.rowConfig.content = contentSel.value;
            state.rowConfig.case = caseSel.value;
            state.rowConfig.strokeType = strokeSel.value;
            state.rowConfig.customText = customInput.value;
            
            if (contentSel.value !== 'beginning') {
                state.rowConfig.letterCount = null;
            }
            if (contentSel.value !== 'pre-writing') {
                state.rowConfig.strokeCount = null;
            }

            customInput.style.display = contentSel.value === 'custom' ? 'block' : 'none';
            strokeOptions.style.display = contentSel.value === 'pre-writing' ? 'block' : 'none';
            caseOptions.style.display = contentSel.value !== 'pre-writing' ? 'block' : 'none';

            renderWorksheet({ preserveControls: true });
        };

        [modeSel, fontStyleSel, contentSel, caseSel, strokeSel, customInput].forEach(el => {
            el.addEventListener('input', updateRowState);
        });

        newAccordion.querySelector('.delete-row-btn').onclick = () => deleteRow(state.id);

        customInput.style.display = contentSel.value === 'custom' ? 'block' : 'none';
        strokeOptions.style.display = contentSel.value === 'pre-writing' ? 'block' : 'none';
        caseOptions.style.display = contentSel.value !== 'pre-writing' ? 'block' : 'none';

        rowsContainer.appendChild(newAccordion);
    });

    // Apply translations to all newly added row controls
    applyTranslations();

    document.querySelectorAll('#rowsContainer .accordion-button').forEach(btn => setupAccordion(btn.parentElement.querySelector('.accordion-button')));
}


// Get locale from URL parameter or default to 'en'
const urlParams = new URLSearchParams(window.location.search);
const currentLocale = urlParams.get('locale') || 'en';
window.currentLocale = currentLocale;

// IMPORTANT: Writing app image library should ALWAYS use English locale
// This is an English writing practice app, so image file names should be in English
const imageLibraryLocale = 'en';

fetch(`/api/themes-translated?locale=${imageLibraryLocale}`)
    .then(r=>r.json())
    .then(themes => {
    themeSelect.innerHTML = '';
    const allThemesOption = new Option(t('library.allThemes'),'all');
    themeSelect.add(allThemesOption);
    themes.forEach(theme => {
        const opt = document.createElement("option");
        opt.value = theme.value;
        opt.textContent = theme.displayName;
        themeSelect.appendChild(opt);
    });
    loadDictionary();
})
.catch(err => {
    console.error('Failed to load themes:', err);
    // Continue anyway - worksheet should still work without themes
});
themeSelect.onchange = loadDictionary;
searchInput.oninput = loadDictionary;
addRowBtn.onclick = addNewRowControl;
pageSizeSelect.onchange = updateWorksheetPageSize;
customWidthInput.oninput = updateWorksheetPageSize;
customHeightInput.oninput = updateWorksheetPageSize;

exerciseImageMode.addEventListener('change', updateUIMode);
customImageMode.addEventListener('change', updateUIMode);

function updateUIMode() {
    currentMode = document.querySelector('input[name="imageMode"]:checked').value;
    if (currentMode === 'exercise') {
        exerciseImageSection.style.display = 'block';
        customImageSection.style.display = 'none';
        clearCustomImageSelection();
    } else if (currentMode === 'custom') {
        exerciseImageSection.style.display = 'none';
        customImageSection.style.display = 'block';
    }
    loadDictionary();
}

function loadDictionary(){
  const theme = themeSelect.value;
  const q = searchInput.value.trim().toLowerCase();
  let allImages = [];

  const addImagesToDisplay = (imgs) => {
    imgs.forEach(({word, path}) => {
        if (!allImages.some(img => img.path === path)) {
            allImages.push({ word, path });
        }
    });
  };

  if (currentMode === 'custom') {
      addImagesToDisplay(uploadedImages);
  }

  let fetchPromise;
  if (q) {
      // Always use English locale for image library
      fetchPromise = fetch(`/api/images?search=${q}&locale=${imageLibraryLocale}`).then(r => r.json()).then(data => data.images || data);
  } else if (theme !== 'all') {
      // Always use English locale for image library
      fetchPromise = fetch(`/api/images?theme=${theme}&locale=${imageLibraryLocale}`).then(r => r.json()).then(data => data.images || data);
  } else {
      fetchPromise = Promise.resolve([]);
  }

  fetchPromise.then(imgs => {
      addImagesToDisplay(imgs);
      dictDiv.innerHTML = '';
      allImages.sort((a,b) => a.word.localeCompare(b.word)).forEach(({word,path})=> {
          const d = document.createElement('div');
          d.className = 'dictionary-item';
          d.innerHTML = `<img src=\"${path}\" draggable="false"> <span>${word}</span>`;
          d.onmouseover = () => { if (lastSelectedDictItem !== d) d.style.backgroundColor = 'rgba(255,255,255,0.05)'; };
          d.onmouseout = () => { if (lastSelectedDictItem !== d) d.style.backgroundColor = ''; };
          d.onclick = () => {
              if (lastSelectedDictItem) lastSelectedDictItem.style.backgroundColor = '';
              lastSelectedDictItem = d;
              d.style.backgroundColor = 'rgba(0,122,255,0.15)';
              if (currentMode === 'exercise') {
                  selectedImage = {word,path};
                  showImageFeedback();
                  clearCustomImageSelection();
              } else if (currentMode === 'custom') {
                  selectedCustomImage = {word, path};
                  customImageThumbnailPreview.src = path;
                  customImageStatusText.textContent = `Selected: ${word}`;
                  customImageSelectionPreview.style.display = 'block';
                  addSelectedCustomImageBtn.disabled = false;
              }
          };
          dictDiv.appendChild(d);
        });
        if (dictDiv.innerHTML === '') {
             dictDiv.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${t('message.noImages')}</div>`;
        }
    }).catch(e => console.error(e));
}

// NEW: Functions to load asset themes and images (copied from more less.html, adapted for writing.html)
function loadAssetThemes(type, selectEl) {
    // Always use English locale for borders and backgrounds
    fetch(`/api/${type}/themes?locale=${imageLibraryLocale}`)
        .then(response => response.json())
        .then(themes => {
            selectEl.innerHTML = `<option value="none">${t('none')}</option>`;
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.value;
                option.textContent = theme.displayName;
                selectEl.appendChild(option);
            });
        })
        .catch(err => {
            console.error(formatTranslation(t('message.themeLoadError'), { type: type }), err);
            selectEl.innerHTML = `<option value="none">${t('none')}</option>`;
        });
}

function loadAssetImages(type, theme, dictionaryEl, addFunc) {
    const assetName = type.slice(0, -1); // 'border' or 'background'
    if (theme === 'none') {
        dictionaryEl.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${t('message.selectTheme')}</div>`;
        // Remove existing asset from blocksState
        blocksState = blocksState.filter(s => s.type !== assetName);
        renderWorksheet();
        // Disable opacity slider
        if (type === 'borders') borderOpacitySlider.disabled = true;
        if (type === 'backgrounds') backgroundOpacitySlider.disabled = true;
        return;
    }
    dictionaryEl.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${t('message.loading')}</div>`;
    // Always use English locale for image library
    fetch(`/api/${type}/images?theme=${theme}&locale=${imageLibraryLocale}`)
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
            const images = data.images || data; // Handle both API response formats
            dictionaryEl.innerHTML = images.length === 0 ? `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">No ${type} in this theme.</div>` : "";
            images.forEach(asset => {
                const item = document.createElement("div");
                item.className = "border-thumbnail-item"; // Reusing class, but it applies to backgrounds too
                item.innerHTML = `<img src="${asset.path}" alt="${asset.name}" loading="lazy" />`;
                item.onclick = () => {
                    addFunc(asset.path);
                    dictionaryEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                    item.classList.add('selected');
                };
                dictionaryEl.appendChild(item);
            });
        }).catch(() => dictionaryEl.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${formatTranslation(t('message.loadError'), { type: type })}</div>`);
}

// NEW: Functions to add border and background to worksheet (adapted for DOM)
function addBorderToCanvas(path) {
    blocksState = blocksState.filter(s => s.type !== 'border');

    // Load image to get natural dimensions for aspect ratio
    const img = new Image();
    img.onload = () => {
        // Scale to 70% of page height while preserving aspect ratio
        const targetHeight = worksheetEl.clientHeight * 0.7;
        const aspectRatio = img.width / img.height;
        const targetWidth = targetHeight * aspectRatio;

        const state = {
            id: blockIdCounter++,
            type: 'border',
            src: path,
            x: (worksheetEl.clientWidth - targetWidth) / 2,
            y: (worksheetEl.clientHeight - targetHeight) / 2,
            width: targetWidth,
            height: targetHeight,
            zIndex: highestZ++,
            locked: false,
            opacity: parseFloat(borderOpacitySlider.value)
        };
        blocksState.push(state);
        renderWorksheet();
        borderOpacitySlider.disabled = false;
    };
    img.src = path;
}

function addBackgroundToCanvas(path) {
    blocksState = blocksState.filter(s => s.type !== 'background');

    // Load image to get natural dimensions for aspect ratio
    const img = new Image();
    img.onload = () => {
        // Scale to 70% of page height while preserving aspect ratio
        const targetHeight = worksheetEl.clientHeight * 0.7;
        const aspectRatio = img.width / img.height;
        const targetWidth = targetHeight * aspectRatio;

        const state = {
            id: blockIdCounter++,
            type: 'background',
            src: path,
            x: (worksheetEl.clientWidth - targetWidth) / 2,
            y: (worksheetEl.clientHeight - targetHeight) / 2,
            width: targetWidth,
            height: targetHeight,
            zIndex: highestZ++,
            locked: false,
            opacity: parseFloat(backgroundOpacitySlider.value)
        };
        blocksState.push(state);
        renderWorksheet();
        backgroundOpacitySlider.disabled = false;
    };
    img.src = path;
}

// NEW: Function to apply opacity (adapted for DOM)
function applyOpacity(slider, type) {
    const opacity = parseFloat(slider.value);
    const targetBlock = blocksState.find(s => s.type === type);
    if (targetBlock) {
        targetBlock.opacity = opacity;
        renderWorksheet(); // Re-render to apply new opacity
    }
}


function createStrokeSvg(strokeType) {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 100 100");
    svg.style.height = (strokeType === 'horizontal') ? '80%' : '100%';
    svg.style.width = '80px';
    const path = document.createElementNS(svgNS, "path");
    let d = "";
    switch (strokeType) {
        case 'vertical': d = "M 50 5 L 50 95"; break;
        case 'horizontal': d = "M 10 50 L 90 50"; break;
        case 'circle': d = "M 50, 5 A 45,45 0 1,1 49.9, 5 Z"; break;
        case 'zigzag': d = "M 10 95 L 30 5 L 50 95 L 70 5 L 90 95"; break;
    }
    path.setAttribute("d", d);
    path.setAttribute("stroke", "#888");
    path.setAttribute("stroke-width", "4");
    path.setAttribute("stroke-linecap", "round");
    path.setAttribute("stroke-linejoin", "round");
    path.setAttribute("fill", "none");
    path.style.strokeDasharray = "12, 60"; // Significantly increased gap between dashes for better proportion
    svg.appendChild(path);
    return svg;
}

function updateWorksheetPageSize() {
    const selectedSize = pageSizeSelect.value;
    let widthPx, heightPx;
    customPageSizeInputs.style.display = 'none';
    const inchesToPx = (inches) => inches * 96;
    const mmToPx = (mm) => mm * 96 / 25.4;

    if (selectedSize === 'a4') {
        widthPx = mmToPx(210); heightPx = mmToPx(297);
    } else if (selectedSize === 'a4-landscape') {
        widthPx = mmToPx(297); heightPx = mmToPx(210);
    } else if (selectedSize === 'letter-landscape') {
        widthPx = inchesToPx(11); heightPx = inchesToPx(8.5);
    } else if (selectedSize === 'custom') {
        customPageSizeInputs.style.display = 'flex';
        widthPx = parseFloat(customWidthInput.value) || inchesToPx(8.5);
        heightPx = parseFloat(customHeightInput.value) || inchesToPx(11);
    } else {
        widthPx = inchesToPx(8.5); heightPx = inchesToPx(11);
    }
    worksheetEl.style.width = `${widthPx}px`;
    worksheetEl.style.height = `${heightPx}px`;

    console.log('[Writing App] Worksheet size set to:', widthPx, 'x', heightPx);
    console.log('[Writing App] worksheetEl actual computed size:', worksheetEl.offsetWidth, 'x', worksheetEl.offsetHeight);

    // Update display scaling to match standard from other apps
    updateWorksheetDisplayScaling(widthPx, heightPx);

    renderWorksheet();
}

// Function to update worksheet display scaling - matches standard from Fabric.js apps
function updateWorksheetDisplayScaling(width, height) {
    // Get available space in the content wrapper
    const contentWrapper = document.querySelector('.tab-content-wrapper');
    const wrapperStyle = getComputedStyle(contentWrapper);
    const availableWidth = parseFloat(wrapperStyle.width) - parseFloat(wrapperStyle.paddingLeft) - parseFloat(wrapperStyle.paddingRight) - 10;
    const availableHeight = parseFloat(wrapperStyle.height) - parseFloat(wrapperStyle.paddingTop) - parseFloat(wrapperStyle.paddingBottom) - 10;

    // Based on user feedback:
    // - 1.25 was 15% too big
    // - 0.75 was too small
    // - Correct scale is approximately 1.087 (1.25 / 1.15)

    const isLandscape = width > height;

    // Match the exact visual appearance of other apps
    const baseScale = 1.087; // Empirically determined to match other apps
    const landscapeBonus = isLandscape ? 1.25 : 1.0; // Additional scaling for landscape
    const displayScale = baseScale * landscapeBonus;

    // Calculate scaled dimensions
    const scaledWidth = width * displayScale;
    const scaledHeight = height * displayScale;

    // Ensure it fits in available space
    const scaleRatio = Math.min(availableWidth / scaledWidth, availableHeight / scaledHeight, 1);

    // Apply the final scale
    const finalScale = displayScale * scaleRatio;
    worksheetEl.style.transform = `scale(${finalScale})`;

    console.log('[Writing App] Worksheet scaled to:', finalScale, 'Available space:', availableWidth, 'x', availableHeight);
}

function renderWorksheet(options = {}){
  const { preserveControls = false } = options;
  const selectedIds = selectedBlocks.map(b => b.dataset.blockId);

  if (justDownloaded) {
      blocksState.forEach(state => {
          if (state.type === 'row' && state.rowConfig.mode === 'fill') {
              state.width += 20;
          }
      });
  }

  worksheetEl.innerHTML = ''; // Clear existing content

  blocksState.sort((a, b) => a.zIndex - b.zIndex).forEach(state => {
      const block = createBlockFromState(state);
      if (block) {
          worksheetEl.appendChild(block);
           if (block.classList.contains('text-block-wrapper')) {
                const textBox = block.querySelector('.editable-text-box');
                if (textBox) {
                    textBox.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
      }
  });

  selectedBlocks = [];
  selectedIds.forEach(id => {
      const newBlock = worksheetEl.querySelector(`.editable-block[data-block-id="${id}"]`);
      if (newBlock) {
          selectBlock(newBlock);
      }
  });
  updateContextualToolbar();

  if (!preserveControls) {
      renderRowControls();
  }
}

function createBlockFromState(state) {
    const block = document.createElement('div');
    block.className = 'editable-block';
    block.dataset.blockId = state.id;
    block.style.left = `${state.x}px`;
    block.style.top = `${state.y}px`;
    block.style.width = `${state.width}px`;
    block.style.height = `${state.height}px`;
    block.style.zIndex = state.zIndex;
    if (state.locked) block.classList.add('locked');
    if (selectedBlocks.some(b => b.dataset.blockId === String(state.id))) {
        block.classList.add('selected');
    }

    let contentElement;
    let attachResizeHandle = true;

    switch (state.type) {
        case 'exerciseImage':
        case 'customImage':
            block.classList.add(state.type === 'customImage' ? 'custom-image-block' : 'exercise-image-block');
            contentElement = document.createElement('img');
            contentElement.src = state.src;
            contentElement.alt = state.alt;
            contentElement.draggable = false;
            block.appendChild(contentElement);
            break;

        case 'text':
            block.classList.add('text-block-wrapper');
            contentElement = document.createElement('div');
            contentElement.className = 'editable-text-box';
            contentElement.style.cssText = state.style;
            contentElement.innerText = state.text;
            // Ensure single-line properties are maintained
            contentElement.style.whiteSpace = 'nowrap';
            contentElement.style.overflow = 'hidden';
            contentElement.style.textOverflow = 'ellipsis';
            block.appendChild(contentElement);
            makeTextBoxEditable(contentElement);
            break;

        case 'row':
            block.classList.add('row-block');
            block.style.setProperty('--row-height-px', `${state.height}px`);
            contentElement = createRowFromState(state);
            block.appendChild(contentElement);
            break;

        case 'background':
            block.classList.add('background-block');
            block.style.backgroundImage = `url('${state.src}')`;
            block.style.backgroundSize = 'cover';
            block.style.backgroundPosition = 'center';
            block.style.opacity = state.opacity;
            break;

        case 'border':
            block.classList.add('border-block');
            block.style.backgroundImage = `url('${state.src}')`;
            block.style.backgroundSize = '100% 100%';
            block.style.backgroundRepeat = 'no-repeat';
            block.style.backgroundPosition = 'center';
            block.style.opacity = state.opacity;
            break;
    }

    if (attachResizeHandle) {
        const handle = document.createElement('div');
        handle.className = 'resize-handle resize-handle-se';
        block.appendChild(handle);
    }
    makeBlockEditable(block);
    return block;
}

function createRowFromState(state) {
    const { rowConfig } = state;
    const { mode, content, case: casing, strokeType, customText, letterCount, strokeCount, fontStyle } = rowConfig;
    const row = document.createElement('div');
    row.className = `row ${mode}`;
    row.setAttribute('data-content', content);
    row.setAttribute('data-casing', casing);

    const g = document.createElement('div');
    g.className = 'guide';
    g.innerHTML = `<div class="line-top"></div><div class="line-middle"></div><div class="line-bottom"></div>`;
    row.append(g);

    if (content === 'empty') return row;

    if (content === 'pre-writing') {
        row.className = 'row trace';
        const lettersDiv = document.createElement('div');
        lettersDiv.className = 'letters';
        lettersDiv.style.gap = '36px';
        
        let strokeRenderCount;
        if (typeof strokeCount === 'number') {
            strokeRenderCount = strokeCount;
        } else {
            const blockWidth = state.width;
            const strokeWidth = 80;
            const gap = 36;
            const padding = 8;
            const availableWidth = blockWidth - padding;
            strokeRenderCount = Math.floor((availableWidth + gap) / (strokeWidth + gap));
        }

        for(let i = 0; i < strokeRenderCount; i++) {
            lettersDiv.append(createStrokeSvg(strokeType));
        }
        row.append(lettersDiv);
        return row;
    }

    let base = 'Sample';
    if(content === 'custom') {
        base = customText || 'Custom Text';
    } else if (selectedImage && (content === 'beginning' || content === 'filename')){
        base = content === 'beginning' ? selectedImage.word[0] : selectedImage.word;
    } else if (content === 'beginning'){
        base = 'A';
    }

    if (content !== 'custom') {
        if(casing === 'uppercase') base = base.toUpperCase();
        else if(casing === 'lowercase') base = base.toLowerCase();
        else if (casing === 'title') base = base.charAt(0).toUpperCase() + base.slice(1).toLowerCase();
    }

    const createLetterImg = (ch, fontStyle) => {
        const isUpper = ch === ch.toUpperCase() && ch !== ch.toLowerCase();
        const isNumber = /[0-9]/.test(ch);
        const punctuationMap = {
            '.': 'fullstop', ',': 'comma', '?': 'question mark', '!': 'exclamation mark',
            ':': 'colon', ';': 'semicolon', '-': 'minus', '+': 'plus', '=': 'equal',
            '/': 'slash', '(': 'left parentheses', ')': 'right parentheses'
        };
        const isPunctuation = punctuationMap.hasOwnProperty(ch);
        const currentFontStyle = fontStyle || 'print/regular';
        const fontClass = 'font-' + currentFontStyle.replace(/\//g, '-').replace(/ /g, '-');

        const fontsWithoutPunctuation = ['print/regular', 'print/regular arrow', 'print/tracing arrow'];
        if (isPunctuation && fontsWithoutPunctuation.includes(currentFontStyle)) {
            const puncSpan = document.createElement('span');
            puncSpan.className = 'punctuation-fill';
            puncSpan.classList.add(fontClass);
            puncSpan.textContent = ch;
            return puncSpan;
        }

        let svgCase;
        let safeChar = encodeURIComponent(ch);

        if (isPunctuation) {
            svgCase = 'punctuation and symbols';
            safeChar = encodeURIComponent(punctuationMap[ch]);
        } else if (isNumber) {
            svgCase = 'numbers';
        } else {
            svgCase = isUpper ? 'uppercase' : 'lowercase';
        }
        
        const img = document.createElement('img');
        img.src = `/images/alphabetsvg/${currentFontStyle}/${svgCase}/${safeChar}.svg?v=${Date.now()}`;
        img.alt = ch;
        img.classList.add(fontClass);

        if (currentFontStyle.includes('tracing')) {
            img.style.filter = 'grayscale(100%) brightness(0) contrast(100%) drop-shadow(0 0 0.1px black)';
        }

        if (svgCase === 'lowercase') {
            img.classList.add('lowercase');
            if (['d','f','g','h','i','j','k','l','p','q','t','y'].includes(ch.toLowerCase())) {
                img.classList.add('larger');
            }
        }
        return img;
    };

    if (mode === 'trace' || mode === 'fading-trace' || mode === 'guided-copy') {
        const lettersDiv = document.createElement('div');
        lettersDiv.className = 'letters';
        lettersDiv.style.alignItems = 'center';
        
        if (fontStyle === 'cursive') {
            lettersDiv.style.fontFamily = `'Great Vibes', cursive`;
            lettersDiv.classList.add('cursive-font');
            lettersDiv.style.gap = '0';
            lettersDiv.style.alignItems = 'flex-end';
            lettersDiv.style.whiteSpace = 'nowrap';

            if (fontStyle.includes('tracing')) {
                lettersDiv.classList.add('tracing');
            }

            let textToRender = '';
            if (content === 'custom' || content === 'filename') {
                textToRender = base;
            } else if (content === 'beginning') {
                const repeatCount = mode === 'guided-copy' ? 4 : 6;
                textToRender = base[0].repeat(repeatCount);
            }
            
            if (mode === 'guided-copy' && content !== 'beginning') {
                 const firstWord = base.split(' ')[0];
                 const firstPart = document.createElement('span');
                 firstPart.textContent = base;
                 const secondPart = document.createElement('span');
                 secondPart.textContent = base;
                 secondPart.style.opacity = '0.4';
                 lettersDiv.append(firstPart, secondPart);
            } else if (content === 'beginning') {
                 // Wrap each character in a span for flex distribution
                 for (let char of textToRender) {
                     const charSpan = document.createElement('span');
                     charSpan.textContent = char;
                     lettersDiv.appendChild(charSpan);
                 }
            } else {
                 lettersDiv.textContent = textToRender;
            }
           
            if (mode === 'fading-trace') {
                lettersDiv.classList.add('fading-trace-font');
            }

        } else {
            lettersDiv.style.fontFamily = `'Lexend Deca', sans-serif`;
            lettersDiv.classList.add('lexend-deca-font');
            if (content === 'filename' || content === 'custom') {
                lettersDiv.style.gap = '8.5px';
            } else {
                lettersDiv.style.gap = 'auto';
            }

            let itemsToRender = [];
            if (content === 'custom' || content === 'filename') {
                itemsToRender = Array.from(base);
            } else if (content === 'beginning') {
                if (!/[a-zA-Z]/.test(base[0])) {
                    itemsToRender = [base[0]];
                } else {
                    let count = (mode === 'guided-copy') ? 4 : 6;
                    let charToTrace = base[0];
                    const wideCharsLower = ['w', 'm'], narrowCharsLower = ['i', 'l', 'j', 't', 'f'];
                    const wideCharsUpper = ['W', 'M'], narrowCharsUpper = ['I', 'J', 'L', 'T', 'F'];
                    if (casing === 'lowercase' && wideCharsLower.includes(charToTrace.toLowerCase())) count = Math.max(1, count - 2);
                    else if (casing === 'lowercase' && narrowCharsLower.includes(charToTrace.toLowerCase())) count = Math.min(8, count + 1);
                    else if (casing === 'uppercase' && wideCharsUpper.includes(charToTrace.toUpperCase())) count = Math.max(1, count - 2);
                    else if (casing === 'uppercase' && narrowCharsUpper.includes(charToTrace.toUpperCase())) count = Math.min(8, count + 1);
                    itemsToRender = Array(count).fill(base[0]);
                }
            }

            const fadeSteps = itemsToRender.length > 1 ? itemsToRender.length - 1 : 1;
            const punctuationMap = {
                '.': 'fullstop', ',': 'comma', '?': 'question mark', '!': 'exclamation mark',
                ':': 'colon', ';': 'semicolon', '-': 'minus', '+': 'plus', '=': 'equal',
                '/': 'slash', '(': 'left parentheses', ')': 'right parentheses'
            };

            const renderSet = (set, opacity = 1) => {
                set.forEach((ch, i) => {
                    if(ch === ' ') {
                        const space = document.createElement('div');
                        space.style.width = '1.5vh';
                        space.style.display = 'inline-block';
                        lettersDiv.append(space);
                    } else if (/[a-zA-Z0-9]/.test(ch) || punctuationMap.hasOwnProperty(ch)) {
                        const letterEl = createLetterImg(ch, fontStyle);
                        if (mode === 'fading-trace') {
                            letterEl.style.opacity = 1 - (i * (0.8 / fadeSteps));
                        } else {
                            letterEl.style.opacity = opacity;
                        }
                        lettersDiv.append(letterEl);
                    } else {
                        const punc = document.createElement('span');
                        punc.className = 'punctuation-fill';
                        punc.textContent = ch;
                        lettersDiv.append(punc);
                    }
                });
            };

            if (mode === 'guided-copy') {
                const setsToRender = (content === 'beginning') ? itemsToRender.map(item => [item]) : [Array.from(base)];
                const copyCount = (content === 'beginning') ? 4 : 2;
                
                for (let i=0; i < copyCount; i++) {
                    setsToRender.forEach(set => {
                        renderSet(set, i === 0 ? 1 : 0.4);
                        const space = document.createElement('div');
                        space.style.width = '1.5vh';
                        space.style.display = 'inline-block';
                        lettersDiv.append(space);
                    });
                }
            } else {
                 renderSet(itemsToRender);
            }
        }
        row.append(lettersDiv);

    } else if (mode === 'fill') {
        const textLine = document.createElement('div');
        textLine.className = 'text-line';
        
        if (fontStyle === 'cursive') {
             textLine.style.fontFamily = `'Great Vibes', cursive`;
             textLine.classList.add('cursive-font');
        } else {
             textLine.style.fontFamily = `'Lexend Deca', sans-serif`;
             textLine.classList.add('lexend-deca-font');
             textLine.style.color = '#555';
        }

        const nonDescenders = new Set(['a', 'c', 'e', 'i', 'm', 'n', 'o', 'r', 's', 'u', 'v', 'w', 'x', 'z']);
        textLine.innerHTML = Array.from(base).map((ch) => {
            if (ch >= 'a' && ch <= 'z') {
                const isNonDescender = nonDescenders.has(ch.toLowerCase());
                const style = isNonDescender ? `style="padding-bottom: 2px;"` : "";
                return `<span class='lowercase-fill' ${style}>${ch}</span>`;
            }
            if (ch >= 'A' && ch <= 'Z') return `<span class='uppercase-fill'>${ch}</span>`;
            return `<span>${ch}</span>`;
        }).join('');
        row.append(textLine);
    }
    return row;
}

// --- Contextual Toolbar Logic ---
function updateContextualToolbar() {
    if (selectedBlocks.length > 0) {
        contextualToolbar.style.display = 'flex';
        const isLocked = selectedBlocks.some(b => b.classList.contains('locked'));

        const lockIconEl = document.getElementById('lockIcon');
        lockIconEl.className = `fas ${isLocked ? 'fa-lock' : 'fa-lock-open'}`;
        lockBtn.title = isLocked ? 'Unlock' : 'Lock';

        document.querySelectorAll('#object-context-toolbar .context-btn:not(#lockBtn)').forEach(btn => {
            btn.disabled = isLocked;
        });

        const cropBtn = document.getElementById('cropBtn');
        const isSingleRowBlock = selectedBlocks.length === 1 && selectedBlocks[0].classList.contains('row-block');
        
        let canCrop = false;
        if (isSingleRowBlock) {
            const blockId = parseInt(selectedBlocks[0].dataset.blockId);
            const state = blocksState.find(s => s.id === blockId);
            if (state && state.rowConfig.mode !== 'guided-copy') {
                canCrop = true;
            }
        }

        if (cropBtn) {
            cropBtn.style.display = canCrop ? 'flex' : 'none';
            cropBtn.disabled = !canCrop || isLocked;
        }

        const isSingleSelection = selectedBlocks.length === 1;
        document.querySelectorAll('#alignDropdown button').forEach(btn => {
            if (btn.id.includes('Canvas')) {
                btn.disabled = !isSingleSelection || isLocked;
            } else {
                btn.disabled = isSingleSelection || isLocked;
            }
        });

    } else {
        contextualToolbar.style.display = 'none';
        closeAllPopovers();
    }
    updateTextToolState();
    
    if (selectedBlocks.length === 1) {
        let targetHeader = null;
        const block = selectedBlocks[0];
        if (block.classList.contains('row-block')) {
            const blockId = block.dataset.blockId;
            const accordionItem = document.querySelector(`#rowsContainer .accordion-item[data-state-id="${blockId}"]`);
            if (accordionItem) targetHeader = accordionItem.querySelector('.accordion-button');
        } else if (block.classList.contains('text-block-wrapper')) {
            targetHeader = document.querySelector('#textToolsContainer .accordion-button');
        } else if (block.classList.contains('custom-image-block') || block.classList.contains('exercise-image-block')) {
            targetHeader = Array.from(document.querySelectorAll('.panel-content > .accordion-item > .accordion-button')).find(btn => btn.textContent.trim() === 'Image Library');
        } else if (block.classList.contains('background-block') || block.classList.contains('border-block')) {
            targetHeader = Array.from(document.querySelectorAll('.panel-content > .accordion-item > .accordion-button')).find(btn => btn.textContent.trim() === 'Page Setup');
        }
        setExclusiveAccordion(targetHeader);
    }
}

function deleteSelectedBlocks() {
    if (selectedBlocks.length === 0) return;
    selectedBlocks.forEach(block => {
        const blockId = parseInt(block.dataset.blockId);
        blocksState = blocksState.filter(s => s.id !== blockId);
        block.remove();
    });
    deselectAll();
    renderRowControls();
}

function layerSelectedBlock(direction) {
    if (selectedBlocks.length !== 1) return;
    const block = selectedBlocks[0];
    const currentId = parseInt(block.dataset.blockId);
    const currentState = blocksState.find(s => s.id === currentId);

    if (direction === 'forward') {
        highestZ++;
        currentState.zIndex = highestZ;
    } else {
        const minZ = Math.min(...blocksState.map(s => s.zIndex));
        currentState.zIndex = minZ - 1;
    }
    renderWorksheet();
}

function alignSelectedBlock(edge) {
    if (selectedBlocks.length === 0) return;

    const selectedStates = selectedBlocks.map(b => blocksState.find(s => s.id === parseInt(b.dataset.blockId)));

    if (selectedBlocks.length === 1) {
        const state = selectedStates[0];
        const worksheetWidth = worksheetEl.clientWidth;
        const worksheetHeight = worksheetEl.clientHeight;

        switch(edge) {
            case 'centerHCanvas': state.x = (worksheetWidth - state.width) / 2; break;
            case 'centerVCanvas': state.y = (worksheetHeight - state.height) / 2; break;
        }
    } else {
        const minX = Math.min(...selectedStates.map(s => s.x));
        const minY = Math.min(...selectedStates.map(s => s.y));
        const maxX = Math.max(...selectedStates.map(s => s.x + s.width));
        const maxY = Math.max(...selectedStates.map(s => s.y + s.height));
        const centerX = minX + (maxX - minX) / 2;
        const centerY = minY + (maxY - minY) / 2;

        selectedStates.forEach(state => {
            switch(edge) {
                case 'alignLeft': state.x = minX; break;
                case 'alignRight': state.x = maxX - state.width; break;
                case 'alignHCenter': state.x = centerX - state.width / 2; break;
                case 'alignTop': state.y = minY; break;
                case 'alignBottom': state.y = maxY - state.height; break;
                case 'alignVCenter': state.y = centerY - state.height / 2; break;
            }
        });
    }
    renderWorksheet();
}

function toggleLock() {
    if (selectedBlocks.length === 0) return;
    const doLock = !selectedBlocks[0].classList.contains('locked');
    selectedBlocks.forEach(block => {
        const blockId = parseInt(block.dataset.blockId);
        const state = blocksState.find(s => s.id === blockId);
        if (state) state.locked = doLock;
        block.classList.toggle('locked', doLock);
    });
    updateContextualToolbar();
}

function cropRowBlock() {
    if (selectedBlocks.length !== 1 || !selectedBlocks[0].classList.contains('row-block')) return;
    const block = selectedBlocks[0];
    const blockId = parseInt(block.dataset.blockId);
    const state = blocksState.find(s => s.id === blockId);
    const config = state.rowConfig;

    if (!state || config.mode === 'guided-copy') {
        showMessage(t("message.cropNotSupported"), "error");
        return;
    }
    
    const selector = (config.content === 'pre-writing' || config.mode !== 'fill') ? '.letters' : '.text-line';
    const contentContainer = block.querySelector(selector);

    if (!contentContainer) {
        showMessage(t("message.noContentToCrop"), "info");
        return;
    }
    
    const blockRect = block.getBoundingClientRect();
    const children = Array.from(contentContainer.children);
    let lastVisibleIndex = -1;

    for (let i = 0; i < children.length; i++) {
        const item = children[i];
        const itemRect = item.getBoundingClientRect();

        if (itemRect.right <= blockRect.right + 1) {
            lastVisibleIndex = i;
        } else {
            break;
        }
    }

    const numItemsToKeep = lastVisibleIndex + 1;

    if (numItemsToKeep === children.length) {
        showMessage(t("message.noOverflow"), "info");
        return;
    }

    if (config.content === 'pre-writing') {
        config.strokeCount = numItemsToKeep;
    } else if (config.content === 'beginning') {
        config.letterCount = numItemsToKeep;
    } else {
        let originalText;
        if (config.content === 'custom') {
            originalText = config.customText;
        } else if (config.content === 'filename' && selectedImage) {
            originalText = selectedImage.word;
        } else {
             originalText = config.customText || '';
        }
        
        let newText = Array.from(originalText).slice(0, numItemsToKeep).join('');
        
        if (config.content !== 'custom') {
             if(config.case === 'uppercase') newText = newText.toUpperCase();
             else if(config.case === 'lowercase') newText = newText.toLowerCase();
             else if (config.case === 'title' && newText.length > 0) newText = newText.charAt(0).toUpperCase() + newText.slice(1).toLowerCase();
        }

        config.content = 'custom';
        config.customText = newText;
        config.letterCount = null;
    }

    renderWorksheet();
    showMessage(t("message.rowCropped"), "success");
}


function clearAll() {
    showMessage(t("message.confirmClear"), "info-confirm");
}
function confirmClearAll() {
    blocksState = [];
    selectedImage = null;
    backgroundThemeSelect.value = 'none';
    backgroundDictionary.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${t('message.selectBackgroundTheme')}</div>`;
    backgroundOpacitySlider.value = 1;
    backgroundOpacitySlider.disabled = true;
    borderThemeSelect.value = 'none';
    borderDictionary.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme);">${t('message.selectBorderTheme')}</div>`;
    borderOpacitySlider.value = 1;
    borderOpacitySlider.disabled = true;

    // Reset text input fields to defaults
    document.getElementById('textInput').value = '';
    document.getElementById('fontSize').value = 48;
    document.getElementById('fontFamily').value = 'Arial';
    document.getElementById('textColor').value = '#333333';
    document.getElementById('textStrokeColor').value = '#000000';
    document.getElementById('textStrokeWidth').value = 0;

    renderWorksheet();
    deselectAll();
    showMessage(t("message.worksheetCleared"), "success");
}

function showMessage(msg, type = 'info', duration = 3000) {
    const messageEl = document.getElementById('message');
    messageEl.innerHTML = ''; // Clear previous content
    messageEl.textContent = msg;
    messageEl.className = `message ${type}`;

    if (type === 'info-confirm') {
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = t('button.clearAll');
        confirmBtn.style.cssText = 'background: var(--app-accent-danger); color: white; margin-left: 10px; padding: 4px 8px; font-size: 12px;';
        confirmBtn.onclick = confirmClearAll;
        messageEl.appendChild(confirmBtn);
    }
    
    messageEl.style.display = 'block';
    
    if (duration > 0) {
        setTimeout(() => { 
            if (messageEl.className.includes(type)) { // Only hide if it hasn't been replaced by another message
                messageEl.style.display = 'none'; 
            }
        }, duration);
    }
}
function closeAllPopovers() {
    if (activePopover) {
        activePopover.style.display = 'none';
        activePopover.parentElement.querySelector('.context-btn').classList.remove('active-dropdown');
        activePopover = null;
    }
}
function setupPopover(button, content) {
    button.addEventListener('click', (event) => {
        event.stopPropagation();
        const isOpening = content.style.display !== 'block';
        closeAllPopovers();
        if (isOpening) {
            content.style.display = 'block';
            activePopover = content;
            button.classList.add('active-dropdown');
        }
    });
}

// --- Translation Helper Functions ---
function t(key) {
    if (typeof translations === 'undefined') {
        console.warn('translations not loaded, returning key:', key);
        return key;
    }
    const locale = window.currentLocale || 'en';
    const translation = (translations[locale] && translations[locale][key]) ||
                       (translations.en && translations.en[key]) ||
                       key;
    return translation;
}

function formatTranslation(text, params) {
    let formatted = text;
    for (const [key, value] of Object.entries(params)) {
        formatted = formatted.replace(new RegExp(`\\{${key}\\}`, 'g'), value);
    }
    return formatted;
}

function applyTranslations() {
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = t(key);

        // Handle special cases for row title with number
        if (key === 'row.title') {
            const rowNumber = element.textContent.match(/\d+/);
            if (rowNumber) {
                element.textContent = formatTranslation(translation, { number: rowNumber[0] });
                return;
            }
        }

        if (element.tagName === 'OPTION' || element.tagName === 'SPAN' || element.tagName === 'LABEL') {
            element.textContent = translation;
        } else if (element.tagName === 'INPUT' || element.tagName === 'BUTTON') {
            if (element.type !== 'checkbox' && element.type !== 'radio' && element.type !== 'file') {
                element.textContent = translation;
            }
        } else if (element.hasAttribute('title')) {
            element.setAttribute('title', translation);
        } else {
            element.textContent = translation;
        }
    });

    document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        element.placeholder = t(key);
    });

    const titleElement = document.querySelector('title[data-translate]');
    if (titleElement) {
        const key = titleElement.getAttribute('data-translate');
        titleElement.textContent = t(key);
    }
}

// --- Final Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    const textToolsContainer = document.getElementById('textToolsContainer');
    const textToolsTpl = document.getElementById('textToolsTpl').content;
    textToolsContainer.appendChild(textToolsTpl.cloneNode(true));

    document.querySelectorAll('.accordion-button').forEach(btn => setupAccordion(btn));

    document.getElementById('addTextBtn').onclick = addTextToCanvas;
    document.getElementById('toolbarDeleteSelectedTextBtn').addEventListener('click', deleteSelectedTextBox);
    ['textColor', 'fontSize', 'fontFamily', 'textStrokeColor', 'textStrokeWidth'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateSelectedText);
    });

    document.getElementById('toolbarDeleteBtn').addEventListener('click', deleteSelectedBlocks);
    document.getElementById('bringForwardBtn').addEventListener('click', () => layerSelectedBlock('forward'));
    document.getElementById('sendBackwardBtn').addEventListener('click', () => layerSelectedBlock('backward'));
    document.getElementById('lockBtn').addEventListener('click', toggleLock);
    document.getElementById('cropBtn').addEventListener('click', cropRowBlock);

    setupPopover(document.getElementById('alignBtn'), document.getElementById('alignDropdown'));
    document.querySelectorAll('#alignDropdown button').forEach(button => {
        button.addEventListener('click', (e) => {
            alignSelectedBlock(e.currentTarget.id.replace('Btn', ''));
            closeAllPopovers();
        });
    });


    document.getElementById('clearAllBtn').addEventListener('click', clearAll);

    const downloadDropdownBtn = document.getElementById('downloadDropdownBtn');
    const downloadDropdownContent = document.getElementById('downloadDropdownContent');
    downloadDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        downloadDropdownContent.style.display = downloadDropdownContent.style.display === 'block' ? 'none' : 'block';
    });
    document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadFile('pdf'));
    document.getElementById('downloadJpegBtn').addEventListener('click', () => downloadFile('jpeg'));
    document.addEventListener('click', (e) => {
        if (downloadDropdownBtn && !downloadDropdownBtn.contains(e.target)) {
            downloadDropdownContent.style.display = 'none';
        }
        if(activePopover && !activePopover.parentElement.contains(e.target) && !e.target.closest('.dropdown-content')) {
            closeAllPopovers();
        }
    });
    downloadDropdownContent.addEventListener('click', e => e.stopPropagation());
    document.getElementById('alignDropdown').addEventListener('click', e => e.stopPropagation());


    addSelectedCustomImageBtn.addEventListener('click', addSelectedCustomImageToWorksheet);
    clearCustomImageSelectionBtn.addEventListener('click', clearCustomImageSelection);

    // Custom file button handlers
    const customFileButton = document.getElementById('customFileButton');
    const fileSelectionText = document.getElementById('fileSelectionText');

    if (customFileButton) {
        customFileButton.addEventListener('click', () => {
            imageUploadInput.click();
        });
    }

    imageUploadInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (!files) return;

        // Update file selection text
        if (fileSelectionText) {
            const fileCount = files.length;
            if (fileCount > 0) {
                fileSelectionText.textContent = formatTranslation(t('library.filesSelected'), { x: fileCount });
            } else {
                fileSelectionText.textContent = t('library.noFileChosen');
            }
        }

        Promise.all(Array.from(files).filter(f => f.type.startsWith('image/')).map(file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve({ word: file.name.split('.').slice(0, -1).join('.'), path: event.target.result });
            reader.onerror = reject;
            reader.readAsDataURL(file);
        }))).then(newImgs => {
            uploadedImages.push(...newImgs);
            renderUploadedImages();
        });
    });

    // NEW: Event listeners for background and border features
    backgroundThemeSelect.addEventListener("change", () => loadAssetImages('backgrounds', backgroundThemeSelect.value, backgroundDictionary, addBackgroundToCanvas));
    backgroundOpacitySlider.addEventListener('input', () => applyOpacity(backgroundOpacitySlider, 'background'));
    borderThemeSelect.addEventListener("change", () => loadAssetImages('borders', borderThemeSelect.value, borderDictionary, addBorderToCanvas));
    borderOpacitySlider.addEventListener('input', () => applyOpacity(borderOpacitySlider, 'border'));

    // Load border and background themes on initialization
    loadAssetThemes('backgrounds', backgroundThemeSelect);
    loadAssetThemes('borders', borderThemeSelect);

    updateUIMode();
    updateWorksheetPageSize();
    renderWorksheet(); // Initial render to apply any default page size/background/border

    // Handle window resize to maintain proper scaling
    window.addEventListener('resize', () => {
        const widthPx = parseFloat(worksheetEl.style.width);
        const heightPx = parseFloat(worksheetEl.style.height);
        if (widthPx && heightPx) {
            updateWorksheetDisplayScaling(widthPx, heightPx);
        }
    });

    const openMenu = () => { document.querySelector('.panel').classList.add('is-open'); document.getElementById('menuOverlay').classList.add('is-active'); };
    const closeMenu = () => { document.querySelector('.panel').classList.remove('is-open'); document.getElementById('menuOverlay').classList.remove('is-active'); };
    document.getElementById('menuToggleBtn').addEventListener('click', openMenu);
    document.getElementById('menuCloseBtn').addEventListener('click', closeMenu);
    document.getElementById('menuOverlay').addEventListener('click', closeMenu);

    // Apply translations after DOM is ready
    applyTranslations();
});

function renderUploadedImages() {
    uploadedImagesPreviewDiv.innerHTML = '';
    if (uploadedImages.length === 0) {
        uploadedImagesPreviewDiv.innerHTML = `<div style="padding:10px; text-align:center; color:var(--app-text-secondary-dark-theme); width:100%;">${t('library.uploadedImages')}</div>`;
        return;
    }
    uploadedImages.forEach(imgData => {
        const d = document.createElement('div');
        d.className = 'dictionary-item';
        d.innerHTML = `<img src="${imgData.path}" draggable="false"> <span>${imgData.word}</span>`;
        d.onclick = () => {
             if (currentMode === 'custom') {
                if (lastSelectedDictItem) lastSelectedDictItem.style.backgroundColor = '';
                lastSelectedDictItem = d;
                d.style.backgroundColor = 'rgba(0,122,255,0.15)';
                selectedCustomImage = imgData;
                customImageThumbnailPreview.src = imgData.path;
                customImageStatusText.textContent = formatTranslation(t('library.selectedStatus'), { word: imgData.word });
                customImageSelectionPreview.style.display = 'block';
                addSelectedCustomImageBtn.disabled = false;
             }
        };
        uploadedImagesPreviewDiv.appendChild(d);
    });
}

window.addEventListener('resize', renderWorksheet);

    // Check if user is on free tier
    function isFreeTier() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('tier') === 'free';
    }

    // Add watermark to canvas before export
    function addWatermarkToCanvas(canvas) {
        if (!isFreeTier()) return;

        const watermarkText = new fabric.Text(t('watermark.free'), {
            fontSize: 40,
            fill: 'rgba(0, 0, 0, 0.2)',
            angle: -45,
            left: canvas.width / 2,
            top: canvas.height / 2,
            originX: 'center',
            originY: 'center',
            selectable: false,
            evented: false,
            fontFamily: 'Arial, sans-serif',
            fontWeight: 'bold'
        });
        
        // Add multiple watermarks across the canvas
        const watermarks = [];
        const spacing = 250;
        for (let x = 0; x < canvas.width; x += spacing) {
            for (let y = 0; y < canvas.height; y += spacing) {
                const wm = new fabric.Text(t('watermark.freeShort'), {
                    fontSize: 20,
                    fill: 'rgba(0, 0, 0, 0.15)',
                    angle: -45,
                    left: x,
                    top: y,
                    selectable: false,
                    evented: false,
                    fontFamily: 'Arial, sans-serif'
                });
                watermarks.push(wm);
                canvas.add(wm);
            }
        }
        
        // Add main watermark
        canvas.add(watermarkText);
        canvas.renderAll();
        
        return { mainWatermark: watermarkText, watermarks };
    }

    // Remove watermark after export
    function removeWatermarkFromCanvas(canvas, watermarkData) {
        if (!watermarkData) return;
        
        if (watermarkData.mainWatermark) {
            canvas.remove(watermarkData.mainWatermark);
        }
        if (watermarkData.watermarks) {
            watermarkData.watermarks.forEach(wm => canvas.remove(wm));
        }
        canvas.renderAll();
    }

    // Override the original downloadPDF function
    const originalDownloadPDF = typeof downloadPDF !== 'undefined' ? downloadPDF : null;
    if (originalDownloadPDF) {
        window.downloadPDF = async function(canvasToExport, fileName) {
            if (!canvasToExport || canvasToExport.getObjects().length === 0) {
                return showMessage(t('message.generateContent'), 'error');
            }
            showMessage(t('message.preparingPdf'), 'info', 0);
            
            // Add watermark if free tier
            const watermarkData = addWatermarkToCanvas(canvasToExport);
            
            try {
                const { jsPDF } = window.jspdf;
                const orientation = canvasToExport.width > canvasToExport.height ? 'l' : 'p';
                const pdf = new jsPDF({ 
                    orientation, 
                    unit: 'pt', 
                    format: [canvasToExport.width, canvasToExport.height] 
                });

                const exportOptions = { 
                    multiplier: typeof downloadMultiplier !== 'undefined' ? downloadMultiplier : 6, 
                    applyGrayscale: typeof grayscaleToggle !== 'undefined' && grayscaleToggle.checked 
                };
                
                const dataURL = await getCanvasDataURLWithOptions(canvasToExport, exportOptions);
                pdf.addImage(dataURL, 'JPEG', 0, 0, canvasToExport.width, canvasToExport.height);
                
                pdf.save(fileName);
                showMessage(t('message.pdfDownloaded'), 'success');
            } catch(e) {
                showMessage(t('message.pdfError'), 'error'); 
                console.error(e); 
            } finally {
                // Remove watermark after export
                removeWatermarkFromCanvas(canvasToExport, watermarkData);
            }
        };
    }

    // Override the original downloadJPEG function if it exists
    const originalDownloadJPEG = typeof downloadJPEG !== 'undefined' ? downloadJPEG : null;
    if (originalDownloadJPEG) {
        window.downloadJPEG = async function(canvasToExport, fileName) {
            if (!canvasToExport || canvasToExport.getObjects().length === 0) {
                return showMessage(t('message.generateWorksheet'), 'error');
            }
            showMessage(t('message.preparingJpeg'), 'info', 0);
            
            // Add watermark if free tier
            const watermarkData = addWatermarkToCanvas(canvasToExport);
            
            try {
                const exportOptions = { 
                    multiplier: typeof downloadMultiplier !== 'undefined' ? downloadMultiplier : 6, 
                    applyGrayscale: typeof grayscaleToggle !== 'undefined' && grayscaleToggle.checked 
                };
                const dataURL = await getCanvasDataURLWithOptions(canvasToExport, exportOptions);
                
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = fileName;
                link.click();
                showMessage(t('message.jpegDownloaded'), 'success');
            } catch(e) {
                showMessage(t('message.jpegError'), 'error'); 
                console.error(e); 
            } finally {
                // Remove watermark after export
                removeWatermarkFromCanvas(canvasToExport, watermarkData);
            }
        };
    }

    async function generateInitialWorksheet() {
        try {
            console.log('Starting initial worksheet generation...');

            // Set page size to Letter portrait (612x792) - already default
            pageSizeSelect.value = '612x792';
            updateWorksheetPageSize();

            // Set theme to Animals and fetch images
            themeSelect.value = 'animals';

            // Fetch Animals theme images
            const response = await fetch(`/api/images?theme=animals&locale=${imageLibraryLocale}`);
            const data = await response.json();
            const animalImages = data.images || data;

            // Select a random animal image
            if (animalImages && animalImages.length > 0) {
                const randomIndex = Math.floor(Math.random() * animalImages.length);
                selectedImage = {
                    word: animalImages[randomIndex].word,
                    path: animalImages[randomIndex].path
                };
                console.log('Selected image:', selectedImage);

                // Add the image to the worksheet
                showImageFeedback();
            }

            // Wait a bit for the image to load
            await new Promise(resolve => setTimeout(resolve, 500));

            // Calculate dimensions like addNewRowControl does
            const defaultRowHeight = vhToPixels(4.48);
            const worksheetWidth = worksheetEl.clientWidth;
            const worksheetHeight = worksheetEl.clientHeight;
            const rowWidth = worksheetWidth * 0.9;
            const centerX = (worksheetWidth - rowWidth) / 2;

            // Calculate Y positions for 3 rows, positioned below the image
            // Image takes up approximately 29.575% of height + 20px top offset
            const imageHeight = worksheetHeight * 0.29575;
            const imageBottomY = 20 + imageHeight;
            const availableHeight = worksheetHeight - imageBottomY - 40; // 40px bottom margin
            const totalRowsHeight = defaultRowHeight * 3;
            const spacing = (availableHeight - totalRowsHeight) / 4; // spacing between rows
            const startY = imageBottomY + spacing;

            // Add Row 1: Trace, Print Tracing Arrow, Beginning Letter, Lower Case
            blocksState.push({
                id: blockIdCounter++,
                type: 'row',
                x: centerX,
                y: startY,
                width: rowWidth,
                height: defaultRowHeight,
                zIndex: highestZ++,
                locked: false,
                rowConfig: {
                    mode: 'trace',
                    fontStyle: 'print/tracing arrow',
                    content: 'beginning',
                    case: 'lowercase',
                    strokeType: 'vertical',
                    customText: '',
                    letterCount: null,
                    strokeCount: null
                }
            });

            // Add Row 2: Trace, Print Tracing, Beginning Letter, Lower Case
            blocksState.push({
                id: blockIdCounter++,
                type: 'row',
                x: centerX,
                y: startY + defaultRowHeight + spacing,
                width: rowWidth,
                height: defaultRowHeight,
                zIndex: highestZ++,
                locked: false,
                rowConfig: {
                    mode: 'trace',
                    fontStyle: 'print/tracing',
                    content: 'beginning',
                    case: 'lowercase',
                    strokeType: 'vertical',
                    customText: '',
                    letterCount: null,
                    strokeCount: null
                }
            });

            // Add Row 3: Fading Trace, Print Tracing, Beginning Letter, Lower Case
            blocksState.push({
                id: blockIdCounter++,
                type: 'row',
                x: centerX,
                y: startY + (defaultRowHeight + spacing) * 2,
                width: rowWidth,
                height: defaultRowHeight,
                zIndex: highestZ++,
                locked: false,
                rowConfig: {
                    mode: 'fading-trace',
                    fontStyle: 'print/tracing',
                    content: 'beginning',
                    case: 'lowercase',
                    strokeType: 'vertical',
                    customText: '',
                    letterCount: null,
                    strokeCount: null
                }
            });

            // Render the worksheet with all rows
            renderWorksheet();
            renderRowControls();

            console.log('Initial worksheet generated successfully');
        } catch (error) {
            console.error('Error generating initial worksheet:', error);
        }
    }

    setTimeout(() => generateInitialWorksheet(), 1000);

</script>
</body>
</html>