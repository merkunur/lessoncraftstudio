<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LessonCraftStudio - Advanced Content Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .main-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tabs {
            display: flex;
            background: #f1f3f5;
            padding: 4px;
            border-radius: 8px;
            margin-right: auto;
        }

        .tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: #495057;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            width: 250px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .content-area {
            padding: 20px;
            min-height: 500px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            color: #2d3748;
        }

        tr:hover {
            background: #f7fafc;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .thumbnail:hover {
            border-color: #667eea;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn {
            background: #4299e1;
            color: white;
        }

        .delete-btn {
            background: #f56565;
            color: white;
        }

        .view-btn {
            background: #48bb78;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .pagination-info {
            color: #718096;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .page-btn:hover {
            background: #f1f3f5;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #718096;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #a0aec0;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .grid-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .grid-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .grid-item-info {
            padding: 12px;
        }

        .grid-item-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .grid-item-meta {
            font-size: 12px;
            color: #718096;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .view-btn {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #718096;
            cursor: pointer;
            border-radius: 4px;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-active {
            background: #48bb78;
        }

        .status-inactive {
            background: #f56565;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎨 LessonCraftStudio Content Manager</h1>
        <p>Complete control over your dynamic content system</p>
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 12px;">
            <strong>Language Codes:</strong>
            EN (🇬🇧 English) • DE (🇩🇪 German) • FR (🇫🇷 French) • ES (🇪🇸 Spanish) • PT (🇵🇹 Portuguese) •
            IT (🇮🇹 Italian) • NL (🇳🇱 Dutch) • SV (🇸🇪 Swedish) • DA (🇩🇰 Danish) • NO (🇳🇴 Norwegian) • FI (🇫🇮 Finnish)
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="stat-files">0</div>
                <div class="stat-label">Total Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-assets">0</div>
                <div class="stat-label">Image Assets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-borders">0</div>
                <div class="stat-label">Borders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-backgrounds">0</div>
                <div class="stat-label">Backgrounds</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-templates">0</div>
                <div class="stat-label">Templates</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="toolbar">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('image_assets')">Image Assets</button>
                    <button class="tab" onclick="switchTab('border_images')">Borders</button>
                    <button class="tab" onclick="switchTab('background_images')">Backgrounds</button>
                    <button class="tab" onclick="switchTab('train_templates')">Train Templates</button>
                    <button class="tab" onclick="switchTab('worksheet_templates')">Worksheet Templates</button>
                    <button class="tab" onclick="switchTab('files')">All Files</button>
                    <button class="tab" onclick="switchTab('themes')" style="background: #ffd700; color: #333;">⚙️ Themes</button>
                </div>

                <input type="text" class="search-box" id="search" placeholder="Search..." onkeyup="handleSearch()">

                <select class="form-input" style="width: 150px;" id="filter-theme" onchange="filterByTheme()">
                    <option value="">All Themes</option>
                </select>

                <div class="view-toggle">
                    <button class="view-btn active" onclick="setView('table')">📋 Table</button>
                    <button class="view-btn" onclick="setView('grid')">⊞ Grid</button>
                </div>

                <button class="btn btn-success" onclick="syncNow()">🔄 Sync</button>
                <button class="btn btn-danger" onclick="clearAppCaches()">🧹 Clear Cache</button>
                <button class="btn btn-primary" onclick="showUploadModal()">📤 Upload</button>
                <button class="btn btn-warning" onclick="showBatchModal()" id="batch-btn" style="display:none;">⚡ Batch Edit</button>
                <button class="btn" style="background: #ffd700; color: #333;" onclick="quickCreateTheme()" title="Quick Create Theme">➕ Theme</button>
            </div>

            <div class="content-area" id="content-area">
                <div class="loading">Loading...</div>
            </div>

            <div class="pagination" id="pagination">
                <div class="pagination-info">
                    Showing <span id="range-start">0</span>-<span id="range-end">0</span> of <span id="total-items">0</span> items
                </div>
                <div class="pagination-controls" id="pagination-controls">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Management Modal -->
    <div id="theme-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create/Edit Theme</h3>
                <button class="modal-close" onclick="closeThemeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Theme Type</label>
                    <select class="form-input" id="theme-type">
                        <option value="image_themes">Image Theme</option>
                        <option value="border_styles">Border Style</option>
                        <option value="background_themes">Background Theme</option>
                        <option value="train_template_themes">Train Template Theme</option>
                        <option value="worksheet_template_themes">Worksheet Template Theme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Folder Name (lowercase, no spaces)</label>
                    <input type="text" class="form-input" id="theme-folder" placeholder="e.g., animals, vehicles">
                </div>
                <div class="form-group">
                    <label class="form-label">Display Names (All 11 Languages)</label>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-top: 10px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                        <label style="padding: 5px; font-weight: 600;">🇬🇧 English (EN):</label>
                        <input type="text" class="form-input" id="theme-name-en" placeholder="e.g., Animals" required>

                        <label style="padding: 5px;">🇩🇪 German (DE):</label>
                        <input type="text" class="form-input" id="theme-name-de" placeholder="e.g., Tiere">

                        <label style="padding: 5px;">🇫🇷 French (FR):</label>
                        <input type="text" class="form-input" id="theme-name-fr" placeholder="e.g., Animaux">

                        <label style="padding: 5px;">🇪🇸 Spanish (ES):</label>
                        <input type="text" class="form-input" id="theme-name-es" placeholder="e.g., Animales">

                        <label style="padding: 5px;">🇵🇹 Portuguese (PT):</label>
                        <input type="text" class="form-input" id="theme-name-pt" placeholder="e.g., Animais">

                        <label style="padding: 5px;">🇮🇹 Italian (IT):</label>
                        <input type="text" class="form-input" id="theme-name-it" placeholder="e.g., Animali">

                        <label style="padding: 5px;">🇳🇱 Dutch (NL):</label>
                        <input type="text" class="form-input" id="theme-name-nl" placeholder="e.g., Dieren">

                        <label style="padding: 5px;">🇸🇪 Swedish (SV):</label>
                        <input type="text" class="form-input" id="theme-name-sv" placeholder="e.g., Djur">

                        <label style="padding: 5px;">🇩🇰 Danish (DA):</label>
                        <input type="text" class="form-input" id="theme-name-da" placeholder="e.g., Dyr">

                        <label style="padding: 5px;">🇳🇴 Norwegian (NO):</label>
                        <input type="text" class="form-input" id="theme-name-no" placeholder="e.g., Dyr">

                        <label style="padding: 5px;">🇫🇮 Finnish (FI):</label>
                        <input type="text" class="form-input" id="theme-name-fi" placeholder="e.g., Eläimet">
                    </div>
                    <small style="color: #666; margin-top: 5px; display: block;">Tip: English is required. Other languages will default to English if left empty.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Sort Order</label>
                    <input type="number" class="form-input" id="theme-sort" value="999">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="theme-active" checked> Active
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeThemeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTheme()">Save Theme</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Item</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body" id="edit-modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Files</h3>
                <button class="modal-close" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Files</label>
                    <input type="file" id="file-input" multiple accept="image/*" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Target Collection</label>
                    <select class="form-input" id="upload-collection">
                        <option value="files">Files Only</option>
                        <option value="image_assets">Image Assets</option>
                        <option value="border_images">Border Images</option>
                        <option value="background_images">Background Images</option>
                        <option value="train_template_images">Train Templates</option>
                        <option value="worksheet_template_images">Worksheet Templates</option>
                    </select>
                </div>
                <div id="upload-progress"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" onclick="uploadFiles()">Upload</button>
            </div>
        </div>
    </div>

    <!-- Batch Operations Modal -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Batch Operations</h3>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Selected <span id="batch-count">0</span> items</p>
                <div class="form-group">
                    <label class="form-label">Operation</label>
                    <select class="form-input" id="batch-operation" onchange="updateBatchForm()">
                        <option value="">Select operation...</option>
                        <option value="set-theme">Set Theme/Style</option>
                        <option value="set-status">Set Status</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                </div>
                <div id="batch-form-fields"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBatchModal()">Cancel</button>
                <button class="btn btn-danger" onclick="executeBatchOperation()">Execute</button>
            </div>
        </div>
    </div>

    <script>
        const DIRECTUS_URL = 'http://localhost:8055';
        const API_URL = 'http://localhost:3000';
        const API_TOKEN = 'static-api-token-for-sync';

        let currentTab = 'image_assets';
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalItems = 0;
        let allData = [];
        let filteredData = [];
        let currentView = 'table';
        let currentEditItem = null;
        let availableThemes = [];
        let availableStyles = [];
        let availableBackgroundThemes = [];
        let availableTrainThemes = [];
        let availableWorksheetThemes = [];

        // Initialize
        async function init() {
            await loadStatistics();
            await loadRelationships();
            await loadData();
        }

        // Load available themes and styles
        async function loadRelationships() {
            try {
                // Load image themes (for main image assets)
                const imageThemesRes = await fetch(`${DIRECTUS_URL}/items/image_themes`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                if (imageThemesRes.ok) {
                    const imageThemesData = await imageThemesRes.json();
                    availableThemes = imageThemesData.data || [];
                    console.log('Loaded image themes:', availableThemes);
                } else {
                    console.error('Failed to load image themes:', await imageThemesRes.text());
                }

                // Load border styles
                const stylesRes = await fetch(`${DIRECTUS_URL}/items/border_styles`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                if (stylesRes.ok) {
                    const stylesData = await stylesRes.json();
                    availableStyles = stylesData.data || [];
                    console.log('Loaded border styles:', availableStyles);
                }

                // Load background themes
                const bgThemesRes = await fetch(`${DIRECTUS_URL}/items/background_themes`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                if (bgThemesRes.ok) {
                    const bgThemesData = await bgThemesRes.json();
                    availableBackgroundThemes = bgThemesData.data || [];
                    console.log('Loaded background themes:', availableBackgroundThemes);
                }

                // Load train template themes
                const trainThemesRes = await fetch(`${DIRECTUS_URL}/items/train_template_themes`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                if (trainThemesRes.ok) {
                    const trainThemesData = await trainThemesRes.json();
                    availableTrainThemes = trainThemesData.data || [];
                    console.log('Loaded train themes:', availableTrainThemes);
                }

                // Load worksheet template themes
                const worksheetThemesRes = await fetch(`${DIRECTUS_URL}/items/worksheet_template_themes`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                if (worksheetThemesRes.ok) {
                    const worksheetThemesData = await worksheetThemesRes.json();
                    availableWorksheetThemes = worksheetThemesData.data || [];
                    console.log('Loaded worksheet themes:', availableWorksheetThemes);
                }
            } catch (error) {
                console.error('Error loading relationships:', error);
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const responses = await Promise.all([
                    fetch(`${DIRECTUS_URL}/files?limit=1&meta=total_count`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    }),
                    fetch(`${DIRECTUS_URL}/items/image_assets?limit=1&meta=total_count`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    }),
                    fetch(`${DIRECTUS_URL}/items/border_images?limit=1&meta=total_count`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    }),
                    fetch(`${DIRECTUS_URL}/items/background_images?limit=1&meta=total_count`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    })
                ]);

                const [files, assets, borders, backgrounds] = await Promise.all(
                    responses.map(r => r.json())
                );

                document.getElementById('stat-files').textContent = files.meta?.total_count || 0;
                document.getElementById('stat-assets').textContent = assets.meta?.total_count || 0;
                document.getElementById('stat-borders').textContent = borders.meta?.total_count || 0;
                document.getElementById('stat-backgrounds').textContent = backgrounds.meta?.total_count || 0;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load data based on current tab
        async function loadData() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">Loading...</div>';

            try {
                let url = '';
                let fields = '';

                switch(currentTab) {
                    case 'image_assets':
                        url = `${DIRECTUS_URL}/items/image_assets?limit=500&fields=*,theme_id.*,image_file.*`;
                        break;
                    case 'border_images':
                        url = `${DIRECTUS_URL}/items/border_images?limit=500&fields=*,style_id.*,image_file.*`;
                        break;
                    case 'background_images':
                        url = `${DIRECTUS_URL}/items/background_images?limit=500&fields=*,theme_id.*,image_file.*`;
                        break;
                    case 'train_templates':
                        url = `${DIRECTUS_URL}/items/train_template_images?limit=500&fields=*,theme_id.*,image_file.*`;
                        break;
                    case 'worksheet_templates':
                        url = `${DIRECTUS_URL}/items/worksheet_template_images?limit=500&fields=*,theme_id.*,image_file.*`;
                        break;
                    case 'files':
                        url = `${DIRECTUS_URL}/files?limit=500&sort=-uploaded_on`;
                        break;
                    case 'themes':
                        // Handle themes separately
                        loadThemesManagement();
                        return;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });

                const data = await response.json();
                allData = data.data || [];
                filteredData = [...allData];
                totalItems = filteredData.length;

                updatePagination();
                renderContent();

            } catch (error) {
                contentArea.innerHTML = `<div class="empty-state">Error loading data: ${error.message}</div>`;
            }
        }

        // Render content based on view type
        function renderContent() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            if (currentView === 'table') {
                renderTable(pageData);
            } else {
                renderGrid(pageData);
            }

            // Update pagination info
            document.getElementById('range-start').textContent = startIndex + 1;
            document.getElementById('range-end').textContent = Math.min(endIndex, totalItems);
            document.getElementById('total-items').textContent = totalItems;
        }

        // Render table view
        function renderTable(data) {
            const contentArea = document.getElementById('content-area');

            if (data.length === 0) {
                contentArea.innerHTML = '<div class="empty-state">No items found</div>';
                return;
            }

            let html = '<div class="table-container"><table>';

            // Headers based on tab
            if (currentTab === 'files') {
                html += `
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
                            <th>Preview</th>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Type</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
            } else {
                html += `
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th>
                            <th>Preview</th>
                            <th>Name</th>
                            <th>Theme/Style</th>
                            <th>Status</th>
                            <th>File ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
            }

            // Rows
            data.forEach(item => {
                if (currentTab === 'files') {
                    html += `
                        <tr>
                            <td><input type="checkbox" class="item-checkbox" value="${item.id}"></td>
                            <td><img src="/api/directus-image?id=${item.id}" class="thumbnail" onclick="viewImage('${item.id}')"></td>
                            <td>${item.filename_download || 'Unnamed'}</td>
                            <td>${formatFileSize(item.filesize)}</td>
                            <td>${item.type || 'Unknown'}</td>
                            <td>${new Date(item.uploaded_on).toLocaleDateString()}</td>
                            <td class="actions">
                                <button class="action-btn view-btn" onclick="viewImage('${item.id}')">View</button>
                                <button class="action-btn delete-btn" onclick="deleteItem('${item.id}', 'files')">Delete</button>
                            </td>
                        </tr>
                    `;
                } else {
                    const imageId = item.image_file?.id || item.image_file;
                    const themeName = item.theme_id?.name?.en || item.theme_id?.folder_name || item.style_id?.translations?.en || item.style_id?.style_name || 'N/A';
                    html += `
                        <tr>
                            <td><input type="checkbox" class="item-checkbox" value="${item.id}"></td>
                            <td>
                                ${imageId ? `<img src="/api/directus-image?id=${imageId}" class="thumbnail" onclick="viewImage('${imageId}')">` : 'No image'}
                            </td>
                            <td>${item.file_name || 'Unnamed'}</td>
                            <td>${themeName}</td>
                            <td>
                                <span class="status-indicator ${item.status === 'active' ? 'status-active' : 'status-inactive'}"></span>
                                ${item.status || 'unknown'}
                            </td>
                            <td>${imageId ? imageId.substring(0, 8) + '...' : 'None'}</td>
                            <td class="actions">
                                <button class="action-btn edit-btn" onclick="editItem(${item.id}, '${currentTab}')">Edit</button>
                                <button class="action-btn view-btn" onclick="viewImage('${imageId}')">View</button>
                                <button class="action-btn delete-btn" onclick="deleteItem(${item.id}, '${currentTab}')">Delete</button>
                            </td>
                        </tr>
                    `;
                }
            });

            html += '</tbody></table></div>';
            contentArea.innerHTML = html;
        }

        // Render grid view
        function renderGrid(data) {
            const contentArea = document.getElementById('content-area');

            if (data.length === 0) {
                contentArea.innerHTML = '<div class="empty-state">No items found</div>';
                return;
            }

            let html = '<div class="grid-view">';

            data.forEach(item => {
                const imageId = item.image_file?.id || item.image_file || item.id;
                const name = item.file_name || item.filename_download || 'Unnamed';
                const themeName = item.theme_id?.name?.en || item.theme_id?.folder_name || item.style_id?.translations?.en || item.style_id?.style_name || '';

                html += `
                    <div class="grid-item" onclick="editItem(${item.id}, '${currentTab}')">
                        <img src="/api/directus-image?id=${imageId}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22><rect width=%22200%22 height=%22150%22 fill=%22%23f0f0f0%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>No Image</text></svg>'">
                        <div class="grid-item-info">
                            <div class="grid-item-name">${name}</div>
                            <div class="grid-item-meta">
                                ${themeName ? `${themeName} • ` : ''}
                                ${item.status || ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            contentArea.innerHTML = html;
        }

        // Edit item
        async function editItem(id, collection) {
            console.log('Edit item called:', { id, collection });
            try {
                if (collection === 'files') {
                // For files, just show file info
                const file = allData.find(f => f.id === id);
                if (!file) return;

                let html = `
                    <div class="form-group">
                        <label class="form-label">Filename</label>
                        <input type="text" class="form-input" value="${file.filename_download}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">File ID</label>
                        <input type="text" class="form-input" value="${file.id}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Size</label>
                        <input type="text" class="form-input" value="${formatFileSize(file.filesize)}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-input" value="${file.type}" readonly>
                    </div>
                    <img src="/api/directus-image?id=${file.id}" class="preview-image">
                `;

                document.getElementById('edit-modal-body').innerHTML = html;
                document.getElementById('edit-modal').classList.add('show');
                return;
            }

            currentEditItem = { id, collection };

            // For template collections, try to get data from already loaded allData first
            let data = null;

            if (collection === 'train_templates' || collection === 'worksheet_templates') {
                // Find the item in the already loaded data
                data = allData.find(item => item.id === id);
                console.log('Found item in loaded data:', data);

                if (!data) {
                    // If not found, try to fetch it
                    let collectionName = collection === 'train_templates' ? 'train_template_images' : 'worksheet_template_images';

                    // Try fetching from the collection endpoint with filter
                    const response = await fetch(`${DIRECTUS_URL}/items/${collectionName}?filter[id][_eq]=${id}&fields=*,theme_id.*,image_file.*`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.data && result.data.length > 0) {
                            data = result.data[0];
                        }
                    }
                }
            } else {
                // For other collections, use the standard approach
                let collectionName = collection;

                const response = await fetch(`${DIRECTUS_URL}/items/${collectionName}/${id}?fields=*,theme_id.*,style_id.*,image_file.*`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });

                console.log('Fetch response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to fetch item:', errorText);
                    throw new Error(`Failed to fetch item: ${response.status}`);
                }

                const item = await response.json();
                console.log('API response:', item);

                // Handle both single item and error responses
                data = item.data || item;
            }

            if (!data) {
                console.error('No data found for item');
                throw new Error('Item not found');
            }

            console.log('Fetched data:', data);

            let html = `
                <div class="form-group">
                    <label class="form-label">File Name</label>
                    <input type="text" class="form-input" id="edit-filename" value="${data.file_name || ''}">
                </div>
            `;

            // Add theme/style selector based on collection type
            if (collection === 'image_assets') {
                html += `
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select class="form-input" id="edit-theme">
                            <option value="">No Theme</option>
                            ${availableThemes.map(theme => `
                                <option value="${theme.id}" ${data.theme_id?.id === theme.id ? 'selected' : ''}>
                                    ${theme.name?.en || theme.folder_name || 'Theme ' + theme.id}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (collection === 'border_images') {
                html += `
                    <div class="form-group">
                        <label class="form-label">Border Style</label>
                        <select class="form-input" id="edit-style">
                            ${availableStyles.map(style => `
                                <option value="${style.id}" ${data.style_id?.id === style.id ? 'selected' : ''}>
                                    ${style.translations?.en || style.style_name || 'Style ' + style.id}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (collection === 'background_images') {
                html += `
                    <div class="form-group">
                        <label class="form-label">Background Theme</label>
                        <select class="form-input" id="edit-theme">
                            ${availableBackgroundThemes.map(theme => `
                                <option value="${theme.id}" ${data.theme_id?.id === theme.id ? 'selected' : ''}>
                                    ${theme.translations?.en || theme.folder_name || 'Theme ' + theme.id}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (collection === 'train_templates' || collection === 'train_template_images') {
                html += `
                    <div class="form-group">
                        <label class="form-label">Train Template Theme</label>
                        <select class="form-input" id="edit-theme">
                            ${availableTrainThemes.map(theme => `
                                <option value="${theme.id}" ${data.theme_id?.id === theme.id ? 'selected' : ''}>
                                    ${theme.translations?.en || theme.folder_name || theme.theme_name || 'Theme ' + theme.id}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            } else if (collection === 'worksheet_templates' || collection === 'worksheet_template_images') {
                html += `
                    <div class="form-group">
                        <label class="form-label">Worksheet Template Theme</label>
                        <select class="form-input" id="edit-theme">
                            ${availableWorksheetThemes.map(theme => `
                                <option value="${theme.id}" ${data.theme_id?.id === theme.id ? 'selected' : ''}>
                                    ${theme.translations?.en || theme.folder_name || theme.theme_name || 'Theme ' + theme.id}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }

            // Image file selector with replacement option
            html += `
                <div class="form-group">
                    <label class="form-label">Current Image</label>
                    <input type="text" class="form-input" id="edit-image-file" value="${data.image_file?.id || data.image_file || ''}" placeholder="Enter Directus file ID" readonly>
                    <small style="color: #666;">File: ${data.image_file?.filename_download || 'None'}</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Replace Image (Optional)</label>
                    <input type="file" class="form-input" id="replace-image-file" accept="image/*" onchange="previewReplacementImage(this)">
                    <small style="color: #666;">Upload a new image to replace the current one. All metadata will be preserved.</small>
                    <div id="replacement-preview" style="margin-top: 10px; display: none;">
                        <small style="color: green;">✓ New image selected for upload</small>
                        <img id="replacement-preview-img" style="max-width: 200px; max-height: 150px; margin-top: 5px; border: 2px solid #4CAF50; border-radius: 4px;">
                    </div>
                </div>
            `;

            html += `
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="edit-status">
                        <option value="active" ${data.status === 'active' ? 'selected' : ''}>Active</option>
                        <option value="inactive" ${data.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Translations</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px;">🇬🇧 English (EN)</label>
                            <input type="text" class="form-input" id="edit-trans-en"
                                   value="${data.translations?.en || data.file_name || ''}" placeholder="English">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇩🇪 German (DE)</label>
                            <input type="text" class="form-input" id="edit-trans-de"
                                   value="${data.translations?.de || ''}" placeholder="Deutsch">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇫🇷 French (FR)</label>
                            <input type="text" class="form-input" id="edit-trans-fr"
                                   value="${data.translations?.fr || ''}" placeholder="Français">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇪🇸 Spanish (ES)</label>
                            <input type="text" class="form-input" id="edit-trans-es"
                                   value="${data.translations?.es || ''}" placeholder="Español">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇵🇹 Portuguese (PT)</label>
                            <input type="text" class="form-input" id="edit-trans-pt"
                                   value="${data.translations?.pt || ''}" placeholder="Português">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇮🇹 Italian (IT)</label>
                            <input type="text" class="form-input" id="edit-trans-it"
                                   value="${data.translations?.it || ''}" placeholder="Italiano">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇳🇱 Dutch (NL)</label>
                            <input type="text" class="form-input" id="edit-trans-nl"
                                   value="${data.translations?.nl || ''}" placeholder="Nederlands">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇸🇪 Swedish (SV)</label>
                            <input type="text" class="form-input" id="edit-trans-sv"
                                   value="${data.translations?.sv || ''}" placeholder="Svenska">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇩🇰 Danish (DA)</label>
                            <input type="text" class="form-input" id="edit-trans-da"
                                   value="${data.translations?.da || ''}" placeholder="Dansk">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇳🇴 Norwegian (NO)</label>
                            <input type="text" class="form-input" id="edit-trans-no"
                                   value="${data.translations?.no || ''}" placeholder="Norsk">
                        </div>
                        <div>
                            <label style="font-size: 12px;">🇫🇮 Finnish (FI)</label>
                            <input type="text" class="form-input" id="edit-trans-fi"
                                   value="${data.translations?.fi || ''}" placeholder="Suomi">
                        </div>
                    </div>
                </div>
            `;

            if (data.image_file) {
                const imageId = data.image_file.id || data.image_file;
                html += `
                    <div class="form-group">
                        <label class="form-label">Preview</label>
                        <img src="/api/directus-image?id=${imageId}" class="preview-image">
                    </div>
                `;
            }

            document.getElementById('edit-modal-body').innerHTML = html;
            document.getElementById('edit-modal').classList.add('show');
            } catch (error) {
                console.error('Error in editItem:', error);
                alert('Error loading item: ' + error.message);
            }
        }

        // Save changes
        async function saveChanges() {
            if (!currentEditItem) return;

            try {
                // Check if user wants to replace the image
                const replaceImageFile = document.getElementById('replace-image-file');
                let newImageFileId = null;

                if (replaceImageFile && replaceImageFile.files.length > 0) {
                    // Upload the new image first
                    const formData = new FormData();
                    formData.append('file', replaceImageFile.files[0]);

                    const uploadResponse = await fetch(`${DIRECTUS_URL}/files`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        },
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload replacement image');
                    }

                    const uploadResult = await uploadResponse.json();
                    newImageFileId = uploadResult.data.id;

                    // Optional: Delete the old image file if needed
                    // const oldImageId = document.getElementById('edit-image-file')?.value;
                    // if (oldImageId) {
                    //     await fetch(`${DIRECTUS_URL}/files/${oldImageId}`, {
                    //         method: 'DELETE',
                    //         headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    //     });
                    // }
                }

                const updates = {
                    file_name: document.getElementById('edit-filename').value,
                    status: document.getElementById('edit-status').value,
                    translations: {
                        en: document.getElementById('edit-trans-en')?.value || '',
                        de: document.getElementById('edit-trans-de')?.value || '',
                        fr: document.getElementById('edit-trans-fr')?.value || '',
                        es: document.getElementById('edit-trans-es')?.value || '',
                        pt: document.getElementById('edit-trans-pt')?.value || '',
                        it: document.getElementById('edit-trans-it')?.value || '',
                        nl: document.getElementById('edit-trans-nl')?.value || '',
                        sv: document.getElementById('edit-trans-sv')?.value || '',
                        da: document.getElementById('edit-trans-da')?.value || '',
                        no: document.getElementById('edit-trans-no')?.value || '',
                        fi: document.getElementById('edit-trans-fi')?.value || ''
                    }
                };

                // Add theme/style relationship based on collection
                if (currentEditItem.collection === 'image_assets') {
                    const themeId = document.getElementById('edit-theme')?.value;
                    updates.theme_id = themeId || null;
                } else if (currentEditItem.collection === 'border_images') {
                    const styleId = document.getElementById('edit-style')?.value;
                    updates.style_id = styleId || null;
                } else if (currentEditItem.collection === 'background_images' ||
                           currentEditItem.collection === 'train_templates' ||
                           currentEditItem.collection === 'train_template_images' ||
                           currentEditItem.collection === 'worksheet_templates' ||
                           currentEditItem.collection === 'worksheet_template_images') {
                    const themeId = document.getElementById('edit-theme')?.value;
                    updates.theme_id = themeId || null;
                }

                // Update image file reference if a new image was uploaded
                if (newImageFileId) {
                    updates.image_file = newImageFileId;
                }

                // Map tab names to actual collection names
                let collectionName = currentEditItem.collection;
                if (collectionName === 'train_templates') {
                    collectionName = 'train_template_images';
                } else if (collectionName === 'worksheet_templates') {
                    collectionName = 'worksheet_template_images';
                }

                const response = await fetch(`${DIRECTUS_URL}/items/${collectionName}/${currentEditItem.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    closeEditModal();
                    loadData();
                    alert('Changes saved successfully!');
                } else {
                    alert('Failed to save changes');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete item
        async function deleteItem(id, collection) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            try {
                // Map tab names to actual collection names
                let collectionName = collection;
                if (collection === 'train_templates') {
                    collectionName = 'train_template_images';
                } else if (collection === 'worksheet_templates') {
                    collectionName = 'worksheet_template_images';
                }

                const endpoint = collectionName === 'files' ? 'files' : `items/${collectionName}`;
                const response = await fetch(`${DIRECTUS_URL}/${endpoint}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });

                if (response.ok) {
                    loadData();
                    loadStatistics();
                    alert('Item deleted successfully!');
                } else {
                    alert('Failed to delete item');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // View image
        function viewImage(id) {
            if (!id || id === 'undefined') return;
            window.open(`/api/directus-image?id=${id}`, '_blank');
        }

        // Preview replacement image
        function previewReplacementImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('replacement-preview-img').src = e.target.result;
                    document.getElementById('replacement-preview').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                document.getElementById('replacement-preview').style.display = 'none';
            }
        }

        // Switch tab
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;

            // Update UI
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            loadData();
        }

        // Set view type
        function setView(view) {
            currentView = view;

            // Update UI
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            renderContent();
        }

        // Handle search
        function handleSearch() {
            const searchTerm = document.getElementById('search').value.toLowerCase();

            if (searchTerm) {
                filteredData = allData.filter(item => {
                    const name = item.file_name || item.filename_download || '';
                    return name.toLowerCase().includes(searchTerm);
                });
            } else {
                filteredData = [...allData];
            }

            totalItems = filteredData.length;
            currentPage = 1;
            updatePagination();
            renderContent();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const controls = document.getElementById('pagination-controls');

            let html = '';

            // Previous button
            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            // Next button
            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

            controls.innerHTML = html;
        }

        // Go to page
        function goToPage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            updatePagination();
            renderContent();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Close modals
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            currentEditItem = null;
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.remove('show');
        }

        function showUploadModal() {
            document.getElementById('upload-modal').classList.add('show');
        }

        // Upload files
        async function uploadFiles() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            const collection = document.getElementById('upload-collection').value;
            const progressDiv = document.getElementById('upload-progress');

            if (!files.length) {
                alert('Please select files to upload');
                return;
            }

            // Ensure themes are loaded for template collections
            if (collection === 'train_template_images' && availableTrainThemes.length === 0) {
                console.warn('Train themes not loaded, loading now...');
                await loadRelationships();
            }
            if (collection === 'worksheet_template_images' && availableWorksheetThemes.length === 0) {
                console.warn('Worksheet themes not loaded, loading now...');
                await loadRelationships();
            }

            progressDiv.innerHTML = '<div class="loading">Uploading...</div>';

            let uploaded = 0;
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${DIRECTUS_URL}/files`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` },
                        body: formData
                    });

                    if (response.ok) {
                        uploaded++;
                        progressDiv.innerHTML = `<div>Uploaded ${uploaded}/${files.length}</div>`;

                        // If adding to a collection, create the record
                        if (collection !== 'files') {
                            const fileData = await response.json();
                            console.log(`File uploaded, creating record in ${collection}:`, fileData.data);
                            await createCollectionRecord(collection, fileData.data);
                        }
                    } else {
                        console.error('File upload failed:', await response.text());
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }

            progressDiv.innerHTML = `<div class="success">✓ Uploaded ${uploaded} files</div>`;
            setTimeout(() => {
                closeUploadModal();
                loadData();
                loadStatistics();
            }, 2000);
        }

        // Create collection record
        async function createCollectionRecord(collection, fileData) {
            // Try to guess theme/style from filename or folder structure
            const fileName = fileData.filename_download.toLowerCase();
            const record = {
                file_name: fileData.filename_download.replace(/\.[^/.]+$/, ''),
                image_file: fileData.id,
                status: 'active',
                translations: {
                    en: fileData.filename_download.replace(/\.[^/.]+$/, ''),
                    de: '',
                    fr: '',
                    es: '',
                    pt: '',
                    it: '',
                    nl: '',
                    sv: '',
                    da: '',
                    no: '',
                    fi: ''
                }
            };

            // Smart theme/style assignment based on filename patterns
            if (collection === 'image_assets') {
                // Try to match theme from filename
                const animalKeywords = ['cat', 'dog', 'bird', 'lion', 'bear', 'fish', 'mouse', 'cow'];
                const foodKeywords = ['apple', 'banana', 'pizza', 'cake', 'bread'];
                const vehicleKeywords = ['car', 'bus', 'train', 'plane', 'bike'];

                if (animalKeywords.some(k => fileName.includes(k))) {
                    const animalsTheme = availableThemes.find(t => t.folder_name === 'animals');
                    if (animalsTheme) record.theme_id = animalsTheme.id;
                } else if (foodKeywords.some(k => fileName.includes(k))) {
                    const foodTheme = availableThemes.find(t => t.folder_name === 'food');
                    if (foodTheme) record.theme_id = foodTheme.id;
                } else if (vehicleKeywords.some(k => fileName.includes(k))) {
                    const vehiclesTheme = availableThemes.find(t => t.folder_name === 'vehicles');
                    if (vehiclesTheme) record.theme_id = vehiclesTheme.id;
                } else {
                    // Default to first theme
                    if (availableThemes.length > 0) record.theme_id = availableThemes[0].id;
                }
            } else if (collection === 'border_images') {
                // Check for style keywords
                if (fileName.includes('spring') || fileName.includes('flower')) {
                    const springStyle = availableStyles.find(s => s.style_name === 'spring');
                    if (springStyle) record.style_id = springStyle.id;
                } else if (fileName.includes('math') || fileName.includes('number')) {
                    const mathStyle = availableStyles.find(s => s.style_name === 'math');
                    if (mathStyle) record.style_id = mathStyle.id;
                } else {
                    // Default to first style
                    if (availableStyles.length > 0) record.style_id = availableStyles[0].id;
                }
            } else if (collection === 'background_images') {
                // Check for theme keywords and assign first matching theme
                if (availableBackgroundThemes.length > 0) {
                    // Try to find matching theme by keyword
                    let themeId = null;
                    if (fileName.includes('summer') || fileName.includes('sun')) {
                        const summerTheme = availableBackgroundThemes.find(t =>
                            t.folder_name === 'summer' || t.translations?.en?.toLowerCase().includes('summer'));
                        if (summerTheme) themeId = summerTheme.id;
                    } else if (fileName.includes('winter') || fileName.includes('snow')) {
                        const winterTheme = availableBackgroundThemes.find(t =>
                            t.folder_name === 'winter' || t.translations?.en?.toLowerCase().includes('winter'));
                        if (winterTheme) themeId = winterTheme.id;
                    }
                    // Default to first available theme
                    record.theme_id = themeId || availableBackgroundThemes[0].id;
                }
            } else if (collection === 'train_template_images') {
                // Default to first train theme if available
                console.log('Available train themes:', availableTrainThemes);
                if (availableTrainThemes.length > 0) {
                    record.theme_id = availableTrainThemes[0].id;
                    console.log('Assigned train theme_id:', record.theme_id);
                } else {
                    console.warn('No train themes available, theme_id will be null');
                    record.theme_id = null;
                }
            } else if (collection === 'worksheet_template_images') {
                // Default to first worksheet theme if available
                console.log('Available worksheet themes:', availableWorksheetThemes);
                if (availableWorksheetThemes.length > 0) {
                    record.theme_id = availableWorksheetThemes[0].id;
                    console.log('Assigned worksheet theme_id:', record.theme_id);
                } else {
                    console.warn('No worksheet themes available, theme_id will be null');
                    record.theme_id = null;
                }
            }

            console.log(`Creating record in ${collection}:`, JSON.stringify(record, null, 2));

            const response = await fetch(`${DIRECTUS_URL}/items/${collection}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(record)
            });

            if (!response.ok) {
                const error = await response.text();
                console.error(`Failed to create record in ${collection}:`, error);
                alert(`Failed to create record in ${collection}: ${error}`);
            } else {
                console.log(`Created record in ${collection}:`, record);
            }
        }

        // Sync now
        async function syncNow() {
            alert('Triggering sync... The system will update within 60 seconds.');
            // Could trigger a frontend restart or manual sync here
        }

        // Clear app caches
        async function clearAppCaches() {
            try {
                const response = await fetch('/api/cache/clear', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    // Store timestamp for client-side cache invalidation
                    localStorage.setItem('cache_cleared', result.timestamp);

                    // Show success message
                    alert('✅ Cache cleared successfully!\n\nAll apps will now load fresh data from the server.');

                    // Log cache stats
                    console.log('Cache cleared at:', new Date(result.timestamp));
                } else {
                    alert('❌ Failed to clear cache. Please try again.');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                alert('❌ Error clearing cache. Check console for details.');
            }
        }

        // Toggle all checkboxes
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBatchButton();
        }

        // Update batch button visibility
        function updateBatchButton() {
            const checked = document.querySelectorAll('.item-checkbox:checked').length;
            const batchBtn = document.getElementById('batch-btn');
            if (checked > 0) {
                batchBtn.style.display = 'inline-block';
                batchBtn.textContent = `⚡ Batch Edit (${checked})`;
            } else {
                batchBtn.style.display = 'none';
            }
        }

        // Show batch modal
        function showBatchModal() {
            const checked = document.querySelectorAll('.item-checkbox:checked');
            document.getElementById('batch-count').textContent = checked.length;
            document.getElementById('batch-modal').classList.add('show');
        }

        // Close batch modal
        function closeBatchModal() {
            document.getElementById('batch-modal').classList.remove('show');
        }

        // Update batch form based on operation
        function updateBatchForm() {
            const operation = document.getElementById('batch-operation').value;
            const formFields = document.getElementById('batch-form-fields');

            let html = '';

            if (operation === 'set-theme') {
                if (currentTab === 'image_assets') {
                    html = `
                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <select class="form-input" id="batch-theme">
                                ${availableThemes.map(theme => `
                                    <option value="${theme.id}">${theme.name?.en || theme.folder_name || 'Theme ' + theme.id}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                } else if (currentTab === 'background_images') {
                    html = `
                        <div class="form-group">
                            <label class="form-label">Background Theme</label>
                            <select class="form-input" id="batch-theme">
                                ${availableBackgroundThemes.map(theme => `
                                    <option value="${theme.id}">${theme.translations?.en || theme.folder_name || 'Theme ' + theme.id}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                } else if (currentTab === 'border_images') {
                    html = `
                        <div class="form-group">
                            <label class="form-label">Border Style</label>
                            <select class="form-input" id="batch-style">
                                ${availableStyles.map(style => `
                                    <option value="${style.id}">${style.translations?.en || style.style_name || 'Style ' + style.id}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                } else if (currentTab === 'train_templates') {
                    html = `
                        <div class="form-group">
                            <label class="form-label">Train Template Theme</label>
                            <select class="form-input" id="batch-theme">
                                ${availableTrainThemes.map(theme => `
                                    <option value="${theme.id}">${theme.translations?.en || theme.folder_name || theme.theme_name || 'Theme ' + theme.id}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                } else if (currentTab === 'worksheet_templates') {
                    html = `
                        <div class="form-group">
                            <label class="form-label">Worksheet Template Theme</label>
                            <select class="form-input" id="batch-theme">
                                ${availableWorksheetThemes.map(theme => `
                                    <option value="${theme.id}">${theme.translations?.en || theme.folder_name || theme.theme_name || 'Theme ' + theme.id}</option>
                                `).join('')}
                            </select>
                        </div>
                    `;
                }
            } else if (operation === 'set-status') {
                html = `
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="batch-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                `;
            } else if (operation === 'delete') {
                html = '<p class="error">⚠️ This will permanently delete selected items!</p>';
            }

            formFields.innerHTML = html;
        }

        // Execute batch operation
        async function executeBatchOperation() {
            const operation = document.getElementById('batch-operation').value;
            const checked = document.querySelectorAll('.item-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.value);

            if (!operation || ids.length === 0) return;

            if (operation === 'delete' && !confirm(`Delete ${ids.length} items?`)) return;

            for (const id of ids) {
                try {
                    if (operation === 'delete') {
                        const endpoint = currentTab === 'files' ? 'files' : `items/${currentTab}`;
                        await fetch(`${DIRECTUS_URL}/${endpoint}/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                        });
                    } else {
                        let updates = {};

                        if (operation === 'set-theme') {
                            if (currentTab === 'image_assets' || currentTab === 'background_images' ||
                                currentTab === 'train_templates' || currentTab === 'worksheet_templates') {
                                updates.theme_id = document.getElementById('batch-theme').value;
                            } else if (currentTab === 'border_images') {
                                updates.style_id = document.getElementById('batch-style').value;
                            }
                        } else if (operation === 'set-status') {
                            updates.status = document.getElementById('batch-status').value;
                        }

                        // Map tab names to actual collection names for templates
                        let collectionName = currentTab;
                        if (currentTab === 'train_templates') {
                            collectionName = 'train_template_images';
                        } else if (currentTab === 'worksheet_templates') {
                            collectionName = 'worksheet_template_images';
                        }

                        await fetch(`${DIRECTUS_URL}/items/${collectionName}/${id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updates)
                        });
                    }
                } catch (error) {
                    console.error(`Error processing item ${id}:`, error);
                }
            }

            closeBatchModal();
            loadData();
            loadStatistics();
            alert(`Batch operation completed for ${ids.length} items`);
        }

        // Add event listener for checkboxes after content loads
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('item-checkbox')) {
                updateBatchButton();
            }
        });

        // Load themes management view
        async function loadThemesManagement() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">Loading themes...</div>';

            try {
                // Load all theme collections
                const collections = [
                    { name: 'image_themes', label: 'Image Themes', field: 'folder_name' },
                    { name: 'border_styles', label: 'Border Styles', field: 'style_name' },
                    { name: 'background_themes', label: 'Background Themes', field: 'folder_name' },
                    { name: 'train_template_themes', label: 'Train Template Themes', field: 'name' },
                    { name: 'worksheet_template_themes', label: 'Worksheet Template Themes', field: 'name' }
                ];

                let html = `
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="showCreateThemeModal()">➕ Create New Theme</button>
                    </div>
                `;

                for (const col of collections) {
                    const response = await fetch(`${DIRECTUS_URL}/items/${col.name}?limit=100&sort=sort_order`, {
                        headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const items = data.data || [];

                        html += `
                            <div class="content-section" style="margin-bottom: 30px;">
                                <h3 style="margin-bottom: 15px; color: #667eea;">${col.label} (${items.length})</h3>
                                <table style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Folder/Name</th>
                                            <th>Display Names (EN/DE/FR)</th>
                                            <th>Sort</th>
                                            <th>Status</th>
                                            <th>Used By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        for (const item of items) {
                            const displayName = item.name?.en || item.name || item[col.field] || 'Unnamed';
                            const folderName = item[col.field] || item.folder_name || '';

                            // Count usage
                            let usageCount = 0;
                            if (col.name === 'image_themes') {
                                const countRes = await fetch(
                                    `${DIRECTUS_URL}/items/image_assets?filter[theme_id][_eq]=${item.id}&limit=1&meta=total_count`,
                                    { headers: { 'Authorization': `Bearer ${API_TOKEN}` } }
                                );
                                if (countRes.ok) {
                                    const countData = await countRes.json();
                                    usageCount = countData.meta?.total_count || 0;
                                }
                            }

                            html += `
                                <tr>
                                    <td>${item.id}</td>
                                    <td><code>${folderName}</code></td>
                                    <td>
                                        <div style="font-size: 12px;">
                                            <strong>EN:</strong> ${item.name?.en || item.translations?.en || displayName}<br>
                                            <span style="color: #666;">DE: ${item.name?.de || item.translations?.de || '-'}</span><br>
                                            <span style="color: #666;">FR: ${item.name?.fr || item.translations?.fr || '-'}</span>
                                        </div>
                                    </td>
                                    <td>${item.sort_order || 999}</td>
                                    <td>
                                        <span class="status-indicator ${item.is_active ? 'status-active' : 'status-inactive'}"></span>
                                        ${item.is_active ? 'Active' : 'Inactive'}
                                    </td>
                                    <td>${usageCount > 0 ? `${usageCount} items` : '-'}</td>
                                    <td class="actions">
                                        <button class="action-btn edit-btn" onclick="editTheme('${col.name}', ${item.id})">Edit</button>
                                        <button class="action-btn delete-btn" onclick="deleteTheme('${col.name}', ${item.id}, ${usageCount})">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                }

                contentArea.innerHTML = html;

            } catch (error) {
                contentArea.innerHTML = `<div class="error">Error loading themes: ${error.message}</div>`;
            }
        }

        // Show create theme modal
        function showCreateThemeModal() {
            currentEditItem = null;
            document.getElementById('theme-folder').value = '';
            // Clear all 11 language fields
            const languages = ['en', 'de', 'fr', 'es', 'pt', 'it', 'nl', 'sv', 'da', 'no', 'fi'];
            languages.forEach(lang => {
                const field = document.getElementById(`theme-name-${lang}`);
                if (field) field.value = '';
            });
            document.getElementById('theme-sort').value = '999';
            document.getElementById('theme-active').checked = true;
            document.getElementById('theme-modal').classList.add('show');
        }

        // Edit theme
        async function editTheme(collection, id) {
            currentEditItem = { collection, id };

            const response = await fetch(`${DIRECTUS_URL}/items/${collection}/${id}`, {
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });

            if (response.ok) {
                const data = await response.json();
                const item = data.data;

                document.getElementById('theme-type').value = collection;
                document.getElementById('theme-folder').value = item.folder_name || item.style_name || '';

                // Load all 11 language values
                const languages = ['en', 'de', 'fr', 'es', 'pt', 'it', 'nl', 'sv', 'da', 'no', 'fi'];
                languages.forEach(lang => {
                    const field = document.getElementById(`theme-name-${lang}`);
                    if (field) {
                        if (collection === 'border_styles') {
                            field.value = item.translations?.[lang] || '';
                        } else {
                            field.value = item.name?.[lang] || '';
                        }
                    }
                });

                document.getElementById('theme-sort').value = item.sort_order || 999;
                document.getElementById('theme-active').checked = item.is_active !== false;
                document.getElementById('theme-modal').classList.add('show');
            }
        }

        // Save theme
        async function saveTheme() {
            const collection = document.getElementById('theme-type').value;
            const folderName = document.getElementById('theme-folder').value;
            const nameEn = document.getElementById('theme-name-en').value;

            if (!folderName || !nameEn) {
                alert('Folder name and English name are required!');
                return;
            }

            const themeData = {
                is_active: document.getElementById('theme-active').checked,
                sort_order: parseInt(document.getElementById('theme-sort').value) || 999
            };

            // Build translations object with all 11 languages
            const languages = ['en', 'de', 'fr', 'es', 'pt', 'it', 'nl', 'sv', 'da', 'no', 'fi'];
            const translations = {};

            languages.forEach(lang => {
                const field = document.getElementById(`theme-name-${lang}`);
                if (field && field.value) {
                    translations[lang] = field.value;
                } else if (lang !== 'en') {
                    // Default to English for empty fields
                    translations[lang] = nameEn;
                }
            });

            // Set the appropriate field name based on collection
            if (collection === 'border_styles') {
                themeData.style_name = folderName;
                themeData.translations = translations;
            } else {
                themeData.folder_name = folderName;
                themeData.name = translations;
            }

            try {
                let response;
                if (currentEditItem) {
                    // Update existing
                    response = await fetch(`${DIRECTUS_URL}/items/${currentEditItem.collection}/${currentEditItem.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(themeData)
                    });
                } else {
                    // Create new
                    response = await fetch(`${DIRECTUS_URL}/items/${collection}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(themeData)
                    });
                }

                if (response.ok) {
                    closeThemeModal();
                    loadThemesManagement();
                    await loadRelationships(); // Reload available themes
                    alert('Theme saved successfully!');
                } else {
                    const error = await response.text();
                    alert('Failed to save theme: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Delete theme
        async function deleteTheme(collection, id, usageCount) {
            if (usageCount > 0) {
                alert(`Cannot delete theme: It is used by ${usageCount} items. Please reassign them first.`);
                return;
            }

            if (!confirm('Are you sure you want to delete this theme?')) return;

            try {
                const response = await fetch(`${DIRECTUS_URL}/items/${collection}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });

                if (response.ok) {
                    loadThemesManagement();
                    await loadRelationships(); // Reload available themes
                    alert('Theme deleted successfully!');
                } else {
                    alert('Failed to delete theme');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close theme modal
        function closeThemeModal() {
            document.getElementById('theme-modal').classList.remove('show');
            currentEditItem = null;
        }

        // Quick create theme
        function quickCreateTheme() {
            const themeName = prompt('Enter theme name (e.g., "vehicles", "sports", "nature"):')
            if (!themeName) return;

            const displayName = prompt('Enter display name (e.g., "Vehicles", "Sports", "Nature"):')
            if (!displayName) return;

            // Determine collection based on current tab
            let collection = 'image_themes';
            if (currentTab === 'border_images') collection = 'border_styles';
            else if (currentTab === 'background_images') collection = 'background_themes';
            else if (currentTab === 'train_templates') collection = 'train_template_themes';
            else if (currentTab === 'worksheet_templates') collection = 'worksheet_template_themes';

            const themeData = {
                is_active: true,
                sort_order: 999
            };

            // Create translations object with all 11 languages defaulting to display name
            const fullTranslations = {
                en: displayName,
                de: displayName,
                fr: displayName,
                es: displayName,
                pt: displayName,
                it: displayName,
                nl: displayName,
                sv: displayName,
                da: displayName,
                no: displayName,
                fi: displayName
            };

            if (collection === 'border_styles') {
                themeData.style_name = themeName.toLowerCase().replace(/\s+/g, '_');
                themeData.translations = fullTranslations;
            } else {
                themeData.folder_name = themeName.toLowerCase().replace(/\s+/g, '_');
                themeData.name = fullTranslations;
            }

            fetch(`${DIRECTUS_URL}/items/${collection}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(themeData)
            }).then(response => {
                if (response.ok) {
                    alert(`Theme "${displayName}" created successfully!`);
                    loadRelationships();
                    if (currentTab === 'themes') {
                        loadThemesManagement();
                    }
                } else {
                    alert('Failed to create theme');
                }
            }).catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>