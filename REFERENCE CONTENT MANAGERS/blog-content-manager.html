<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Content Manager - HTML & PDF Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--gray-900);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .subtitle {
            color: var(--gray-400);
            margin-top: 5px;
            font-size: 14px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--gray-100);
            border-bottom: 2px solid var(--gray-200);
        }

        .nav-tab {
            padding: 20px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.3s;
            position: relative;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .nav-tab.active {
            color: var(--primary);
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Components */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-control {
            padding: 10px 15px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        /* HTML Editor */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 600px;
            margin-bottom: 30px;
        }

        .editor-panel {
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            background: var(--gray-100);
            padding: 15px;
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 600;
            color: var(--gray-700);
        }

        .editor-textarea {
            flex: 1;
            padding: 20px;
            border: none;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: none;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .preview-iframe {
            flex: 1;
            border: none;
            background: white;
        }

        /* PDF Section */
        .pdf-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .pdf-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .pdf-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pdf-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .pdf-thumbnail {
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .pdf-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pdf-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .pdf-info {
            padding: 15px;
        }

        .pdf-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .pdf-description {
            font-size: 13px;
            color: var(--gray-600);
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .pdf-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .pdf-size {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--gray-500);
        }

        .pdf-actions {
            display: flex;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 6px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--gray-50);
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Translation Manager */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .language-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .language-card.complete {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .language-flag {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .language-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 5px;
        }

        .language-status {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        /* Loading */
        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login overlay styles */
        .login-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .login-overlay.active {
            display: flex;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            font-size: 28px;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--gray-600);
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìù Blog Content Manager</h1>
                <div class="subtitle">Manage blog posts with HTML content and PDF worksheets</div>
            </div>
            <button class="btn btn-primary" onclick="createNewPost()">
                ‚ûï New Blog Post
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('posts')">Blog Posts</button>
            <button class="nav-tab" onclick="switchTab('editor')">HTML Editor</button>
            <button class="nav-tab" onclick="switchTab('pdfs')">PDF Manager</button>
            <button class="nav-tab" onclick="switchTab('translations')">Translations</button>
        </div>

        <!-- Tab Contents -->
        <div id="posts-tab" class="tab-content active">
            <div class="alert alert-info">
                ‚ÑπÔ∏è Click on any blog post to edit it. You can manage HTML content, PDFs, and translations for each post.
            </div>

            <div id="postsList">
                <!-- Blog posts will be loaded here -->
            </div>

            <!-- Pagination Controls -->
            <div id="paginationControls" style="margin-top: 30px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <!-- Posts info and items per page -->
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <div style="color: var(--gray-700); font-weight: 500;">
                            <span id="paginationInfo">Showing 0-0 of 0 posts</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: var(--gray-600); font-size: 14px;">Posts per page:</label>
                            <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)"
                                    style="padding: 5px 10px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                    </div>

                    <!-- Page navigation -->
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button id="prevPageBtn" onclick="prevPage()"
                                style="padding: 8px 16px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer; font-weight: 500; color: var(--gray-700); transition: all 0.2s;"
                                onmouseover="this.style.background='var(--gray-100)'"
                                onmouseout="this.style.background='white'">
                            ‚Üê Previous
                        </button>
                        <div id="pageNumbers" style="display: flex; gap: 5px;">
                            <!-- Page number buttons will be inserted here -->
                        </div>
                        <button id="nextPageBtn" onclick="nextPage()"
                                style="padding: 8px 16px; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer; font-weight: 500; color: var(--gray-700); transition: all 0.2s;"
                                onmouseover="this.style.background='var(--gray-100)'"
                                onmouseout="this.style.background='white'">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="editor-tab" class="tab-content">
            <h2>Edit Blog Post Content</h2>

            <div id="currentPostIndicator" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 5px;">‚úÖ Currently Editing:</div>
                <div id="currentPostSlug" style="font-size: 16px; font-weight: 700;"></div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Blog Post</label>
                    <select id="editorPostSelect" class="form-control" onchange="loadPostForEditing()">
                        <option value="">-- Select a post --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Language</label>
                    <select id="editorLanguage" class="form-control" onchange="loadPostForEditing()">
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="it">Italiano</option>
                        <option value="nl">Nederlands</option>
                        <option value="sv">Svenska</option>
                        <option value="da">Dansk</option>
                        <option value="no">Norsk</option>
                        <option value="fi">Suomi</option>
                    </select>
                </div>
            </div>

            <!-- SEO Optimization Section -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: white; margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                    üéØ SEO Optimization
                    <span id="seoScoreBadge" style="margin-left: auto; background: white; color: #667eea; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                        Score: <span id="seoScoreValue">0</span>/100
                    </span>
                </h3>
                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">Optimize your content for search engines in <strong id="currentLanguageName">English</strong></p>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">üìù Post Title</label>
                    <input type="text" id="postTitle" class="form-control" placeholder="Enter post title" oninput="updateSEOAnalysis()">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        <span id="titleLength">0</span> characters (Recommended: 50-60)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">üîó URL Slug</label>
                    <input type="text" id="postSlug" class="form-control" placeholder="url-slug">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">SEO-friendly URL (lowercase, hyphens only)</small>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">üéØ Focus Keyword / Keyphrase</label>
                <input type="text" id="postFocusKeyword" class="form-control" placeholder="e.g., math worksheets for kids" oninput="updateSEOAnalysis()">
                <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                    Main keyword you want to rank for in this language
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">üìÑ SEO Title (Meta Title)</label>
                <input type="text" id="postMetaTitle" class="form-control" placeholder="Optimized title for search results" oninput="updateSEOAnalysis()">
                <small style="display: block; margin-top: 5px;">
                    <span id="metaTitleLength" style="color: var(--gray-500);">0</span> characters
                    <span id="metaTitleStatus" style="margin-left: 10px;"></span>
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">üìù Meta Description</label>
                <textarea id="postMetaDescription" class="form-control" rows="3" placeholder="Compelling description for search results (150-160 characters recommended)" oninput="updateSEOAnalysis()"></textarea>
                <small style="display: block; margin-top: 5px;">
                    <span id="metaDescLength" style="color: var(--gray-500);">0</span> characters
                    <span id="metaDescStatus" style="margin-left: 10px;"></span>
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">üè∑Ô∏è Additional Keywords</label>
                <input type="text" id="postKeywords" class="form-control" placeholder="keyword1, keyword2, keyword3">
                <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                    Comma-separated related keywords (5-10 recommended)
                </small>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Featured Image</label>
                    <div id="featuredImageDropzone" style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--gray-50);">
                        <div id="featuredImagePlaceholder">
                            <div style="font-size: 48px; margin-bottom: 10px;">üñºÔ∏è</div>
                            <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 5px;">Drop image here or click to browse</div>
                            <div style="font-size: 13px; color: var(--gray-500);">PNG, JPG, or WEBP (Max 5MB)</div>
                        </div>
                        <div id="featuredImagePreview" style="display: none;">
                            <img id="featuredImagePreviewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;" />
                            <div id="featuredImageName" style="font-size: 14px; color: var(--gray-700); margin-bottom: 10px;"></div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeFeaturedImage(event)">Remove Image</button>
                        </div>
                    </div>
                    <input type="file" id="postFeaturedImageFile" accept="image/*" style="display: none;">
                    <input type="hidden" id="postFeaturedImage">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">Optional: Thumbnail image for blog post listing</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <select id="postCategory" class="form-control" style="flex: 1;">
                            <!-- Categories will be loaded dynamically -->
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openCategoryManager()" style="white-space: nowrap;">
                            ‚öôÔ∏è Manage
                        </button>
                    </div>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px;">üì• PDF Section Content (Appears at bottom of blog)</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">PDF Section Title</label>
                    <input type="text" id="postPdfSectionTitle" class="form-control" placeholder="e.g., Free Sample Worksheets">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Title shown above the downloadable worksheets (translatable per language)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">PDF Section Description</label>
                    <input type="text" id="postPdfSectionDescription" class="form-control" placeholder="e.g., Premium educational resources designed by experts">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Description text below the title (translatable per language)
                    </small>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">PDF "Free" Label</label>
                    <input type="text" id="postPdfFreeLabel" class="form-control" placeholder="e.g., Free, Gratis, Gratuit">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Translation for "Free" price label (translatable per language)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">PDF "Premium" Label</label>
                    <input type="text" id="postPdfPremiumLabel" class="form-control" placeholder="e.g., Premium, Premium, Pr√©mium">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Translation for "Premium" price label (translatable per language)
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">PDF Download Button Text</label>
                    <input type="text" id="postPdfDownloadButton" class="form-control" placeholder="e.g., Download Now">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Button text for downloading PDFs - emojis and arrows are automatically removed (translatable per language)
                    </small>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px;">HTML Content</h3>
            <div class="editor-container">
                <div class="editor-panel">
                    <div class="editor-header">
                        <span class="editor-title">HTML Code</span>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="pasteHTML()">üìã Paste</button>
                            <button class="btn btn-sm btn-secondary" onclick="copyHTML()">üìë Copy</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearHTML()">üóë Clear</button>
                        </div>
                    </div>
                    <textarea id="htmlEditor" class="editor-textarea" placeholder="Paste your HTML content here..."></textarea>
                </div>
                <div class="editor-panel">
                    <div class="editor-header">
                        <span class="editor-title">Preview</span>
                        <button class="btn btn-sm btn-primary" onclick="refreshPreview()">üîÑ Refresh</button>
                    </div>
                    <iframe id="previewFrame" class="preview-iframe"></iframe>
                </div>
            </div>

            <!-- SEO Analysis & Previews -->
            <div style="margin: 30px 0;">
                <h3 style="margin-bottom: 20px;">üìä SEO Analysis & Previews</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- SEO Checklist -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            ‚úÖ SEO Checklist
                        </h4>
                        <div id="seoChecklist" style="font-size: 14px;">
                            <!-- Checklist items will appear here -->
                        </div>
                    </div>

                    <!-- Content Analysis -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            üìà Content Analysis
                        </h4>
                        <div id="contentAnalysis" style="font-size: 14px;">
                            <!-- Analysis will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Preview Cards -->
                <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--gray-900);">üîç Search Engine Preview</h4>
                    <div id="googlePreview" style="max-width: 600px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-family: Arial, sans-serif;">
                        <div style="font-size: 20px; color: #1a0dab; margin-bottom: 5px; cursor: pointer;" id="googlePreviewTitle">Your SEO Title Will Appear Here</div>
                        <div style="font-size: 14px; color: #006621; margin-bottom: 5px;" id="googlePreviewUrl">https://yoursite.com/blog/your-slug</div>
                        <div style="font-size: 14px; color: #545454; line-height: 1.5;" id="googlePreviewDesc">Your meta description will appear here. Make it compelling to improve click-through rates!</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Facebook Preview -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900);">üìò Facebook Preview</h4>
                        <div id="facebookPreview" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; font-family: Arial, sans-serif;">
                            <div id="fbPreviewImage" style="width: 100%; height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                                üñºÔ∏è
                            </div>
                            <div style="padding: 12px; background: #f2f3f5;">
                                <div style="font-size: 12px; color: #606770; text-transform: uppercase; margin-bottom: 4px;">YOURSITE.COM</div>
                                <div id="fbPreviewTitle" style="font-size: 16px; color: #1c1e21; font-weight: 600; margin-bottom: 4px;">Your Post Title</div>
                                <div id="fbPreviewDesc" style="font-size: 14px; color: #606770;">Your meta description...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Twitter Preview -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900);">üê¶ Twitter Preview</h4>
                        <div id="twitterPreview" style="border: 1px solid #cfd9de; border-radius: 16px; overflow: hidden; font-family: Arial, sans-serif;">
                            <div id="twitterPreviewImage" style="width: 100%; height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;">
                                üñºÔ∏è
                            </div>
                            <div style="padding: 12px;">
                                <div id="twitterPreviewTitle" style="font-size: 15px; color: #0f1419; font-weight: 700; margin-bottom: 4px; line-height: 1.3;">Your Post Title</div>
                                <div id="twitterPreviewDesc" style="font-size: 15px; color: #536471; margin-bottom: 8px; line-height: 1.3;">Your meta description...</div>
                                <div style="font-size: 13px; color: #536471;">üîó yoursite.com</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced SEO Analysis Panels -->
            <div style="margin: 30px 0;">
                <h3 style="margin-bottom: 20px;">üî¨ Advanced SEO Analysis</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Readability Score -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            üìñ Readability
                        </h4>
                        <div id="readabilityScore" style="font-size: 14px;">
                            <!-- Readability analysis will appear here -->
                        </div>
                    </div>

                    <!-- Content Quality Score -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            ‚≠ê Quality Score
                        </h4>
                        <div id="qualityScore" style="font-size: 14px;">
                            <!-- Quality score will appear here -->
                        </div>
                    </div>

                    <!-- LSI Keywords -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            üîë Related Keywords
                        </h4>
                        <div id="lsiKeywords" style="font-size: 14px;">
                            <!-- LSI keywords will appear here -->
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Heading Hierarchy -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            üìã Heading Structure
                        </h4>
                        <div id="headingHierarchy" style="font-size: 14px;">
                            <!-- Heading hierarchy will appear here -->
                        </div>
                    </div>

                    <!-- Image Alt Text Analysis -->
                    <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                            üñºÔ∏è Image Optimization
                        </h4>
                        <div id="imageAnalysis" style="font-size: 14px;">
                            <!-- Image analysis will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Schema Markup Preview -->
                <div style="background: white; border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--gray-900); display: flex; align-items: center; gap: 10px;">
                        üèóÔ∏è Schema Markup (JSON-LD)
                        <button onclick="copySchemaToClipboard()" style="margin-left: auto; padding: 5px 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üìã Copy to Clipboard
                        </button>
                    </h4>
                    <div style="background: var(--gray-50); border-radius: 4px; padding: 15px; max-height: 300px; overflow-y: auto;">
                        <pre id="schemaMarkup" style="margin: 0; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;">
<!-- Schema markup will appear here -->
                        </pre>
                    </div>
                    <small style="display: block; margin-top: 10px; color: var(--gray-600);">
                        ‚ÑπÔ∏è Add this JSON-LD schema to your blog post's <code>&lt;head&gt;</code> section for rich snippets in search results
                    </small>
                </div>
            </div>

            <!-- PDF Downloads Section -->
            <div class="pdf-section">
                <div class="pdf-header">
                    <h3 class="pdf-title">
                        üìÑ PDF Worksheets
                    </h3>
                    <button class="btn btn-primary" onclick="openPDFModal()">
                        ‚ûï Add PDF
                    </button>
                </div>

                <div id="pdfGrid" class="pdf-grid">
                    <!-- PDF cards will appear here -->
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-success" onclick="savePost()">üíæ Save Changes</button>
                <button class="btn btn-primary" onclick="publishPost()">üöÄ Publish to Static HTML</button>
                <button class="btn btn-primary" onclick="previewFullPage()">üëÅ Preview Full Page</button>
                <button class="btn btn-secondary" onclick="exportHTML()">‚¨á Export HTML</button>
            </div>
            <div style="margin-top: 10px; font-size: 13px; color: var(--gray-600);">
                üí° <strong>Tip:</strong> Click "Save Changes" first to save your content to the database, then click "Publish to Static HTML" to generate static files for all languages.
            </div>
        </div>

        <div id="pdfs-tab" class="tab-content">
            <h2>PDF Worksheet Manager</h2>

            <div class="form-group" style="max-width: 400px; margin-bottom: 30px;">
                <label class="form-label">Select Blog Post</label>
                <select id="pdfManagerPostSelect" class="form-control" onchange="loadPDFsForPost()">
                    <option value="">-- Select a post --</option>
                </select>
            </div>

            <div id="pdfManagerContent" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Sample PDFs for this Post</h3>
                    <button class="btn btn-primary" onclick="openPDFModal()">
                        ‚ûï Add PDF
                    </button>
                </div>

                <div id="pdfsList" class="pdf-grid">
                    <!-- PDFs will be shown here -->
                </div>

                <div id="noPDFsMessage" style="display: none; padding: 40px; text-align: center; color: var(--gray-500);">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                    <p>No PDF worksheets attached to this post yet.</p>
                    <button class="btn btn-primary" onclick="openPDFModal()">Add Your First PDF</button>
                </div>
            </div>

            <div id="pdfManagerPlaceholder" style="padding: 60px 20px; text-align: center; color: var(--gray-500);">
                <div style="font-size: 64px; margin-bottom: 20px;">üìö</div>
                <h3>Select a Blog Post</h3>
                <p>Choose a blog post from the dropdown above to manage its PDF worksheets.</p>
            </div>
        </div>

        <div id="translations-tab" class="tab-content">
            <h2>Translation Manager</h2>

            <div class="form-group" style="max-width: 400px;">
                <label class="form-label">Select Blog Post</label>
                <select id="translationPostSelect" class="form-control" onchange="loadTranslations()">
                    <option value="">-- Select a post --</option>
                </select>
            </div>

            <div class="alert alert-info">
                ‚ÑπÔ∏è Each language version requires its own HTML content. Click on a language to add or edit the translation.
            </div>

            <div id="languageGrid" class="language-grid">
                <!-- Language cards will appear here -->
            </div>
        </div>
    </div>

    <!-- PDF Add/Edit Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add PDF Worksheet</h3>
                <button class="modal-close" onclick="closePDFModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">PDF File</label>
                    <input type="file" id="modalPDFFile" accept=".pdf" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="modalPDFTitle" class="form-control" placeholder="e.g., 1 Minute Math Addition">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="modalPDFDescription" class="form-control" placeholder="Premium educational worksheet designed to enhance learning..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail (optional)</label>
                    <input type="file" id="modalPDFThumbnail" accept="image/*" class="form-control">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">File Size</label>
                        <input type="text" id="modalPDFSize" class="form-control" placeholder="e.g., 145.2 KB" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <select id="modalPDFPrice" class="form-control">
                            <option value="free">Free</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePDFModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePDF()">Add PDF</button>
            </div>
        </div>
    </div>

    <!-- Edit PDF Modal -->
    <div id="editPDFModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit PDF Worksheet</h3>
                <button class="modal-close" onclick="closeEditPDFModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPDFId">

                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="editPDFTitle" class="form-control" placeholder="e.g., 1 Minute Math Addition">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editPDFDescription" class="form-control" rows="3" placeholder="Premium educational worksheet designed to enhance learning..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Update Thumbnail (optional)</label>
                    <div id="currentThumbnailPreview" style="margin-bottom: 10px; display: none;">
                        <p style="font-size: 12px; color: var(--gray-600); margin-bottom: 5px;">Current thumbnail:</p>
                        <img id="currentThumbnailImg" src="" alt="Current thumbnail"
                             style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 2px solid var(--gray-200);">
                    </div>
                    <input type="file" id="editPDFThumbnail" accept="image/*" class="form-control">
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Leave empty to keep current thumbnail
                    </small>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Current File</label>
                        <div id="editPDFFileName" style="padding: 10px; background: var(--gray-50); border-radius: 6px; font-size: 14px; color: var(--gray-700);">
                            <!-- Filename will be shown here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price</label>
                        <select id="editPDFPrice" class="form-control">
                            <option value="Free">Free</option>
                            <option value="Premium">Premium</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditPDFModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedPDF()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üìÅ Manage Blog Categories</h2>
                <button class="modal-close" onclick="closeCategoryManager()">√ó</button>
            </div>

            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">Add New Category</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategoryId" class="form-control" placeholder="category-id" style="flex: 1;">
                        <input type="text" id="newCategoryLabel" class="form-control" placeholder="Category Label" style="flex: 1;">
                        <button class="btn btn-primary" onclick="addCategory()">Add</button>
                    </div>
                    <small style="color: var(--gray-500); display: block; margin-top: 5px;">
                        Category ID should be lowercase with hyphens (e.g., "my-category")
                    </small>
                </div>

                <h3 style="margin-bottom: 10px;">Existing Categories</h3>
                <div id="categoriesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCategoryManager()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Category Translations Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">üåê Edit Category Translations</h2>
                <button class="modal-close" onclick="closeEditCategoryModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">Category ID</label>
                    <input type="text" id="editCategoryId" class="form-control" readonly style="background: var(--gray-100);">
                </div>

                <h3 style="margin-bottom: 15px; color: var(--gray-700);">Translations</h3>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá¨üáß English (en)</label>
                        <input type="text" id="editCategoryEn" class="form-control" placeholder="English">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá©üá™ German (de)</label>
                        <input type="text" id="editCategoryDe" class="form-control" placeholder="German">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá´üá∑ French (fr)</label>
                        <input type="text" id="editCategoryFr" class="form-control" placeholder="French">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá™üá∏ Spanish (es)</label>
                        <input type="text" id="editCategoryEs" class="form-control" placeholder="Spanish">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üáµüáπ Portuguese (pt)</label>
                        <input type="text" id="editCategoryPt" class="form-control" placeholder="Portuguese">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üáÆüáπ Italian (it)</label>
                        <input type="text" id="editCategoryIt" class="form-control" placeholder="Italian">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá≥üá± Dutch (nl)</label>
                        <input type="text" id="editCategoryNl" class="form-control" placeholder="Dutch">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá∏üá™ Swedish (sv)</label>
                        <input type="text" id="editCategorySv" class="form-control" placeholder="Swedish">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá©üá∞ Danish (da)</label>
                        <input type="text" id="editCategoryDa" class="form-control" placeholder="Danish">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá≥üá¥ Norwegian (no)</label>
                        <input type="text" id="editCategoryNo" class="form-control" placeholder="Norwegian">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--gray-700); display: block; margin-bottom: 5px;">üá´üáÆ Finnish (fi)</label>
                        <input type="text" id="editCategoryFi" class="form-control" placeholder="Finnish">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditCategoryModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCategoryTranslations()">Save Translations</button>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="login-header">
                <h2>üîí Admin Login</h2>
                <p>Please sign in to manage blog content</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <input
                    type="email"
                    class="login-input"
                    id="loginEmail"
                    placeholder="Email address"
                    value="admin@lessoncraftstudio.com"
                    required
                >
                <input
                    type="password"
                    class="login-input"
                    id="loginPassword"
                    placeholder="Password"
                    required
                >
                <button type="submit" class="login-btn" id="loginBtn">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <script>
        // Use dynamic URL that works in all environments
        const API_URL = window.location.origin;

        // Get authentication token from localStorage
        function getAuthToken() {
            return localStorage.getItem('accessToken') || '';
        }

        // Generate or retrieve device ID
        function getDeviceId() {
            // Check if we already have a device ID stored
            let deviceId = localStorage.getItem('deviceId');

            if (!deviceId) {
                // Generate a unique device ID based on browser characteristics
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                const debugInfo = gl ? gl.getExtension('WEBGL_debug_renderer_info') : null;
                const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : '';

                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    renderer,
                    navigator.hardwareConcurrency || '',
                    navigator.deviceMemory || ''
                ].join('|');

                // Create hash of fingerprint
                deviceId = 'device_' + btoa(fingerprint).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);

                // Store for future use
                localStorage.setItem('deviceId', deviceId);
            }

            return deviceId;
        }

        // Show login overlay
        function showLoginOverlay() {
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('loginPassword').value = ''; // Clear password
            document.getElementById('loginEmail').focus();
        }

        // Hide login overlay
        function hideLoginOverlay() {
            document.getElementById('loginOverlay').classList.remove('active');
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            // Clear previous errors
            loginError.classList.remove('show');
            loginError.textContent = '';

            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                // Get device ID for authentication
                const deviceId = getDeviceId();

                const response = await fetch(`${API_URL}/api/auth/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        deviceId,
                        rememberMe: false
                    }),
                });

                if (response.ok) {
                    const data = await response.json();

                    // Store token
                    if (data.accessToken) {
                        localStorage.setItem('accessToken', data.accessToken);

                        // Hide login overlay
                        hideLoginOverlay();

                        // Show success message
                        showMessage('Successfully logged in!', 'success');

                        // Reload the current tab content
                        const activeTab = document.querySelector('.nav-tab.active');
                        if (activeTab) {
                            activeTab.click();
                        }
                    } else {
                        throw new Error('No access token received');
                    }
                } else if (response.status === 409) {
                    // Device conflict - user is signed in on another device
                    const conflictData = await response.json();

                    if (confirm(
                        `You're already signed in on another device:\n\n` +
                        `Device: ${conflictData.currentSession?.deviceName || 'Unknown'}\n` +
                        `Last active: ${conflictData.currentSession?.lastActive ? new Date(conflictData.currentSession.lastActive).toLocaleString() : 'Unknown'}\n\n` +
                        `Do you want to sign out from that device and sign in here?`
                    )) {
                        // User wants to force sign-in - call force-signin endpoint
                        const forceResponse = await fetch(`${API_URL}/api/auth/force-signin`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email,
                                password,
                                deviceId,
                                rememberMe: false
                            }),
                        });

                        if (forceResponse.ok) {
                            const data = await forceResponse.json();
                            localStorage.setItem('accessToken', data.accessToken);
                            hideLoginOverlay();
                            showMessage('Successfully logged in!', 'success');

                            // Reload the current tab content
                            const activeTab = document.querySelector('.nav-tab.active');
                            if (activeTab) {
                                activeTab.click();
                            }
                        } else {
                            const error = await forceResponse.json();
                            loginError.textContent = error.error || 'Failed to sign in';
                            loginError.classList.add('show');
                        }
                    } else {
                        // User cancelled
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sign In';
                        return;
                    }
                } else {
                    const error = await response.json();
                    loginError.textContent = error.error || 'Invalid email or password';
                    loginError.classList.add('show');
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Login failed. Please try again.';
                loginError.classList.add('show');
            } finally {
                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        // Helper function to make authenticated requests
        async function authenticatedFetch(url, options = {}) {
            const token = getAuthToken();

            if (!token) {
                showLoginOverlay();
                throw new Error('No auth token');
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                },
            });

            // If we get 401, token might be expired - show login again
            if (response.status === 401) {
                showLoginOverlay();
                throw new Error('Authentication required');
            }

            return response;
        }

        // Global variables
        let currentPost = null;
        let currentLanguage = 'en';
        let posts = [];
        let pdfLibrary = [];
        let currentPDFs = [];
        // Pagination variables
        let currentPage = 1;
        let itemsPerPage = 10;
        let blogCategories = [
            { id: 'teaching-resources', label: 'Teaching Resources' },
            { id: 'worksheet-tips', label: 'Worksheet Tips' },
            { id: 'educational-activities', label: 'Educational Activities' },
            { id: 'learning-strategies', label: 'Learning Strategies' },
            { id: 'curriculum-guides', label: 'Curriculum Guides' },
            { id: 'parent-resources', label: 'Parent Resources' },
            { id: 'seasonal-content', label: 'Seasonal Content' }
        ];

        // Featured Image Upload Functions
        function initFeaturedImageUpload() {
            const dropzone = document.getElementById('featuredImageDropzone');
            const fileInput = document.getElementById('postFeaturedImageFile');

            // Click to browse
            dropzone.addEventListener('click', (e) => {
                if (!e.target.classList.contains('btn')) {
                    fileInput.click();
                }
            });

            // File input change
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await handleFeaturedImageUpload(file);
                }
            });

            // Drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.borderColor = 'var(--primary-500)';
                dropzone.style.background = 'var(--primary-50)';
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.style.borderColor = 'var(--gray-300)';
                dropzone.style.background = 'var(--gray-50)';
            });

            dropzone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropzone.style.borderColor = 'var(--gray-300)';
                dropzone.style.background = 'var(--gray-50)';

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    await handleFeaturedImageUpload(file);
                } else {
                    showMessage('Please drop an image file', 'error');
                }
            });
        }

        async function handleFeaturedImageUpload(file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('Image size must be less than 5MB', 'error');
                return;
            }

            // Validate file type
            if (!file.type.match(/^image\/(png|jpe?g|webp)$/)) {
                showMessage('Only PNG, JPG, and WEBP images are allowed', 'error');
                return;
            }

            try {
                // Show loading state
                showMessage('Uploading image...', 'info');

                // Upload to server
                const formData = new FormData();
                formData.append('image', file);
                formData.append('type', 'featured');

                const response = await authenticatedFetch('/api/admin/blog/upload-image', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    const imagePath = data.path;

                    // Update hidden input
                    document.getElementById('postFeaturedImage').value = imagePath;

                    // üîÑ SYNC FIX: Update currentPost object immediately
                    if (currentPost) {
                        currentPost.featuredImage = imagePath;
                        console.log('‚úÖ currentPost.featuredImage synced:', imagePath);
                    }

                    // Show preview
                    document.getElementById('featuredImagePlaceholder').style.display = 'none';
                    document.getElementById('featuredImagePreview').style.display = 'block';
                    document.getElementById('featuredImagePreviewImg').src = imagePath;
                    document.getElementById('featuredImageName').textContent = file.name;

                    console.log('‚úÖ Featured image uploaded:', imagePath);
                    showMessage('Image uploaded! Remember to click "Save Changes" to save the post with this image.', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage(`Upload failed: ${error.message}`, 'error');
            }
        }

        function removeFeaturedImage(event) {
            event.stopPropagation();

            document.getElementById('postFeaturedImage').value = '';
            document.getElementById('postFeaturedImageFile').value = '';
            document.getElementById('featuredImagePlaceholder').style.display = 'block';
            document.getElementById('featuredImagePreview').style.display = 'none';
            document.getElementById('featuredImagePreviewImg').src = '';
            document.getElementById('featuredImageName').textContent = '';

            showMessage('Featured image removed', 'info');
        }

        // Category Management Functions
        async function loadCategories() {
            const select = document.getElementById('postCategory');
            await loadCategoriesFromAPI();
            select.innerHTML = blogCategories.map(cat =>
                `<option value="${cat.id}">${cat.label}</option>`
            ).join('');
        }

        async function loadCategoriesFromAPI() {
            try {
                const response = await authenticatedFetch('/api/admin/blog/categories', {});
                if (response.ok) {
                    const data = await response.json();
                    // Transform to simple format for dropdown (using English labels)
                    blogCategories = data.categories.map(cat => ({
                        id: cat.id,
                        label: cat.translations.en
                    }));
                } else {
                    console.error('Failed to load categories from API');
                }
            } catch (error) {
                console.error('Error loading categories from API:', error);
            }
        }

        function displayCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = blogCategories.map(cat => `
                <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--gray-900);">${cat.label}</div>
                        <div style="font-size: 13px; color: var(--gray-500); font-family: monospace;">${cat.id}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="editCategory('${cat.id}')" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openCategoryManager() {
            displayCategoriesList();
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryManager() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryId').value = '';
            document.getElementById('newCategoryLabel').value = '';
        }

        async function addCategory() {
            const id = document.getElementById('newCategoryId').value.trim();
            const label = document.getElementById('newCategoryLabel').value.trim();

            if (!id || !label) {
                showMessage('Please provide both category ID and label (English)', 'error');
                return;
            }

            // Validate ID format (lowercase, hyphens only)
            if (!/^[a-z0-9-]+$/.test(id)) {
                showMessage('Category ID must be lowercase letters, numbers, and hyphens only', 'error');
                return;
            }

            // Check if ID already exists
            if (blogCategories.find(cat => cat.id === id)) {
                showMessage('Category ID already exists', 'error');
                return;
            }

            // Create translations object (using English label for all languages as placeholder)
            const translations = {
                en: label,
                de: label,  // Placeholder - can be translated later
                fr: label,
                es: label,
                pt: label,
                it: label,
                nl: label,
                sv: label,
                da: label,
                no: label,
                fi: label
            };

            try {
                const response = await authenticatedFetch('/api/admin/blog/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id, translations })
                });

                if (response.ok) {
                    await loadCategories();
                    displayCategoriesList();

                    document.getElementById('newCategoryId').value = '';
                    document.getElementById('newCategoryLabel').value = '';

                    showMessage('Category added successfully! You can edit translations later.', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add category');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showMessage(`Failed to add category: ${error.message}`, 'error');
            }
        }

        async function editCategory(id) {
            try {
                // Fetch category with all translations from API
                const response = await authenticatedFetch('/api/admin/blog/categories', {});

                if (!response.ok) {
                    throw new Error('Failed to fetch categories');
                }

                const data = await response.json();
                const category = data.categories.find(cat => cat.id === id);

                if (!category) {
                    showMessage('Category not found', 'error');
                    return;
                }

                // Populate edit form with current translations
                document.getElementById('editCategoryId').value = category.id;
                document.getElementById('editCategoryEn').value = category.translations.en || '';
                document.getElementById('editCategoryDe').value = category.translations.de || '';
                document.getElementById('editCategoryFr').value = category.translations.fr || '';
                document.getElementById('editCategoryEs').value = category.translations.es || '';
                document.getElementById('editCategoryPt').value = category.translations.pt || '';
                document.getElementById('editCategoryIt').value = category.translations.it || '';
                document.getElementById('editCategoryNl').value = category.translations.nl || '';
                document.getElementById('editCategorySv').value = category.translations.sv || '';
                document.getElementById('editCategoryDa').value = category.translations.da || '';
                document.getElementById('editCategoryNo').value = category.translations.no || '';
                document.getElementById('editCategoryFi').value = category.translations.fi || '';

                // Show modal
                document.getElementById('editCategoryModal').classList.add('active');
            } catch (error) {
                console.error('Error loading category for edit:', error);
                showMessage(`Failed to load category: ${error.message}`, 'error');
            }
        }

        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').classList.remove('active');
        }

        async function saveCategoryTranslations() {
            const id = document.getElementById('editCategoryId').value;
            const translations = {
                en: document.getElementById('editCategoryEn').value.trim(),
                de: document.getElementById('editCategoryDe').value.trim(),
                fr: document.getElementById('editCategoryFr').value.trim(),
                es: document.getElementById('editCategoryEs').value.trim(),
                pt: document.getElementById('editCategoryPt').value.trim(),
                it: document.getElementById('editCategoryIt').value.trim(),
                nl: document.getElementById('editCategoryNl').value.trim(),
                sv: document.getElementById('editCategorySv').value.trim(),
                da: document.getElementById('editCategoryDa').value.trim(),
                no: document.getElementById('editCategoryNo').value.trim(),
                fi: document.getElementById('editCategoryFi').value.trim()
            };

            // Validate that at least English translation is provided
            if (!translations.en) {
                showMessage('English translation is required', 'error');
                return;
            }

            try {
                const response = await authenticatedFetch('/api/admin/blog/categories', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id, translations })
                });

                if (response.ok) {
                    await loadCategories();
                    displayCategoriesList();
                    closeEditCategoryModal();
                    showMessage('Category translations updated successfully!', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update category');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                showMessage(`Failed to update category: ${error.message}`, 'error');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/blog/categories?id=${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadCategories();
                    displayCategoriesList();
                    showMessage('Category deleted', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete category');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                showMessage(`Failed to delete category: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Blog Manager Initializing...');

            // Check authentication state
            const token = getAuthToken();
            console.log('üîë Auth token present:', !!token);

            if (!token) {
                // Show login overlay immediately
                showLoginOverlay();
            } else {
                console.log('‚úÖ Auth token found - loading content');
                // Load content if already authenticated
                loadCategories();
                loadPosts();
            }

            // Always setup event listeners and initialize UI
            setupEventListeners();
            initFeaturedImageUpload();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Find and activate the clicked button
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.split('-')[0])) {
                    btn.classList.add('active');
                }
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            // Load tab-specific content
            if (tabName === 'posts') {
                loadPosts();
            } else if (tabName === 'editor') {
                populatePostSelect('editorPostSelect');
            } else if (tabName === 'pdfs') {
                loadPDFLibrary();
            } else if (tabName === 'translations') {
                populatePostSelect('translationPostSelect');
                // Reload translations if a post is already selected
                const selectedSlug = document.getElementById('translationPostSelect').value;
                if (selectedSlug) {
                    loadTranslations();
                }
            }
        }

        // Load blog posts
        async function loadPosts() {
            try {
                console.log('üì• Loading posts from admin API...');
                // üîß FIX: Use ADMIN API with authentication to load all posts (including drafts)
                // Pass high limit to ensure all posts are returned (API defaults to 50)
                const response = await authenticatedFetch('/api/admin/blog/posts?limit=1000', {});
                console.log('üì° API Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    posts = data.posts || [];
                    console.log('‚úÖ Loaded posts from admin API:', posts.length);
                    console.log('Posts data:', posts);
                    displayPosts();
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('‚ùå API returned error:', response.status, errorData);
                    throw new Error(`Failed to load posts: ${response.status} - ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading posts:', error);
                console.error('Error details:', error.message);
                posts = [];
                displayPosts();
                showMessage(`Failed to load blog posts: ${error.message}`, 'error');
            }
        }

        // Display posts with pagination
        function displayPosts() {
            const container = document.getElementById('postsList');
            const paginationControls = document.getElementById('paginationControls');

            if (posts.length === 0) {
                container.innerHTML = '<p>No blog posts found. Click "New Blog Post" to create one.</p>';
                paginationControls.style.display = 'none';
                return;
            }

            // Show pagination controls
            paginationControls.style.display = 'block';

            // Calculate pagination
            const totalPosts = posts.length;
            const totalPages = itemsPerPage === 'all' ? 1 : Math.ceil(totalPosts / itemsPerPage);

            // Ensure currentPage is within bounds
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            // Get posts for current page
            let postsToDisplay;
            if (itemsPerPage === 'all') {
                postsToDisplay = posts;
            } else {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                postsToDisplay = posts.slice(startIndex, endIndex);
            }

            // Display posts
            container.innerHTML = postsToDisplay.map(post => `
                <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                     onmouseout="this.style.boxShadow='none'"
                     onclick="editPost('${post.slug}')">
                    <div style="display: flex; gap: 20px; justify-content: space-between; align-items: start;">
                        ${post.featuredImage ? `
                            <div style="flex-shrink: 0;">
                                <img src="${post.featuredImage}" alt="${post.title}"
                                     style="width: 120px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid var(--gray-200);" />
                            </div>
                        ` : ''}
                        <div style="flex: 1;">
                            <h3 style="color: var(--gray-900); margin-bottom: 10px;">${post.title}</h3>
                            <p style="color: var(--gray-600); margin-bottom: 10px;">${post.excerpt || ''}</p>
                            <div style="display: flex; gap: 15px; font-size: 13px; color: var(--gray-500);">
                                <span>üìÖ ${post.date}</span>
                                <span>üë§ ${post.author}</span>
                                <span>üìÅ ${post.category}</span>
                                ${post.featuredImage ? '<span>üñºÔ∏è Has image</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editPost('${post.slug}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deletePost('${post.slug}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Update pagination info and controls
            updatePaginationControls(totalPosts, totalPages);
        }

        // Update pagination controls
        function updatePaginationControls(totalPosts, totalPages) {
            // Update info text
            const startItem = itemsPerPage === 'all' ? 1 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = itemsPerPage === 'all' ? totalPosts : Math.min(currentPage * itemsPerPage, totalPosts);
            document.getElementById('paginationInfo').textContent = `Showing ${startItem}-${endItem} of ${totalPosts} posts`;

            // Update prev/next button states
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            prevBtn.disabled = currentPage === 1 || itemsPerPage === 'all';
            nextBtn.disabled = currentPage === totalPages || itemsPerPage === 'all';

            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
            nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';

            // Generate page number buttons
            const pageNumbersContainer = document.getElementById('pageNumbers');
            if (itemsPerPage === 'all') {
                pageNumbersContainer.innerHTML = '';
                return;
            }

            let pageButtons = '';
            const maxVisiblePages = 7;

            if (totalPages <= maxVisiblePages) {
                // Show all pages
                for (let i = 1; i <= totalPages; i++) {
                    pageButtons += createPageButton(i, i === currentPage);
                }
            } else {
                // Show first, last, current and nearby pages
                pageButtons += createPageButton(1, currentPage === 1);

                if (currentPage > 3) {
                    pageButtons += '<span style="padding: 8px; color: var(--gray-500);">...</span>';
                }

                const start = Math.max(2, currentPage - 1);
                const end = Math.min(totalPages - 1, currentPage + 1);

                for (let i = start; i <= end; i++) {
                    pageButtons += createPageButton(i, i === currentPage);
                }

                if (currentPage < totalPages - 2) {
                    pageButtons += '<span style="padding: 8px; color: var(--gray-500);">...</span>';
                }

                pageButtons += createPageButton(totalPages, currentPage === totalPages);
            }

            pageNumbersContainer.innerHTML = pageButtons;
        }

        // Create page button HTML
        function createPageButton(pageNum, isActive) {
            return `
                <button onclick="goToPage(${pageNum})"
                        style="padding: 8px 12px; border: 1px solid ${isActive ? 'var(--primary)' : 'var(--gray-300)'};
                               border-radius: 6px; background: ${isActive ? 'var(--primary)' : 'white'};
                               color: ${isActive ? 'white' : 'var(--gray-700)'}; cursor: pointer;
                               font-weight: ${isActive ? '600' : '500'}; transition: all 0.2s;"
                        onmouseover="if(!${isActive}) { this.style.background='var(--gray-100)'; }"
                        onmouseout="if(!${isActive}) { this.style.background='white'; }">
                    ${pageNum}
                </button>
            `;
        }

        // Pagination functions
        function goToPage(page) {
            currentPage = page;
            displayPosts();
            // Scroll to top of posts list
            document.getElementById('postsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function nextPage() {
            const totalPages = Math.ceil(posts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayPosts();
                document.getElementById('postsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPosts();
                document.getElementById('postsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function changeItemsPerPage(value) {
            itemsPerPage = value === 'all' ? 'all' : parseInt(value);
            currentPage = 1; // Reset to first page when changing items per page
            displayPosts();
        }

        // Create new post
        function createNewPost() {
            currentPost = null;
            switchTab('editor');
            clearEditorForm();
        }

        // Edit post
        function editPost(slug) {
            currentPost = posts.find(p => p.slug === slug);
            if (!currentPost) return;

            switchTab('editor');
            document.getElementById('editorPostSelect').value = slug;
            loadPostForEditing();
        }

        // üîÑ SYNC FIX: Reload current post from database (used after saving)
        async function reloadCurrentPost() {
            if (!currentPost || !currentPost.slug) {
                console.warn('‚ö†Ô∏è Cannot reload: no currentPost');
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${currentPost.slug}`, {});
                if (response.ok) {
                    const data = await response.json();
                    const post = data.post;
                    const oldSlug = currentPost.slug;
                    currentPost = post; // Update currentPost with fresh data from database
                    console.log('‚úÖ Current post reloaded from database:', currentPost.slug);

                    // Update form fields with fresh database values for current language
                    const translation = post.translations[currentLanguage] || post.translations['en'] || {};

                    document.getElementById('postTitle').value = translation.title || '';
                    document.getElementById('postSlug').value = post.slug || '';
                    document.getElementById('postMetaTitle').value = translation.metaTitle || translation.title || '';
                    document.getElementById('postMetaDescription').value = translation.metaDescription || translation.excerpt || '';
                    document.getElementById('postFocusKeyword').value = translation.focusKeyword || '';
                    document.getElementById('postKeywords').value = (post.keywords || []).join(', ');
                    document.getElementById('postFeaturedImage').value = post.featuredImage || '';
                    document.getElementById('postCategory').value = post.category || 'teaching-resources';
                    document.getElementById('postPdfSectionTitle').value = translation.pdfSectionTitle || 'Free Sample Worksheets';
                    document.getElementById('postPdfSectionDescription').value = translation.pdfSectionDescription || 'Premium educational resources designed by experts to accelerate learning and inspire students';
                    document.getElementById('postPdfFreeLabel').value = translation.pdfFreeLabel || 'Free';
                    document.getElementById('postPdfPremiumLabel').value = translation.pdfPremiumLabel || 'Premium';
                    document.getElementById('postPdfDownloadButton').value = translation.pdfDownloadButton || 'Download Now';

                    // Update featured image preview
                    if (post.featuredImage) {
                        document.getElementById('featuredImagePlaceholder').style.display = 'none';
                        document.getElementById('featuredImagePreview').style.display = 'block';
                        document.getElementById('featuredImagePreviewImg').src = post.featuredImage;
                        document.getElementById('featuredImageName').textContent = post.featuredImage.split('/').pop();
                    } else {
                        document.getElementById('featuredImagePlaceholder').style.display = 'block';
                        document.getElementById('featuredImagePreview').style.display = 'none';
                    }

                    updateCurrentPostIndicator();
                } else {
                    console.error('‚ùå Failed to reload post from database');
                }
            } catch (error) {
                console.error('‚ùå Error reloading current post:', error);
            }
        }

        // Load post for editing
        async function loadPostForEditing() {
            const slug = document.getElementById('editorPostSelect').value;
            const language = document.getElementById('editorLanguage').value;

            console.log('üîç [DIAGNOSTIC] loadPostForEditing() called');
            console.log('   üìç Language from dropdown:', language);
            console.log('   üìç Timestamp:', new Date().toISOString());

            if (!slug) {
                clearEditorForm();
                return;
            }

            currentPost = posts.find(p => p.slug === slug);
            currentLanguage = language;

            console.log('   ‚úÖ currentLanguage set to:', currentLanguage);

            // Load post from admin API
            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {});
                if (response.ok) {
                    const data = await response.json();
                    const post = data.post;
                    currentPost = post; // Set currentPost when loading for editing
                    updateCurrentPostIndicator();

                    const translation = post.translations[language] || post.translations['en'] || {};

                    // Populate metadata
                    document.getElementById('postTitle').value = translation.title || '';
                    document.getElementById('postSlug').value = post.slug || '';
                    document.getElementById('postMetaTitle').value = translation.metaTitle || translation.title || '';
                    document.getElementById('postMetaDescription').value = translation.metaDescription || translation.excerpt || '';
                    document.getElementById('postFocusKeyword').value = translation.focusKeyword || '';
                    document.getElementById('postKeywords').value = (post.keywords || []).join(', ');
                    document.getElementById('postFeaturedImage').value = post.featuredImage || '';
                    document.getElementById('postCategory').value = post.category || 'teaching-resources';
                    document.getElementById('postPdfSectionTitle').value = translation.pdfSectionTitle || 'Free Sample Worksheets';
                    document.getElementById('postPdfSectionDescription').value = translation.pdfSectionDescription || 'Premium educational resources designed by experts to accelerate learning and inspire students';
                    document.getElementById('postPdfFreeLabel').value = translation.pdfFreeLabel || 'Free';
                    document.getElementById('postPdfPremiumLabel').value = translation.pdfPremiumLabel || 'Premium';
                    document.getElementById('postPdfDownloadButton').value = translation.pdfDownloadButton || 'Download Now';

                    // Show featured image preview if exists
                    if (post.featuredImage) {
                        document.getElementById('featuredImagePlaceholder').style.display = 'none';
                        document.getElementById('featuredImagePreview').style.display = 'block';
                        document.getElementById('featuredImagePreviewImg').src = post.featuredImage;
                        document.getElementById('featuredImageName').textContent = post.featuredImage.split('/').pop();
                    } else {
                        document.getElementById('featuredImagePlaceholder').style.display = 'block';
                        document.getElementById('featuredImagePreview').style.display = 'none';
                    }

                    // Load HTML content
                    document.getElementById('htmlEditor').value = translation.content || '';
                    refreshPreview();

                    // Trigger SEO analysis after loading
                    updateSEOAnalysis();
                } else {
                    // Clear form for new translation
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postMetaTitle').value = '';
                    document.getElementById('postMetaDescription').value = '';
                    document.getElementById('postFocusKeyword').value = '';
                    document.getElementById('postKeywords').value = '';
                    document.getElementById('postFeaturedImage').value = '';
                    document.getElementById('postCategory').value = 'teaching-resources';
                    document.getElementById('postPdfSectionTitle').value = 'Free Sample Worksheets';
                    document.getElementById('postPdfSectionDescription').value = 'Premium educational resources designed by experts to accelerate learning and inspire students';
                    document.getElementById('postPdfFreeLabel').value = 'Free';
                    document.getElementById('postPdfPremiumLabel').value = 'Premium';
                    document.getElementById('postPdfDownloadButton').value = 'üì• Download Now ‚Üí';
                    document.getElementById('htmlEditor').value = '';
                    if (language !== 'en') {
                        showMessage('No translation found for this language. Add content to create it.', 'info');
                    }
                }
            } catch (error) {
                console.error('Error loading content:', error);
                showMessage('Error loading post content', 'error');
            }

            // Load PDFs for this post
            loadPostPDFs(slug);
        }

        // Load PDFs for current post with language-specific translations
        async function loadPostPDFs(slug) {
            console.log('üîç [DIAGNOSTIC] loadPostPDFs() called');
            console.log('   üìç currentLanguage:', currentLanguage);
            console.log('   üìç slug:', slug);
            console.log('   üìç Timestamp:', new Date().toISOString());

            try {
                // Fetch PDFs from BlogPDF table
                const pdfResponse = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs`, {});

                if (pdfResponse.ok) {
                    const pdfData = await pdfResponse.json();
                    console.log('   üì¶ BlogPDF table data:', JSON.parse(JSON.stringify(pdfData.pdfs)));

                    // Fetch BlogPost data to get language-specific translations
                    const postResponse = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {});
                    let languageSpecificPDFs = {};

                    if (postResponse.ok) {
                        const postData = await postResponse.json();
                        const post = postData.post;

                        // Get language-specific PDF translations for current language
                        languageSpecificPDFs = post.translations[currentLanguage]?.pdfs || {};
                        console.log(`   üìö translations[${currentLanguage}].pdfs from database:`, JSON.parse(JSON.stringify(languageSpecificPDFs)));
                    }

                    // Merge BlogPDF values with language-specific translations (like frontend does)
                    currentPDFs = pdfData.pdfs.map(pdf => {
                        const pdfTranslations = languageSpecificPDFs[pdf.id];
                        const merged = {
                            id: pdf.id,
                            // Use language-specific title/description if available, otherwise use BlogPDF values
                            title: pdfTranslations?.title || pdf.title,
                            description: pdfTranslations?.description || pdf.description,
                            filename: pdf.filename,
                            size: formatFileSize(pdf.fileSize),
                            price: pdf.price || 'Free',
                            thumbnail: pdf.thumbnail
                        };
                        console.log(`   üîó Merged PDF ${pdf.id}:`, {
                            blogPdfTitle: pdf.title,
                            translationTitle: pdfTranslations?.title,
                            finalTitle: merged.title
                        });
                        return merged;
                    });

                    console.log(`   ‚úÖ Final currentPDFs array (${currentPDFs.length} items):`, JSON.parse(JSON.stringify(currentPDFs)));
                } else {
                    currentPDFs = [];
                }
            } catch (error) {
                console.error('Error loading PDFs:', error);
                currentPDFs = [];
            }

            displayPostPDFs();
        }

        // Display PDFs for current post
        function displayPostPDFs() {
            const container = document.getElementById('pdfGrid');

            if (currentPDFs.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-500);">No PDFs added yet. Click "Add PDF" to add worksheets.</p>';
                return;
            }

            container.innerHTML = currentPDFs.map(pdf => `
                <div class="pdf-card">
                    <div class="pdf-thumbnail">
                        ${pdf.thumbnail ?
                            `<img src="${pdf.thumbnail}" alt="${pdf.title}">` :
                            `<div style="color: white; font-size: 48px;">üìÑ</div>`
                        }
                        <span class="pdf-badge">PDF</span>
                    </div>
                    <div class="pdf-info">
                        <div class="pdf-name">${pdf.title}</div>
                        <div class="pdf-description">${pdf.description}</div>
                        <div class="pdf-meta">
                            <span class="pdf-size">üìÅ ${pdf.size}</span>
                            <div class="pdf-actions">
                                <button class="btn btn-icon btn-sm btn-secondary" onclick="editPDF('${pdf.id}')" title="Edit">‚úèÔ∏è</button>
                                <button class="btn btn-icon btn-sm btn-danger" onclick="removePDF('${pdf.id}')" title="Delete">üóë</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Clear editor form
        function clearEditorForm() {
            document.getElementById('postTitle').value = '';
            document.getElementById('postSlug').value = '';
            document.getElementById('postMetaTitle').value = '';
            document.getElementById('postMetaDescription').value = '';
            document.getElementById('postFocusKeyword').value = '';
            document.getElementById('postKeywords').value = '';
            document.getElementById('postFeaturedImage').value = '';
            document.getElementById('postFeaturedImageFile').value = '';
            document.getElementById('postCategory').value = 'teaching-resources';
            document.getElementById('postPdfSectionTitle').value = 'Free Sample Worksheets';
            document.getElementById('postPdfSectionDescription').value = 'Premium educational resources designed by experts to accelerate learning and inspire students';
            document.getElementById('postPdfFreeLabel').value = 'Free';
            document.getElementById('postPdfPremiumLabel').value = 'Premium';
            document.getElementById('postPdfDownloadButton').value = 'Download Now';
            document.getElementById('htmlEditor').value = '';
            document.getElementById('previewFrame').srcdoc = '';

            // Reset featured image preview
            document.getElementById('featuredImagePlaceholder').style.display = 'block';
            document.getElementById('featuredImagePreview').style.display = 'none';
            document.getElementById('featuredImagePreviewImg').src = '';
            document.getElementById('featuredImageName').textContent = '';

            currentPDFs = [];
            displayPostPDFs();
            currentPost = null;

            // Reset SEO analysis
            updateSEOAnalysis();
            updateCurrentPostIndicator();
        }

        // Update current post indicator
        function updateCurrentPostIndicator() {
            const indicator = document.getElementById('currentPostIndicator');
            const slugDisplay = document.getElementById('currentPostSlug');

            if (currentPost) {
                indicator.style.display = 'block';
                slugDisplay.textContent = currentPost.slug;
                console.log('üìä Indicator updated. Current post:', currentPost.slug);
            } else {
                indicator.style.display = 'none';
                slugDisplay.textContent = '';
                console.log('üìä Indicator hidden. No current post.');
            }
        }

        // Refresh preview
        function refreshPreview() {
            const html = document.getElementById('htmlEditor').value;
            const fullHTML = `
                <!DOCTYPE html>
                <html lang="${currentLanguage}">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${document.getElementById('postTitle').value || 'Preview'}</title>
                    <style>
                        body { font-family: -apple-system, sans-serif; padding: 20px; }
                    </style>
                </head>
                <body>
                    ${html}
                    ${generatePDFSectionHTML()}
                </body>
                </html>
            `;
            document.getElementById('previewFrame').srcdoc = fullHTML;
        }

        // Generate PDF section HTML
        function generatePDFSectionHTML() {
            if (currentPDFs.length === 0) return '';

            // Get translated title and description from form, or use defaults
            const pdfTitle = document.getElementById('postPdfSectionTitle').value || 'Free Sample Worksheets';
            const pdfDescription = document.getElementById('postPdfSectionDescription').value || 'Premium educational resources designed by experts to accelerate learning and inspire students';
            const pdfFreeLabel = document.getElementById('postPdfFreeLabel').value || 'Free';
            const pdfPremiumLabel = document.getElementById('postPdfPremiumLabel').value || 'Premium';
            const pdfDownloadButton = document.getElementById('postPdfDownloadButton').value || 'Download Now';

            return `
                <style>
                    .pdf-download-btn {
                        width: 100%;
                        background: linear-gradient(135deg, #3B82F6 0%, #7C3AED 100%);
                        color: white;
                        padding: 14px 24px;
                        border: none;
                        border-radius: 10px;
                        font-weight: 600;
                        font-size: 15px;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        letter-spacing: 0.3px;
                        position: relative;
                        overflow: hidden;
                    }
                    .pdf-download-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
                        background: linear-gradient(135deg, #2563EB 0%, #6D28D9 100%);
                    }
                    .pdf-download-btn:active {
                        transform: translateY(0);
                        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                    }
                </style>
                <section style="background: #F3F4F6; padding: 60px 20px; margin-top: 60px; text-align: center;">
                    <h2 style="color: #7C3AED; font-size: 36px; margin-bottom: 20px;">${pdfTitle}</h2>
                    <p style="color: #6B7280; font-size: 18px; margin-bottom: 40px;">
                        ${pdfDescription}
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
                        ${currentPDFs.map(pdf => `
                            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <div style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                                    ${pdf.thumbnail ?
                                        `<img src="${pdf.thumbnail}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                        `<div style="color: white; font-size: 48px;">‚≠ê</div>`
                                    }
                                </div>
                                <div style="padding: 20px;">
                                    <h3 style="margin-bottom: 10px;">${pdf.title}</h3>
                                    <p style="color: #6B7280; font-size: 14px; margin-bottom: 15px;">${pdf.description}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <span style="color: #6B7280; font-size: 13px;">üìÅ ${pdf.size}</span>
                                        <span style="color: #10B981; font-weight: 600;">üí≤ ${pdf.price === 'Free' ? pdfFreeLabel : pdfPremiumLabel}</span>
                                    </div>
                                    <button class="pdf-download-btn">
                                        ${pdfDownloadButton}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        // Auto-update preview on typing
        let previewTimeout;
        document.getElementById('htmlEditor')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });

        // Auto-update preview when PDF translation fields change
        document.getElementById('postPdfSectionTitle')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });
        document.getElementById('postPdfSectionDescription')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });
        document.getElementById('postPdfFreeLabel')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });
        document.getElementById('postPdfPremiumLabel')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });
        document.getElementById('postPdfDownloadButton')?.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(refreshPreview, 500);
        });

        // Save post
        async function savePost() {
            const title = document.getElementById('postTitle').value;
            const slug = document.getElementById('postSlug').value || generateSlug(title);
            const metaDescription = document.getElementById('postMetaDescription').value;
            const keywords = document.getElementById('postKeywords').value;
            const htmlContent = document.getElementById('htmlEditor').value;
            const featuredImage = document.getElementById('postFeaturedImage').value || null;
            const category = document.getElementById('postCategory').value;

            console.log('üìù Saving blog post with featuredImage:', featuredImage);

            if (!title || !htmlContent) {
                showMessage('Please provide a title and HTML content', 'error');
                return;
            }

            // Build translations object
            const translationData = {
                title,
                excerpt: metaDescription || title,
                content: htmlContent,
                author: 'LessonCraftStudio Team',
                metaTitle: document.getElementById('postMetaTitle').value || title,
                metaDescription,
                focusKeyword: document.getElementById('postFocusKeyword').value || '',
                pdfSectionTitle: document.getElementById('postPdfSectionTitle').value || 'Free Sample Worksheets',
                pdfSectionDescription: document.getElementById('postPdfSectionDescription').value || 'Premium educational resources designed by experts to accelerate learning and inspire students',
                pdfFreeLabel: document.getElementById('postPdfFreeLabel').value || 'Free',
                pdfPremiumLabel: document.getElementById('postPdfPremiumLabel').value || 'Premium',
                pdfDownloadButton: document.getElementById('postPdfDownloadButton').value || 'Download Now'
            };

            const translations = {
                [currentLanguage]: translationData
            };

            // Always ensure English translation exists (required by API)
            if (currentLanguage !== 'en') {
                translations.en = translationData; // Use same content as placeholder for English
            }

            // If editing existing post, load other language translations AND preserve PDF translations for current language
            if (currentPost) {
                try {
                    const response = await authenticatedFetch(`/api/admin/blog/posts/${currentPost.slug}`, {});
                    if (response.ok) {
                        const data = await response.json();
                        const existingTranslations = data.post.translations;

                        // üîß FIX: Preserve PDF translations for current language!
                        if (existingTranslations[currentLanguage]?.pdfs) {
                            translations[currentLanguage].pdfs = existingTranslations[currentLanguage].pdfs;
                            console.log('‚úÖ Preserved PDF translations for', currentLanguage, ':', translations[currentLanguage].pdfs);
                        }

                        // Merge existing translations with current language update
                        Object.keys(existingTranslations).forEach(lang => {
                            if (lang !== currentLanguage && lang !== 'en') {
                                translations[lang] = existingTranslations[lang];
                            }
                            // Preserve existing English if we're editing in another language
                            if (lang === 'en' && currentLanguage !== 'en') {
                                translations.en = existingTranslations.en;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading existing translations:', error);
                }
            }

            const formData = {
                slug,
                translations,
                category,
                keywords: keywords ? keywords.split(',').map(k => k.trim()).filter(k => k) : [],
                featuredImage,
                status: 'published'
            };

            try {
                const url = currentPost
                    ? `/api/admin/blog/posts/${currentPost.slug}`
                    : '/api/admin/blog/posts';

                const method = currentPost ? 'PUT' : 'POST';

                const response = await authenticatedFetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentPost = result.post; // Update currentPost with saved post
                    console.log('‚úÖ Blog post saved! currentPost:', currentPost);
                    console.log('‚úÖ Post ID:', currentPost.id, 'Slug:', currentPost.slug);
                    console.log('‚úÖ Featured Image saved:', currentPost.featuredImage);
                    updateCurrentPostIndicator();
                    showMessage(`Blog post saved successfully for language: ${currentLanguage.toUpperCase()}!`, 'success');

                    // üîÑ SYNC FIX: Reload both list AND current post to ensure UI matches database
                    await loadPosts();
                    await reloadCurrentPost();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save post');
                }
            } catch (error) {
                console.error('Error saving post:', error);
                showMessage(`Failed to save blog post: ${error.message}`, 'error');
            }
        }

        // Publish post to static HTML files
        async function publishPost() {
            if (!currentPost || !currentPost.slug) {
                showMessage('Please select and save a blog post first before publishing!', 'error');
                return;
            }

            const slug = currentPost.slug;

            // Confirm before publishing
            if (!confirm(`This will generate static HTML files for all languages of the blog post "${slug}".\n\nMake sure you've saved all your changes first!\n\nContinue with publishing?`)) {
                return;
            }

            try {
                showMessage('üì° Fetching blog post data from database...', 'info');

                // Fetch the complete post with all translations from the database
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {});

                if (!response.ok) {
                    throw new Error('Failed to fetch blog post data');
                }

                const data = await response.json();
                const post = data.post;

                console.log('üìÑ Publishing post:', post);

                // Prepare the languages data for the publish API
                const languages = {};
                for (const [locale, translation] of Object.entries(post.translations)) {
                    languages[locale] = {
                        title: translation.title,
                        content: translation.content,
                        metaTitle: translation.metaTitle || translation.title,
                        metaDescription: translation.metaDescription || translation.excerpt || '',
                        keywords: post.keywords ? post.keywords.join(', ') : '',
                        category: post.category || 'teaching-resources',
                        author: translation.author || 'LessonCraftStudio Team',
                        date: new Date(post.createdAt).toLocaleDateString(),
                        readTime: '5 min read',
                        pdfSectionTitle: translation.pdfSectionTitle || '',
                        pdfSectionDescription: translation.pdfSectionDescription || '',
                        pdfFreeLabel: translation.pdfFreeLabel || 'Free',
                        pdfPremiumLabel: translation.pdfPremiumLabel || 'Premium',
                        pdfDownloadButton: translation.pdfDownloadButton || 'Download Now'
                    };
                }

                showMessage('üöÄ Publishing to static HTML files...', 'info');

                // Call the publish API
                const publishResponse = await authenticatedFetch('/api/blog/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        slug: slug,
                        languages: languages
                    })
                });

                if (publishResponse.ok) {
                    const result = await publishResponse.json();
                    console.log('‚úÖ Publish result:', result);

                    const urls = result.publishedUrls || result.urls || [];
                    const count = urls.length || 0;

                    showMessage(`‚úÖ Successfully published to ${count} language(s)! Static HTML files generated.`, 'success');

                    // Show the URLs
                    if (urls.length > 0) {
                        setTimeout(() => {
                            showMessage(`üìÅ Published URLs: ${urls.join(', ')}`, 'info');
                        }, 2000);
                    }
                } else {
                    const error = await publishResponse.json();
                    console.error('Publish error:', error);
                    throw new Error(error.error || 'Failed to publish');
                }
            } catch (error) {
                console.error('Error publishing post:', error);
                showMessage(`‚ùå Failed to publish: ${error.message}`, 'error');
            }
        }

        // Generate full HTML document
        function generateFullHTML(data) {
            return `<!DOCTYPE html>
<html lang="${currentLanguage}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.title}</title>
    <meta name="description" content="${data.metaDescription}">
    <meta name="keywords" content="${data.keywords}">
    <meta name="author" content="LessonCraftStudio Team">
    <meta name="date" content="${new Date().toISOString().split('T')[0]}">
    ${generateHreflangTags(data.slug)}
    ${generateOpenGraphTags(data)}
</head>
<body>
    <h1>${data.title}</h1>
${data.content}
${generatePDFSectionHTML()}
</body>
</html>`;
        }

        // Generate hreflang tags
        function generateHreflangTags(slug) {
            const languages = ['en', 'de', 'fr', 'es', 'pt', 'it', 'nl', 'sv', 'da', 'no', 'fi'];
            return languages.map(lang =>
                `    <link rel="alternate" hreflang="${lang}" href="https://lessoncraftstudio.com/${lang}/blog/${slug}" />`
            ).join('\n');
        }

        // Generate Open Graph tags
        function generateOpenGraphTags(data) {
            return `
    <meta property="og:title" content="${data.title}">
    <meta property="og:description" content="${data.metaDescription}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://lessoncraftstudio.com/${currentLanguage}/blog/${data.slug}">
    <meta property="og:site_name" content="LessonCraftStudio">
    <meta property="og:locale" content="${currentLanguage}">`;
        }

        // Download HTML
        function downloadHTML(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate slug
        function generateSlug(text) {
            return text.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        // Populate post select dropdowns
        function populatePostSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Select a post --</option>' +
                posts.map(post =>
                    `<option value="${post.slug}">${post.title}</option>`
                ).join('');
        }

        // Load translations
        async function loadTranslations() {
            const slug = document.getElementById('translationPostSelect').value;
            if (!slug) {
                document.getElementById('languageGrid').innerHTML = '';
                return;
            }

            const languages = [
                { code: 'en', name: 'English', flag: 'üá¨üáß' },
                { code: 'de', name: 'Deutsch', flag: 'üá©üá™' },
                { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
                { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏' },
                { code: 'pt', name: 'Portugu√™s', flag: 'üáµüáπ' },
                { code: 'it', name: 'Italiano', flag: 'üáÆüáπ' },
                { code: 'nl', name: 'Nederlands', flag: 'üá≥üá±' },
                { code: 'sv', name: 'Svenska', flag: 'üá∏üá™' },
                { code: 'da', name: 'Dansk', flag: 'üá©üá∞' },
                { code: 'no', name: 'Norsk', flag: 'üá≥üá¥' },
                { code: 'fi', name: 'Suomi', flag: 'üá´üáÆ' }
            ];

            // Fetch post data to check which translations exist
            let existingTranslations = {};
            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {});
                if (response.ok) {
                    const data = await response.json();
                    existingTranslations = data.post.translations || {};
                }
            } catch (error) {
                console.error('Error loading post translations:', error);
            }

            document.getElementById('languageGrid').innerHTML = languages.map(lang => {
                const hasTranslation = existingTranslations[lang.code] &&
                                     existingTranslations[lang.code].title &&
                                     existingTranslations[lang.code].content;

                return `
                    <div class="language-card ${hasTranslation ? 'complete' : ''}"
                         onclick="editTranslation('${slug}', '${lang.code}')"
                         style="cursor: pointer;">
                        <div class="language-flag">${lang.flag}</div>
                        <div class="language-name">${lang.name}</div>
                        <div class="language-status">${hasTranslation ? '‚úÖ Complete' : '‚ö†Ô∏è Missing'}</div>
                        <button class="btn btn-sm btn-primary" style="width: 100%;">
                            ${hasTranslation ? 'Edit' : 'Add Translation'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Edit translation
        function editTranslation(slug, language) {
            document.getElementById('editorPostSelect').value = slug;
            document.getElementById('editorLanguage').value = language;
            switchTab('editor');
            loadPostForEditing();
        }

        // PDF Modal functions
        function openPDFModal() {
            document.getElementById('pdfModal').classList.add('active');
        }

        function closePDFModal() {
            document.getElementById('pdfModal').classList.remove('active');
            // Clear form
            document.getElementById('modalPDFFile').value = '';
            document.getElementById('modalPDFTitle').value = '';
            document.getElementById('modalPDFDescription').value = '';
            document.getElementById('modalPDFThumbnail').value = '';
            document.getElementById('modalPDFSize').value = '';
            document.getElementById('modalPDFPrice').value = 'free';
        }

        async function savePDF() {
            const title = document.getElementById('modalPDFTitle').value;
            const description = document.getElementById('modalPDFDescription').value;
            const fileInput = document.getElementById('modalPDFFile');
            const thumbnailInput = document.getElementById('modalPDFThumbnail');
            const price = document.getElementById('modalPDFPrice').value === 'free' ? 'Free' : 'Premium';

            if (!title || !fileInput.files[0]) {
                showMessage('Please provide a title and select a PDF file', 'error');
                return;
            }

            // Get slug from current context (editor or PDF manager)
            let slug = currentPost ? currentPost.slug : null;
            if (!slug) {
                slug = document.getElementById('editorPostSelect').value || document.getElementById('pdfManagerPostSelect').value;
            }

            if (!slug) {
                showMessage('Please select a blog post first', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('pdf', fileInput.files[0]);

                // üîß CRITICAL FIX: For non-English languages, upload with filename-based placeholders
                // Then save actual values to translations only
                const filename = fileInput.files[0].name;
                const placeholderTitle = filename.replace('.pdf', '').replace(/-/g, ' ').replace(/_/g, ' ')
                    .split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                if (currentLanguage === 'en') {
                    // English: Upload with actual title/description to BlogPDF
                    formData.append('title', title);
                    formData.append('description', description);
                    console.log('üìÑ Uploading PDF with English title/description to BlogPDF table');
                } else {
                    // Non-English: Upload with filename-based placeholder to BlogPDF
                    formData.append('title', placeholderTitle);
                    formData.append('description', `Worksheet: ${placeholderTitle}`);
                    console.log(`üåç Uploading PDF with placeholder to BlogPDF (language: ${currentLanguage})`);
                }

                formData.append('price', price);

                if (thumbnailInput && thumbnailInput.files[0]) {
                    formData.append('thumbnail', thumbnailInput.files[0]);
                }

                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    const pdfId = result.pdf.id;

                    // For ALL languages: Save PDF title/description to BlogPost translations
                    try {
                        const postResponse = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {});
                        if (postResponse.ok) {
                            const postData = await postResponse.json();
                            const post = postData.post;

                            // Initialize pdfs object for current language if it doesn't exist
                            if (!post.translations[currentLanguage]) {
                                post.translations[currentLanguage] = {};
                            }
                            if (!post.translations[currentLanguage].pdfs) {
                                post.translations[currentLanguage].pdfs = {};
                            }

                            // Save actual user-provided title/description for current language
                            post.translations[currentLanguage].pdfs[pdfId] = {
                                title: title,
                                description: description
                            };

                            // Update the blog post with new translations
                            await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    translations: post.translations,
                                    slug: post.slug,
                                    category: post.category,
                                    keywords: post.keywords,
                                    featuredImage: post.featuredImage,
                                    status: post.status
                                })
                            });
                        }
                    } catch (translationError) {
                        console.error('Error saving PDF translation:', translationError);
                        // Don't fail the whole operation if translation save fails
                    }

                    showMessage('PDF uploaded successfully with language-specific text!', 'success');
                    closePDFModal();
                    // Reload PDFs for both editor and PDF manager
                    await loadPostPDFs(slug);
                    // If on PDF Manager tab, refresh the list
                    const pdfManagerSlug = document.getElementById('pdfManagerPostSelect').value;
                    if (pdfManagerSlug === slug) {
                        await loadPDFsForPost();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to upload PDF');
                }
            } catch (error) {
                console.error('Error uploading PDF:', error);
                showMessage(`Failed to upload PDF: ${error.message}`, 'error');
            }
        }

        async function removePDF(id) {
            if (!confirm('Are you sure you want to remove this PDF? This will permanently delete the file.')) {
                return;
            }

            // Get slug from current context (editor or PDF manager)
            const slug = document.getElementById('editorPostSelect').value || document.getElementById('pdfManagerPostSelect').value;
            if (!slug) {
                showMessage('Error: No post selected', 'error');
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('PDF deleted successfully', 'success');
                    // Reload PDFs for both editor and PDF manager
                    await loadPostPDFs(slug);
                    // If on PDF Manager tab, refresh the list
                    const pdfManagerSlug = document.getElementById('pdfManagerPostSelect').value;
                    if (pdfManagerSlug === slug) {
                        await loadPDFsForPost();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete PDF');
                }
            } catch (error) {
                console.error('Error deleting PDF:', error);
                showMessage(`Failed to delete PDF: ${error.message}`, 'error');
            }
        }

        async function editPDF(id) {
            console.log('üîç [DIAGNOSTIC] editPDF() called');
            console.log('   üìç PDF id:', id);
            console.log('   üìç currentLanguage:', currentLanguage);
            console.log('   üìç Timestamp:', new Date().toISOString());

            // Get slug from current context (editor or PDF manager)
            const slug = document.getElementById('editorPostSelect').value || document.getElementById('pdfManagerPostSelect').value;
            if (!slug) {
                showMessage('Error: No post selected', 'error');
                return;
            }

            // Fetch PDF details from API
            let pdf = currentPDFs.find(p => p.id === id);
            console.log('   üì¶ PDF found in currentPDFs:', pdf ? JSON.parse(JSON.stringify(pdf)) : 'NOT FOUND');

            if (!pdf) {
                // Try fetching from API if not in currentPDFs
                try {
                    const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs`, {});
                    if (response.ok) {
                        const data = await response.json();
                        pdf = data.pdfs.find(p => p.id === id);
                        console.log('   üì¶ PDF fetched from API:', pdf ? JSON.parse(JSON.stringify(pdf)) : 'NOT FOUND');
                    }
                } catch (error) {
                    console.error('Error fetching PDF:', error);
                }
            }

            if (!pdf) {
                showMessage('PDF not found', 'error');
                return;
            }

            // Populate edit modal with PDF data
            document.getElementById('editPDFId').value = pdf.id;
            document.getElementById('editPDFTitle').value = pdf.title || '';
            document.getElementById('editPDFDescription').value = pdf.description || '';

            console.log('   ‚úÖ Form populated with:', {
                title: pdf.title || '',
                description: pdf.description || ''
            });
            document.getElementById('editPDFPrice').value = pdf.price || 'Free';
            document.getElementById('editPDFFileName').textContent = pdf.filename || 'N/A';

            // Show current thumbnail if exists
            if (pdf.thumbnail) {
                document.getElementById('currentThumbnailPreview').style.display = 'block';
                document.getElementById('currentThumbnailImg').src = pdf.thumbnail;
            } else {
                document.getElementById('currentThumbnailPreview').style.display = 'none';
            }

            // Clear thumbnail file input
            document.getElementById('editPDFThumbnail').value = '';

            // Show modal
            document.getElementById('editPDFModal').classList.add('active');
        }

        function closeEditPDFModal() {
            document.getElementById('editPDFModal').classList.remove('active');
        }

        async function saveEditedPDF() {
            const id = document.getElementById('editPDFId').value;
            const title = document.getElementById('editPDFTitle').value.trim();
            const description = document.getElementById('editPDFDescription').value.trim();
            const price = document.getElementById('editPDFPrice').value;
            const thumbnailInput = document.getElementById('editPDFThumbnail');

            console.log('üîç [DIAGNOSTIC] saveEditedPDF() called');
            console.log('   üìç PDF id:', id);
            console.log('   üìç currentLanguage:', currentLanguage);
            console.log('   üìç Title from form:', title);
            console.log('   üìç Description from form:', description);
            console.log('   üìç Timestamp:', new Date().toISOString());

            if (!title) {
                showMessage('Title is required', 'error');
                return;
            }

            // Get slug from current context
            const slug = document.getElementById('editorPostSelect').value || document.getElementById('pdfManagerPostSelect').value;
            if (!slug) {
                showMessage('Error: No post selected', 'error');
                return;
            }

            try {
                // üîß SIMPLIFIED FIX: Send language parameter to backend and let it handle branching
                console.log(`   üì§ Sending to API with currentLanguage: ${currentLanguage}`);

                const formData = new FormData();
                formData.append('title', title);
                formData.append('description', description);
                formData.append('price', price);
                formData.append('language', currentLanguage); // ‚ú® KEY FIX: Send language parameter!

                // Add thumbnail if a new one was selected
                if (thumbnailInput.files && thumbnailInput.files[0]) {
                    formData.append('thumbnail', thumbnailInput.files[0]);
                }

                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs/${id}`, {
                    method: 'PUT',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update PDF');
                }

                console.log(`   ‚úÖ PDF updated successfully for language: ${currentLanguage}`);

                showMessage('PDF updated successfully with language-specific text!', 'success');
                closeEditPDFModal();

                // Reload PDFs to show updated data
                console.log('   üîÑ Reloading PDFs after save...');
                console.log('   üîÑ currentLanguage at reload time:', currentLanguage);
                await loadPostPDFs(slug);

                // If on PDF Manager tab, refresh the list
                const pdfManagerSlug = document.getElementById('pdfManagerPostSelect').value;
                if (pdfManagerSlug === slug) {
                    await loadPDFsForPost();
                }
            } catch (error) {
                console.error('Error updating PDF:', error);
                showMessage(`Failed to update PDF: ${error.message}`, 'error');
            }
        }

        // File handling
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            files.forEach(file => {
                console.log('Processing file:', file.name);
            });
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showMessage(message, type) {
            const colors = {
                success: '#10B981',
                error: '#EF4444',
                info: '#3B82F6'
            };

            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                color: ${colors[type] || '#333'};
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid ${colors[type] || '#333'};
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function pasteHTML() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('htmlEditor').value = text;
                refreshPreview();
            });
        }

        function copyHTML() {
            const editor = document.getElementById('htmlEditor');
            editor.select();
            document.execCommand('copy');
            showMessage('HTML copied to clipboard!', 'success');
        }

        function clearHTML() {
            if (confirm('Clear all HTML content?')) {
                document.getElementById('htmlEditor').value = '';
                refreshPreview();
            }
        }

        function exportHTML() {
            const html = generateFullHTML({
                title: document.getElementById('postTitle').value,
                slug: document.getElementById('postSlug').value,
                metaDescription: document.getElementById('postMetaDescription').value,
                keywords: document.getElementById('postKeywords').value,
                content: document.getElementById('htmlEditor').value,
                pdfs: currentPDFs
            });
            downloadHTML(html, `${document.getElementById('postSlug').value || 'blog-post'}-${currentLanguage}.html`);
        }

        function previewFullPage() {
            const html = generateFullHTML({
                title: document.getElementById('postTitle').value,
                slug: document.getElementById('postSlug').value,
                metaDescription: document.getElementById('postMetaDescription').value,
                keywords: document.getElementById('postKeywords').value,
                content: document.getElementById('htmlEditor').value,
                pdfs: currentPDFs
            });

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        }

        async function deletePost(slug) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Post deleted successfully!', 'success');
                    // Reload posts from database
                    await loadPosts();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete post');
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showMessage(`Failed to delete post: ${error.message}`, 'error');
            }
        }

        function loadPDFLibrary() {
            // Populate post selector
            populatePostSelect('pdfManagerPostSelect');
            // Show placeholder
            document.getElementById('pdfManagerPlaceholder').style.display = 'block';
            document.getElementById('pdfManagerContent').style.display = 'none';
        }

        async function loadPDFsForPost() {
            const slug = document.getElementById('pdfManagerPostSelect').value;

            if (!slug) {
                document.getElementById('pdfManagerPlaceholder').style.display = 'block';
                document.getElementById('pdfManagerContent').style.display = 'none';
                return;
            }

            document.getElementById('pdfManagerPlaceholder').style.display = 'none';
            document.getElementById('pdfManagerContent').style.display = 'block';

            try {
                const response = await authenticatedFetch(`/api/admin/blog/posts/${slug}/pdfs`, {});

                if (response.ok) {
                    const data = await response.json();
                    displayPDFsList(data.pdfs || []);
                } else {
                    displayPDFsList([]);
                }
            } catch (error) {
                console.error('Error loading PDFs:', error);
                displayPDFsList([]);
            }
        }

        function displayPDFsList(pdfs) {
            const pdfsList = document.getElementById('pdfsList');
            const noPDFsMessage = document.getElementById('noPDFsMessage');

            if (pdfs.length === 0) {
                pdfsList.style.display = 'none';
                noPDFsMessage.style.display = 'block';
                return;
            }

            pdfsList.style.display = 'grid';
            noPDFsMessage.style.display = 'none';

            pdfsList.innerHTML = pdfs.map(pdf => `
                <div class="pdf-card" style="border: 2px solid var(--gray-200); border-radius: 8px; padding: 20px; background: white;">
                    <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 15px;">
                        <div style="font-size: 48px;">üìÑ</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-primary" onclick="editPDF('${pdf.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="removePDF('${pdf.id}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>

                    ${pdf.thumbnail ? `
                        <div style="margin-bottom: 15px;">
                            <img src="${pdf.thumbnail}" alt="${pdf.title}"
                                 style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; border: 1px solid var(--gray-200);" />
                        </div>
                    ` : ''}

                    <h4 style="margin-bottom: 8px; color: var(--gray-900);">${pdf.title}</h4>
                    <p style="font-size: 14px; color: var(--gray-600); margin-bottom: 12px;">${pdf.description || 'No description'}</p>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 12px; border-top: 1px solid var(--gray-200);">
                        <span style="font-size: 12px; color: var(--gray-500);">
                            üì¶ ${formatFileSize(pdf.fileSize)}
                        </span>
                        <span style="font-size: 14px; font-weight: 600; color: ${pdf.price === 'Free' ? 'var(--success)' : 'var(--primary)'};">
                            ${pdf.price || 'Free'}
                        </span>
                    </div>

                    <a href="${pdf.filePath}" target="_blank" class="btn btn-sm btn-secondary" style="width: 100%; margin-top: 12px;">
                        üëÅÔ∏è Preview PDF
                    </a>
                </div>
            `).join('');
        }

        // ==================== SEO OPTIMIZATION SYSTEM ====================

        let seoAnalysisTimeout;

        function updateSEOAnalysis() {
            // Debounce for performance
            clearTimeout(seoAnalysisTimeout);
            seoAnalysisTimeout = setTimeout(() => {
                performSEOAnalysis();
            }, 300);
        }

        function performSEOAnalysis() {
            const title = document.getElementById('postTitle').value;
            const metaTitle = document.getElementById('postMetaTitle').value || title;
            const metaDesc = document.getElementById('postMetaDescription').value;
            const focusKeyword = document.getElementById('postFocusKeyword').value.toLowerCase();
            const htmlContent = document.getElementById('htmlEditor').value;
            const slug = document.getElementById('postSlug').value;

            // Extract text content from HTML
            const textContent = extractTextFromHTML(htmlContent).toLowerCase();
            const wordCount = textContent.split(/\s+/).filter(w => w.length > 0).length;

            // Calculate SEO Score
            const seoScore = calculateSEOScore({
                title, metaTitle, metaDesc, focusKeyword,
                textContent, htmlContent, wordCount, slug
            });

            // Update Score Display
            updateSEOScore(seoScore);

            // Update Field Lengths
            updateFieldLengths(title, metaTitle, metaDesc);

            // Update SEO Checklist
            updateSEOChecklist({
                title, metaTitle, metaDesc, focusKeyword,
                textContent, htmlContent, wordCount, slug
            });

            // Update Content Analysis
            updateContentAnalysis({
                textContent, wordCount, focusKeyword, htmlContent
            });

            // Update Previews
            updatePreviews(metaTitle || title, metaDesc, slug);

            // Update Advanced SEO Panels
            updateAdvancedSEOPanels({
                title, metaTitle, metaDesc, focusKeyword,
                textContent, htmlContent, wordCount, slug
            });

            // Update language name
            const langSelect = document.getElementById('editorLanguage');
            const langNames = {
                en: 'English', de: 'Deutsch', fr: 'Fran√ßais', es: 'Espa√±ol',
                pt: 'Portugu√™s', it: 'Italiano', nl: 'Nederlands', sv: 'Svenska',
                da: 'Dansk', no: 'Norsk', fi: 'Suomi'
            };
            document.getElementById('currentLanguageName').textContent = langNames[langSelect.value] || 'English';
        }

        function extractTextFromHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function calculateSEOScore(data) {
            let score = 0;
            const checks = [];

            // Title optimization (15 points)
            if (data.title.length >= 30 && data.title.length <= 60) {
                score += 15;
            } else if (data.title.length > 0) {
                score += 7;
            }

            // Meta title optimization (10 points)
            if (data.metaTitle.length >= 50 && data.metaTitle.length <= 60) {
                score += 10;
            } else if (data.metaTitle.length > 0) {
                score += 5;
            }

            // Meta description (15 points)
            if (data.metaDesc.length >= 150 && data.metaDesc.length <= 160) {
                score += 15;
            } else if (data.metaDesc.length >= 120 && data.metaDesc.length <= 170) {
                score += 10;
            } else if (data.metaDesc.length > 0) {
                score += 5;
            }

            // Focus keyword in title (15 points)
            if (data.focusKeyword && data.title.toLowerCase().includes(data.focusKeyword)) {
                score += 15;
            }

            // Focus keyword in meta description (10 points)
            if (data.focusKeyword && data.metaDesc.toLowerCase().includes(data.focusKeyword)) {
                score += 10;
            }

            // Focus keyword in content (15 points)
            if (data.focusKeyword && data.textContent.includes(data.focusKeyword)) {
                const density = calculateKeywordDensity(data.textContent, data.focusKeyword);
                if (density >= 0.5 && density <= 2.5) {
                    score += 15;
                } else if (density > 0) {
                    score += 7;
                }
            }

            // Content length (10 points)
            if (data.wordCount >= 300) {
                score += 10;
            } else if (data.wordCount >= 150) {
                score += 5;
            }

            // URL slug optimization (5 points)
            if (data.slug && data.slug.match(/^[a-z0-9-]+$/)) {
                score += 5;
            }

            // Headings structure (5 points)
            const hasH1 = /<h1[^>]*>/.test(data.htmlContent);
            const hasH2 = /<h2[^>]*>/.test(data.htmlContent);
            if (hasH1 && hasH2) {
                score += 5;
            } else if (hasH1 || hasH2) {
                score += 2;
            }

            return Math.min(100, score);
        }

        function calculateKeywordDensity(text, keyword) {
            if (!keyword || !text) return 0;
            const words = text.split(/\s+/).filter(w => w.length > 0);
            const keywordCount = (text.match(new RegExp(keyword, 'gi')) || []).length;
            return (keywordCount / words.length) * 100;
        }

        function updateSEOScore(score) {
            const scoreElement = document.getElementById('seoScoreValue');
            const badgeElement = document.getElementById('seoScoreBadge');

            scoreElement.textContent = score;

            // Color coding
            if (score >= 80) {
                badgeElement.style.background = '#10b981';
                badgeElement.style.color = 'white';
            } else if (score >= 60) {
                badgeElement.style.background = '#f59e0b';
                badgeElement.style.color = 'white';
            } else {
                badgeElement.style.background = '#ef4444';
                badgeElement.style.color = 'white';
            }
        }

        function updateFieldLengths(title, metaTitle, metaDesc) {
            // Title length
            const titleLen = title.length;
            document.getElementById('titleLength').textContent = titleLen;

            // Meta title length
            const metaTitleLen = metaTitle.length;
            document.getElementById('metaTitleLength').textContent = metaTitleLen;
            const metaTitleStatus = document.getElementById('metaTitleStatus');
            if (metaTitleLen >= 50 && metaTitleLen <= 60) {
                metaTitleStatus.innerHTML = '‚úÖ <span style="color: #10b981;">Optimal</span>';
            } else if (metaTitleLen > 60) {
                metaTitleStatus.innerHTML = '‚ö†Ô∏è <span style="color: #f59e0b;">Too long (may be truncated)</span>';
            } else if (metaTitleLen > 0) {
                metaTitleStatus.innerHTML = '‚ö†Ô∏è <span style="color: #f59e0b;">Too short</span>';
            } else {
                metaTitleStatus.textContent = '';
            }

            // Meta description length
            const metaDescLen = metaDesc.length;
            document.getElementById('metaDescLength').textContent = metaDescLen;
            const metaDescStatus = document.getElementById('metaDescStatus');
            if (metaDescLen >= 150 && metaDescLen <= 160) {
                metaDescStatus.innerHTML = '‚úÖ <span style="color: #10b981;">Optimal</span>';
            } else if (metaDescLen > 160) {
                metaDescStatus.innerHTML = '‚ö†Ô∏è <span style="color: #f59e0b;">Too long (may be truncated)</span>';
            } else if (metaDescLen >= 120) {
                metaDescStatus.innerHTML = '‚úÖ <span style="color: #10b981;">Good</span>';
            } else if (metaDescLen > 0) {
                metaDescStatus.innerHTML = '‚ö†Ô∏è <span style="color: #f59e0b;">Too short</span>';
            } else {
                metaDescStatus.textContent = '';
            }
        }

        function updateSEOChecklist(data) {
            const checks = [
                {
                    label: 'Focus keyword defined',
                    passed: data.focusKeyword && data.focusKeyword.length > 0,
                    tip: 'Define your main target keyword'
                },
                {
                    label: 'Keyword in title',
                    passed: data.focusKeyword && data.title.toLowerCase().includes(data.focusKeyword),
                    tip: 'Include your focus keyword in the title'
                },
                {
                    label: 'Keyword in meta description',
                    passed: data.focusKeyword && data.metaDesc.toLowerCase().includes(data.focusKeyword),
                    tip: 'Include your focus keyword in the meta description'
                },
                {
                    label: 'Keyword in content',
                    passed: data.focusKeyword && data.textContent.includes(data.focusKeyword),
                    tip: 'Use your focus keyword naturally in the content'
                },
                {
                    label: 'Meta description length optimal',
                    passed: data.metaDesc.length >= 150 && data.metaDesc.length <= 160,
                    tip: 'Keep meta description between 150-160 characters'
                },
                {
                    label: 'Content length sufficient',
                    passed: data.wordCount >= 300,
                    tip: 'Aim for at least 300 words for better SEO'
                },
                {
                    label: 'URL slug optimized',
                    passed: data.slug && data.slug.match(/^[a-z0-9-]+$/),
                    tip: 'Use lowercase letters and hyphens only'
                },
                {
                    label: 'Heading structure present',
                    passed: /<h1[^>]*>/.test(data.htmlContent) && /<h2[^>]*>/.test(data.htmlContent),
                    tip: 'Include H1 and H2 headings in your content'
                }
            ];

            const checklistHTML = checks.map(check => `
                <div style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="font-size: 18px;">${check.passed ? '‚úÖ' : '‚ùå'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: ${check.passed ? '600' : '400'}; color: ${check.passed ? '#10b981' : '#6b7280'};">
                            ${check.label}
                        </div>
                        ${!check.passed ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px;">${check.tip}</div>` : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('seoChecklist').innerHTML = checklistHTML;
        }

        function updateContentAnalysis(data) {
            const keywordDensity = data.focusKeyword ?
                calculateKeywordDensity(data.textContent, data.focusKeyword).toFixed(2) : '0.00';

            const readingTime = Math.max(1, Math.ceil(data.wordCount / 200));

            const analysisHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="padding: 12px; background: var(--gray-50); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Word Count</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">
                            ${data.wordCount}
                            <span style="font-size: 14px; color: ${data.wordCount >= 300 ? '#10b981' : '#f59e0b'}; font-weight: 400;">
                                ${data.wordCount >= 300 ? '‚úì Good' : '‚ö† Short'}
                            </span>
                        </div>
                    </div>

                    <div style="padding: 12px; background: var(--gray-50); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Keyword Density</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">
                            ${keywordDensity}%
                            <span style="font-size: 14px; color: ${keywordDensity >= 0.5 && keywordDensity <= 2.5 ? '#10b981' : '#f59e0b'}; font-weight: 400;">
                                ${keywordDensity >= 0.5 && keywordDensity <= 2.5 ? '‚úì Optimal' : keywordDensity > 2.5 ? '‚ö† High' : '‚ö† Low'}
                            </span>
                        </div>
                        <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">Target: 0.5-2.5%</div>
                    </div>

                    <div style="padding: 12px; background: var(--gray-50); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 4px;">Reading Time</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-900);">
                            ${readingTime} min
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('contentAnalysis').innerHTML = analysisHTML;
        }

        function updatePreviews(title, description, slug) {
            const siteUrl = 'https://yoursite.com';
            const fullUrl = `${siteUrl}/blog/${slug || 'your-slug'}`;

            // Google Preview
            document.getElementById('googlePreviewTitle').textContent = title || 'Your SEO Title Will Appear Here';
            document.getElementById('googlePreviewUrl').textContent = fullUrl;
            document.getElementById('googlePreviewDesc').textContent = description || 'Your meta description will appear here. Make it compelling to improve click-through rates!';

            // Facebook Preview
            document.getElementById('fbPreviewTitle').textContent = title || 'Your Post Title';
            document.getElementById('fbPreviewDesc').textContent = description || 'Your meta description...';

            // Twitter Preview
            document.getElementById('twitterPreviewTitle').textContent = title || 'Your Post Title';
            document.getElementById('twitterPreviewDesc').textContent = description || 'Your meta description...';

            // Update images in previews if featured image exists
            const featuredImage = document.getElementById('postFeaturedImage').value;
            if (featuredImage) {
                document.getElementById('fbPreviewImage').style.backgroundImage = `url(${featuredImage})`;
                document.getElementById('fbPreviewImage').style.backgroundSize = 'cover';
                document.getElementById('fbPreviewImage').style.backgroundPosition = 'center';
                document.getElementById('fbPreviewImage').textContent = '';

                document.getElementById('twitterPreviewImage').style.backgroundImage = `url(${featuredImage})`;
                document.getElementById('twitterPreviewImage').style.backgroundSize = 'cover';
                document.getElementById('twitterPreviewImage').style.backgroundPosition = 'center';
                document.getElementById('twitterPreviewImage').textContent = '';
            }
        }

        // ==================== ADVANCED SEO ANALYSIS ====================

        // Readability Analysis using Flesch Reading Ease
        function calculateReadability(text) {
            if (!text || text.length < 100) {
                return { score: 0, level: 'Insufficient content', gradeLevel: 0 };
            }

            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
            const words = text.split(/\s+/).filter(w => w.length > 0);
            const wordCount = words.length;

            // Count syllables
            const syllableCount = words.reduce((total, word) => {
                return total + countSyllables(word);
            }, 0);

            if (sentences === 0 || wordCount === 0) {
                return { score: 0, level: 'Invalid content', gradeLevel: 0 };
            }

            // Flesch Reading Ease = 206.835 - 1.015 √ó (total words / total sentences) - 84.6 √ó (total syllables / total words)
            const avgWordsPerSentence = wordCount / sentences;
            const avgSyllablesPerWord = syllableCount / wordCount;

            const fleschScore = 206.835 - (1.015 * avgWordsPerSentence) - (84.6 * avgSyllablesPerWord);
            const clampedScore = Math.max(0, Math.min(100, fleschScore));

            // Flesch-Kincaid Grade Level = 0.39 √ó (total words / total sentences) + 11.8 √ó (total syllables / total words) - 15.59
            const gradeLevel = (0.39 * avgWordsPerSentence) + (11.8 * avgSyllablesPerWord) - 15.59;

            let level;
            if (clampedScore >= 90) level = 'Very Easy (5th grade)';
            else if (clampedScore >= 80) level = 'Easy (6th grade)';
            else if (clampedScore >= 70) level = 'Fairly Easy (7th grade)';
            else if (clampedScore >= 60) level = 'Standard (8th-9th grade)';
            else if (clampedScore >= 50) level = 'Fairly Difficult (10th-12th grade)';
            else if (clampedScore >= 30) level = 'Difficult (College)';
            else level = 'Very Difficult (College graduate)';

            return {
                score: Math.round(clampedScore),
                level,
                gradeLevel: Math.max(0, Math.round(gradeLevel * 10) / 10),
                avgWordsPerSentence: Math.round(avgWordsPerSentence * 10) / 10,
                avgSyllablesPerWord: Math.round(avgSyllablesPerWord * 100) / 100
            };
        }

        function countSyllables(word) {
            word = word.toLowerCase().replace(/[^a-z]/g, '');
            if (word.length <= 3) return 1;

            word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
            word = word.replace(/^y/, '');
            const syllables = word.match(/[aeiouy]{1,2}/g);

            return syllables ? syllables.length : 1;
        }

        // LSI (Latent Semantic Indexing) Keyword Extraction
        function extractLSIKeywords(text, focusKeyword) {
            const commonWords = new Set(['the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'i', 'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at', 'this', 'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there', 'their', 'what', 'so', 'up', 'out', 'if', 'about', 'who', 'get', 'which', 'go', 'me', 'when', 'make', 'can', 'like', 'time', 'no', 'just', 'him', 'know', 'take', 'people', 'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 'other', 'than', 'then', 'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also', 'back', 'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well', 'way', 'even', 'new', 'want', 'because', 'any', 'these', 'give', 'day', 'most', 'us', 'is', 'was', 'are', 'been', 'has', 'had', 'were', 'said', 'did', 'having', 'may', 'should', 'each', 'many', 'more', 'very', 'such', 'much']);

            const words = text.toLowerCase()
                .replace(/<[^>]*>/g, ' ')
                .replace(/[^a-z\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3 && !commonWords.has(word));

            const wordFreq = {};
            words.forEach(word => {
                wordFreq[word] = (wordFreq[word] || 0) + 1;
            });

            // Get top keywords excluding focus keyword
            const focusWords = focusKeyword.toLowerCase().split(/\s+/);
            const lsiKeywords = Object.entries(wordFreq)
                .filter(([word]) => !focusWords.includes(word))
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([word, freq]) => ({ word, frequency: freq }));

            return lsiKeywords;
        }

        // Schema Markup Generator
        function generateSchemaMarkup(post, locale) {
            const baseUrl = 'https://yoursite.com'; // TODO: Replace with actual domain
            const schemas = [];

            // Article Schema
            const articleSchema = {
                "@context": "https://schema.org",
                "@type": "Article",
                "headline": post.metaTitle || post.title,
                "description": post.metaDescription,
                "image": post.featuredImage ? `${baseUrl}${post.featuredImage}` : undefined,
                "author": {
                    "@type": "Organization",
                    "name": "LessonCraftStudio"
                },
                "publisher": {
                    "@type": "Organization",
                    "name": "LessonCraftStudio",
                    "logo": {
                        "@type": "ImageObject",
                        "url": `${baseUrl}/logo-lcs.png`
                    }
                },
                "datePublished": new Date().toISOString(),
                "dateModified": new Date().toISOString(),
                "mainEntityOfPage": {
                    "@type": "WebPage",
                    "@id": `${baseUrl}/${locale}/blog/${post.slug}`
                },
                "keywords": post.focusKeyword,
                "inLanguage": locale
            };
            schemas.push(articleSchema);

            // Breadcrumb Schema
            const breadcrumbSchema = {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [
                    {
                        "@type": "ListItem",
                        "position": 1,
                        "name": "Home",
                        "item": `${baseUrl}/${locale}`
                    },
                    {
                        "@type": "ListItem",
                        "position": 2,
                        "name": "Blog",
                        "item": `${baseUrl}/${locale}/blog`
                    },
                    {
                        "@type": "ListItem",
                        "position": 3,
                        "name": post.title,
                        "item": `${baseUrl}/${locale}/blog/${post.slug}`
                    }
                ]
            };
            schemas.push(breadcrumbSchema);

            // Educational Content Schema
            const educationalSchema = {
                "@context": "https://schema.org",
                "@type": "LearningResource",
                "name": post.title,
                "description": post.metaDescription,
                "educationalLevel": "Elementary School",
                "learningResourceType": "Educational Worksheet",
                "inLanguage": locale,
                "provider": {
                    "@type": "Organization",
                    "name": "LessonCraftStudio"
                }
            };
            schemas.push(educationalSchema);

            return schemas;
        }

        // Heading Hierarchy Validator
        function validateHeadingHierarchy(htmlContent) {
            const headings = [];
            const headingRegex = /<h([1-6])[^>]*>(.*?)<\/h\1>/gi;
            let match;

            while ((match = headingRegex.exec(htmlContent)) !== null) {
                headings.push({
                    level: parseInt(match[1]),
                    text: match[2].replace(/<[^>]*>/g, '').trim()
                });
            }

            const issues = [];
            const recommendations = [];

            // Check for H1
            const h1Count = headings.filter(h => h.level === 1).length;
            if (h1Count === 0) {
                issues.push('Missing H1 heading - Every article needs exactly one H1');
            } else if (h1Count > 1) {
                issues.push(`Multiple H1 headings detected (${h1Count}) - Use only one H1 per page`);
            }

            // Check hierarchy
            let previousLevel = 0;
            headings.forEach((heading, index) => {
                if (heading.level > previousLevel + 1 && previousLevel !== 0) {
                    issues.push(`Heading hierarchy skip: H${previousLevel} ‚Üí H${heading.level} (line ${index + 1})`);
                }
                previousLevel = heading.level;
            });

            // Check for keywords in headings
            recommendations.push('Consider including focus keyword in at least one H2 heading');

            // Check heading distribution
            const h2Count = headings.filter(h => h.level === 2).length;
            if (h2Count < 2) {
                recommendations.push('Add more H2 headings to improve content structure (recommended: 3-5)');
            }

            return {
                headings,
                h1Count,
                h2Count,
                totalHeadings: headings.length,
                issues,
                recommendations,
                isValid: issues.length === 0
            };
        }

        // Image Alt Text Analyzer
        function analyzeImages(htmlContent) {
            const images = [];
            const imgRegex = /<img[^>]*>/gi;
            let match;

            while ((match = imgRegex.exec(htmlContent)) !== null) {
                const imgTag = match[0];
                const srcMatch = imgTag.match(/src=["']([^"']*)["']/);
                const altMatch = imgTag.match(/alt=["']([^"']*)["']/);

                images.push({
                    src: srcMatch ? srcMatch[1] : '',
                    alt: altMatch ? altMatch[1] : '',
                    hasAlt: !!altMatch && altMatch[1].length > 0
                });
            }

            const missingAlt = images.filter(img => !img.hasAlt).length;
            const score = images.length === 0 ? 100 : Math.round(((images.length - missingAlt) / images.length) * 100);

            return {
                totalImages: images.length,
                imagesWithAlt: images.length - missingAlt,
                missingAlt,
                score,
                images,
                issues: missingAlt > 0 ? [`${missingAlt} images missing alt text`] : []
            };
        }

        // Content Quality Scorer
        function calculateContentQuality(data) {
            let score = 0;
            const maxScore = 100;
            const details = [];

            // 1. Word count (20 points)
            if (data.wordCount >= 1500) {
                score += 20;
                details.push({ category: 'Length', score: 20, max: 20, status: 'excellent' });
            } else if (data.wordCount >= 1000) {
                score += 15;
                details.push({ category: 'Length', score: 15, max: 20, status: 'good' });
            } else if (data.wordCount >= 500) {
                score += 10;
                details.push({ category: 'Length', score: 10, max: 20, status: 'fair' });
            } else {
                score += 5;
                details.push({ category: 'Length', score: 5, max: 20, status: 'poor' });
            }

            // 2. Readability (15 points)
            const readability = calculateReadability(data.textContent);
            if (readability.score >= 60 && readability.score <= 80) {
                score += 15;
                details.push({ category: 'Readability', score: 15, max: 15, status: 'excellent' });
            } else if (readability.score >= 50 || readability.score >= 80) {
                score += 10;
                details.push({ category: 'Readability', score: 10, max: 15, status: 'good' });
            } else {
                score += 5;
                details.push({ category: 'Readability', score: 5, max: 15, status: 'fair' });
            }

            // 3. Heading structure (15 points)
            const headingAnalysis = validateHeadingHierarchy(data.htmlContent);
            if (headingAnalysis.isValid && headingAnalysis.h2Count >= 3) {
                score += 15;
                details.push({ category: 'Structure', score: 15, max: 15, status: 'excellent' });
            } else if (headingAnalysis.h1Count === 1) {
                score += 10;
                details.push({ category: 'Structure', score: 10, max: 15, status: 'good' });
            } else {
                score += 5;
                details.push({ category: 'Structure', score: 5, max: 15, status: 'fair' });
            }

            // 4. Image optimization (10 points)
            const imageAnalysis = analyzeImages(data.htmlContent);
            if (imageAnalysis.score === 100) {
                score += 10;
                details.push({ category: 'Images', score: 10, max: 10, status: 'excellent' });
            } else if (imageAnalysis.score >= 75) {
                score += 7;
                details.push({ category: 'Images', score: 7, max: 10, status: 'good' });
            } else if (imageAnalysis.score >= 50) {
                score += 5;
                details.push({ category: 'Images', score: 5, max: 10, status: 'fair' });
            } else {
                score += 2;
                details.push({ category: 'Images', score: 2, max: 10, status: 'poor' });
            }

            // 5. Keyword optimization (15 points)
            const keywordDensity = calculateKeywordDensity(data.textContent, data.focusKeyword);
            if (keywordDensity >= 0.5 && keywordDensity <= 2.5 && data.title.toLowerCase().includes(data.focusKeyword)) {
                score += 15;
                details.push({ category: 'Keywords', score: 15, max: 15, status: 'excellent' });
            } else if (data.focusKeyword && data.textContent.includes(data.focusKeyword)) {
                score += 10;
                details.push({ category: 'Keywords', score: 10, max: 15, status: 'good' });
            } else {
                score += 5;
                details.push({ category: 'Keywords', score: 5, max: 15, status: 'fair' });
            }

            // 6. Sentence structure (10 points)
            const sentences = data.textContent.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const avgSentenceLength = data.wordCount / sentences.length;
            if (avgSentenceLength >= 15 && avgSentenceLength <= 25) {
                score += 10;
                details.push({ category: 'Sentences', score: 10, max: 10, status: 'excellent' });
            } else if (avgSentenceLength >= 10 && avgSentenceLength <= 30) {
                score += 7;
                details.push({ category: 'Sentences', score: 7, max: 10, status: 'good' });
            } else {
                score += 4;
                details.push({ category: 'Sentences', score: 4, max: 10, status: 'fair' });
            }

            // 7. Meta optimization (15 points)
            if (data.metaTitle.length >= 50 && data.metaTitle.length <= 60 &&
                data.metaDesc.length >= 150 && data.metaDesc.length <= 160) {
                score += 15;
                details.push({ category: 'Meta Tags', score: 15, max: 15, status: 'excellent' });
            } else if (data.metaTitle && data.metaDesc) {
                score += 10;
                details.push({ category: 'Meta Tags', score: 10, max: 15, status: 'good' });
            } else {
                score += 5;
                details.push({ category: 'Meta Tags', score: 5, max: 15, status: 'fair' });
            }

            return {
                score: Math.min(maxScore, score),
                grade: score >= 90 ? 'A' : score >= 80 ? 'B' : score >= 70 ? 'C' : score >= 60 ? 'D' : 'F',
                details
            };
        }

        // Update Advanced SEO Panels
        function updateAdvancedSEOPanels(data) {
            // Update Readability Score
            const readability = calculateReadability(data.textContent);
            const readabilityHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 36px; font-weight: 700; color: ${readability.score >= 60 ? '#10b981' : '#f59e0b'};">
                        ${readability.score}
                    </div>
                    <div style="font-size: 12px; color: var(--gray-600); margin-top: 5px;">Flesch Reading Ease</div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Level:</strong> ${readability.level}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Grade Level:</strong> ${readability.gradeLevel}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Avg Words/Sentence:</strong> ${readability.avgWordsPerSentence || 0}
                </div>
                <small style="color: var(--gray-600);">
                    ${readability.score >= 60 ? '‚úÖ Easy to read' : '‚ö†Ô∏è Consider simplifying sentences'}
                </small>
            `;
            document.getElementById('readabilityScore').innerHTML = readabilityHTML;

            // Update Content Quality Score
            const quality = calculateContentQuality(data);
            const qualityHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 36px; font-weight: 700; color: ${quality.grade === 'A' ? '#10b981' : quality.grade === 'B' ? '#3b82f6' : quality.grade === 'C' ? '#f59e0b' : '#ef4444'};">
                        ${quality.score}/100
                    </div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--gray-700); margin-top: 5px;">
                        Grade: ${quality.grade}
                    </div>
                </div>
                <div style="font-size: 12px;">
                    ${quality.details.map(detail => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid var(--gray-200);">
                            <span>${detail.category}</span>
                            <span style="font-weight: 600; color: ${detail.status === 'excellent' ? '#10b981' : detail.status === 'good' ? '#3b82f6' : '#f59e0b'};">
                                ${detail.score}/${detail.max}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('qualityScore').innerHTML = qualityHTML;

            // Update LSI Keywords
            const lsiKeywords = extractLSIKeywords(data.textContent, data.focusKeyword);
            const lsiHTML = lsiKeywords.length > 0 ? `
                <div style="font-size: 13px;">
                    ${lsiKeywords.slice(0, 8).map(keyword => `
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--gray-100);">
                            <span style="color: var(--gray-700);">${keyword.word}</span>
                            <span style="background: var(--gray-100); padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${keyword.frequency}√ó
                            </span>
                        </div>
                    `).join('')}
                </div>
                <small style="display: block; margin-top: 10px; color: var(--gray-600);">
                    üí° Consider using these related terms naturally
                </small>
            ` : '<div style="color: var(--gray-500);">Add more content to see keyword suggestions</div>';
            document.getElementById('lsiKeywords').innerHTML = lsiHTML;

            // Update Heading Hierarchy
            const headingAnalysis = validateHeadingHierarchy(data.htmlContent);
            const headingHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>H1 Headings:</span>
                        <span style="font-weight: 600; color: ${headingAnalysis.h1Count === 1 ? '#10b981' : '#ef4444'};">
                            ${headingAnalysis.h1Count} ${headingAnalysis.h1Count === 1 ? '‚úÖ' : '‚ùå'}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>H2 Headings:</span>
                        <span style="font-weight: 600; color: ${headingAnalysis.h2Count >= 2 ? '#10b981' : '#f59e0b'};">
                            ${headingAnalysis.h2Count} ${headingAnalysis.h2Count >= 2 ? '‚úÖ' : '‚ö†Ô∏è'}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Headings:</span>
                        <span style="font-weight: 600;">${headingAnalysis.totalHeadings}</span>
                    </div>
                </div>
                ${headingAnalysis.issues.length > 0 ? `
                    <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 10px; margin: 10px 0; border-radius: 4px;">
                        <strong style="color: #991b1b; display: block; margin-bottom: 5px;">Issues:</strong>
                        ${headingAnalysis.issues.map(issue => `<div style="color: #991b1b; font-size: 12px;">‚Ä¢ ${issue}</div>`).join('')}
                    </div>
                ` : ''}
                ${headingAnalysis.recommendations.length > 0 ? `
                    <div style="font-size: 12px; color: var(--gray-600); margin-top: 10px;">
                        ${headingAnalysis.recommendations.map(rec => `<div>üí° ${rec}</div>`).join('')}
                    </div>
                ` : ''}
            `;
            document.getElementById('headingHierarchy').innerHTML = headingHTML;

            // Update Image Analysis
            const imageAnalysis = analyzeImages(data.htmlContent);
            const imageHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 36px; font-weight: 700; color: ${imageAnalysis.score === 100 ? '#10b981' : imageAnalysis.score >= 75 ? '#3b82f6' : '#f59e0b'};">
                        ${imageAnalysis.score}%
                    </div>
                    <div style="font-size: 12px; color: var(--gray-600); margin-top: 5px;">Images Optimized</div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Total Images:</strong> ${imageAnalysis.totalImages}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>With Alt Text:</strong> <span style="color: #10b981;">${imageAnalysis.imagesWithAlt}</span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Missing Alt:</strong> <span style="color: ${imageAnalysis.missingAlt > 0 ? '#ef4444' : '#10b981'};">${imageAnalysis.missingAlt}</span>
                </div>
                ${imageAnalysis.missingAlt > 0 ? `
                    <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px; color: #991b1b;">
                        ‚ö†Ô∏è Add alt text to all images for accessibility and SEO
                    </div>
                ` : imageAnalysis.totalImages > 0 ? `
                    <div style="background: #f0fdf4; border-left: 3px solid #10b981; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px; color: #166534;">
                        ‚úÖ All images have alt text!
                    </div>
                ` : `
                    <div style="color: var(--gray-500); font-size: 12px; margin-top: 10px;">
                        No images detected in content
                    </div>
                `}
            `;
            document.getElementById('imageAnalysis').innerHTML = imageHTML;

            // Update Schema Markup
            const postData = {
                title: data.title,
                metaTitle: data.metaTitle,
                metaDescription: data.metaDesc,
                focusKeyword: data.focusKeyword,
                slug: data.slug,
                featuredImage: document.getElementById('postFeaturedImage').value
            };
            const schemas = generateSchemaMarkup(postData, currentLanguage);
            const schemaJSON = JSON.stringify(schemas, null, 2);
            document.getElementById('schemaMarkup').textContent = schemaJSON;
        }

        // Copy Schema to Clipboard
        function copySchemaToClipboard() {
            const schemaText = document.getElementById('schemaMarkup').textContent;
            navigator.clipboard.writeText(schemaText).then(() => {
                showMessage('Schema markup copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showMessage('Failed to copy schema markup', 'error');
            });
        }

        // ==================== END ADVANCED SEO ANALYSIS ====================

        // ==================== END SEO OPTIMIZATION SYSTEM ====================

        // Setup event listeners
        function setupEventListeners() {
            // Auto-generate slug from title
            document.getElementById('postTitle').addEventListener('input', function() {
                const slugField = document.getElementById('postSlug');
                if (!slugField.value || currentPost === null) {
                    slugField.value = generateSlug(this.value);
                }
            });

            // Update PDF file size when file is selected
            document.getElementById('modalPDFFile').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    document.getElementById('modalPDFSize').value = formatFileSize(e.target.files[0].size);
                }
            });

            // Trigger SEO analysis on HTML editor changes
            document.getElementById('htmlEditor').addEventListener('input', updateSEOAnalysis);
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>