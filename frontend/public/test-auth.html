<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Token Tester</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0051cc;
    }
    .error {
      color: #ff0000;
    }
    .success {
      color: #00aa00;
    }
    pre {
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîê Auth Token Tester</h1>

  <div class="section">
    <h2>Current Tokens</h2>
    <button onclick="checkTokens()">Check Tokens</button>
    <button onclick="clearTokens()">Clear All Tokens</button>
    <div id="tokenInfo"></div>
  </div>

  <div class="section">
    <h2>Test Admin API</h2>
    <button onclick="testAdminAPI()">Test Create User API</button>
    <div id="apiResult"></div>
  </div>

  <div class="section">
    <h2>User Info</h2>
    <button onclick="getUserInfo()">Get My User Info</button>
    <div id="userInfo"></div>
  </div>

  <script>
    function checkTokens() {
      const accessToken = localStorage.getItem('accessToken');
      const refreshToken = document.cookie.split('; ').find(row => row.startsWith('refreshToken='));

      let html = '<h3>Tokens Found:</h3>';
      html += '<p><strong>Access Token:</strong> ' + (accessToken ? '‚úÖ Present' : '‚ùå Missing') + '</p>';

      if (accessToken) {
        // Decode JWT (just the payload, not verifying signature)
        try {
          const parts = accessToken.split('.');
          const payload = JSON.parse(atob(parts[1]));
          html += '<pre>' + JSON.stringify(payload, null, 2) + '</pre>';

          // Check expiration
          const exp = payload.exp * 1000; // Convert to milliseconds
          const now = Date.now();
          if (now > exp) {
            html += '<p class="error">‚ö†Ô∏è Token is EXPIRED!</p>';
          } else {
            const timeLeft = Math.floor((exp - now) / 1000 / 60);
            html += '<p class="success">‚úÖ Token valid for ' + timeLeft + ' more minutes</p>';
          }
        } catch (e) {
          html += '<p class="error">Failed to decode token: ' + e.message + '</p>';
        }
      }

      html += '<p><strong>Refresh Token:</strong> ' + (refreshToken ? '‚úÖ Present' : '‚ùå Missing') + '</p>';

      document.getElementById('tokenInfo').innerHTML = html;
    }

    async function testAdminAPI() {
      const accessToken = localStorage.getItem('accessToken');

      if (!accessToken) {
        document.getElementById('apiResult').innerHTML = '<p class="error">‚ùå No access token found. Please sign in.</p>';
        return;
      }

      try {
        const response = await fetch('/api/admin/users', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        });

        let html = '<h3>API Response:</h3>';
        html += '<p><strong>Status:</strong> ' + response.status + ' ' + response.statusText + '</p>';

        if (response.ok) {
          html += '<p class="success">‚úÖ Admin API access works!</p>';
          const data = await response.json();
          html += '<pre>' + JSON.stringify(data, null, 2).substring(0, 500) + '...</pre>';
        } else {
          html += '<p class="error">‚ùå Admin API access FAILED!</p>';
          const error = await response.text();
          html += '<p>' + error + '</p>';

          if (response.status === 401) {
            html += '<p class="error"><strong>Solution:</strong> Your token is invalid or you need admin privileges. Sign out and sign back in.</p>';
          }
        }

        document.getElementById('apiResult').innerHTML = html;
      } catch (error) {
        document.getElementById('apiResult').innerHTML = '<p class="error">Error: ' + error.message + '</p>';
      }
    }

    async function getUserInfo() {
      const accessToken = localStorage.getItem('accessToken');

      if (!accessToken) {
        document.getElementById('userInfo').innerHTML = '<p class="error">‚ùå No access token found. Please sign in.</p>';
        return;
      }

      try {
        const response = await fetch('/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        });

        let html = '<h3>User Info:</h3>';

        if (response.ok) {
          const data = await response.json();
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

          if (data.isAdmin) {
            html += '<p class="success">‚úÖ You are an ADMIN</p>';
          } else {
            html += '<p class="error">‚ùå You are NOT an admin</p>';
          }
        } else {
          html += '<p class="error">Failed to get user info: ' + response.status + '</p>';
        }

        document.getElementById('userInfo').innerHTML = html;
      } catch (error) {
        document.getElementById('userInfo').innerHTML = '<p class="error">Error: ' + error.message + '</p>';
      }
    }

    function clearTokens() {
      localStorage.removeItem('accessToken');
      document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
      alert('‚úÖ All tokens cleared! Please sign in again.');
      location.reload();
    }

    // Auto-check on load
    window.addEventListener('load', checkTokens);
  </script>
</body>
</html>
