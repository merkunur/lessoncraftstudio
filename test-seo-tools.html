<!DOCTYPE html>
<html>
<head>
    <title>SEO Tools Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ðŸ§ª SEO Tools Functionality Test</h1>

    <div class="test-section">
        <h2>Test 1: Verify SEO Functions Exist</h2>
        <div id="test1-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Test SEO Score Calculation</h2>
        <div id="test2-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Test Keyword Density Calculation</h2>
        <div id="test3-results"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Test Real-time Analysis</h2>
        <div id="test4-results"></div>
        <div>
            <input type="text" id="testTitle" placeholder="Test Title">
            <input type="text" id="testMetaTitle" placeholder="Test Meta Title">
            <textarea id="testContent" placeholder="Test Content"></textarea>
            <button onclick="runRealtimeTest()">Run Real-time Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Test 5: Database Persistence Test</h2>
        <div id="test5-results"></div>
        <button onclick="runPersistenceTest()">Test Save/Load</button>
    </div>

    <script>
        const results = {
            test1: [],
            test2: [],
            test3: [],
            test4: [],
            test5: []
        };

        // Test 1: Verify Functions Exist
        function test1() {
            const functions = [
                'updateSEOAnalysis',
                'performSEOAnalysis',
                'calculateSEOScore',
                'calculateKeywordDensity',
                'updateSEOScore',
                'updateFieldLengths',
                'updateSEOChecklist',
                'updateContentAnalysis',
                'updatePreviews',
                'extractTextFromHTML'
            ];

            // Open the blog manager in an iframe
            const iframe = document.createElement('iframe');
            iframe.src = '/worksheet-generators/blog-content-manager.html';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            iframe.onload = function() {
                const iframeWindow = iframe.contentWindow;

                functions.forEach(func => {
                    if (typeof iframeWindow[func] === 'function') {
                        results.test1.push({ pass: true, message: `âœ“ ${func}() exists` });
                    } else {
                        results.test1.push({ pass: false, message: `âœ— ${func}() is missing` });
                    }
                });

                displayResults('test1');
            };
        }

        // Test 2: Test SEO Score Calculation
        function test2() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                results.test2.push({ pass: false, message: 'Iframe not found' });
                displayResults('test2');
                return;
            }

            const iframeWindow = iframe.contentWindow;

            const testData = {
                title: 'Best Math Worksheets for Kids - Complete Guide',
                metaTitle: 'Best Math Worksheets for Kids - Complete Learning Guide',
                metaDesc: 'Discover comprehensive math worksheets for kids with engaging activities. Perfect for grade 1-5 students. Download printable worksheets with answer keys today.',
                focusKeyword: 'math worksheets for kids',
                textContent: 'Math worksheets for kids are essential learning tools. Our math worksheets for kids help children practice addition, subtraction, and more. These printable math worksheets for kids include answer keys and are perfect for home or classroom use. Each worksheet is designed to make learning fun and effective.',
                htmlContent: '<h1>Math Worksheets</h1><h2>Grade 1 Worksheets</h2><h2>Grade 2 Worksheets</h2><p>Content here</p>',
                wordCount: 56,
                slug: 'math-worksheets-for-kids'
            };

            try {
                const score = iframeWindow.calculateSEOScore(testData);

                if (score >= 80) {
                    results.test2.push({ pass: true, message: `âœ“ SEO Score: ${score}/100 (Excellent)` });
                } else if (score >= 60) {
                    results.test2.push({ pass: true, message: `âœ“ SEO Score: ${score}/100 (Good)` });
                } else {
                    results.test2.push({ pass: false, message: `âœ— SEO Score: ${score}/100 (Needs improvement)` });
                }

                // Test individual criteria
                if (testData.title.length >= 30 && testData.title.length <= 60) {
                    results.test2.push({ pass: true, message: 'âœ“ Title length optimal (30-60 chars)' });
                } else {
                    results.test2.push({ pass: false, message: 'âœ— Title length not optimal' });
                }

                if (testData.metaDesc.length >= 150 && testData.metaDesc.length <= 160) {
                    results.test2.push({ pass: true, message: 'âœ“ Meta description length optimal' });
                } else {
                    results.test2.push({ pass: false, message: 'âœ— Meta description length not optimal' });
                }

                if (testData.title.toLowerCase().includes(testData.focusKeyword)) {
                    results.test2.push({ pass: true, message: 'âœ“ Focus keyword in title' });
                } else {
                    results.test2.push({ pass: false, message: 'âœ— Focus keyword not in title' });
                }

            } catch (error) {
                results.test2.push({ pass: false, message: `âœ— Error: ${error.message}` });
            }

            displayResults('test2');
        }

        // Test 3: Test Keyword Density
        function test3() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                results.test3.push({ pass: false, message: 'Iframe not found' });
                displayResults('test3');
                return;
            }

            const iframeWindow = iframe.contentWindow;

            const testCases = [
                {
                    text: 'math worksheets math worksheets math worksheets test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test test',
                    keyword: 'math worksheets',
                    expectedDensity: 6 // 3 occurrences in 50 words = 6%
                },
                {
                    text: 'one two three four five six seven eight nine ten eleven twelve thirteen fourteen fifteen sixteen seventeen eighteen nineteen twenty',
                    keyword: 'missing',
                    expectedDensity: 0
                }
            ];

            testCases.forEach((testCase, index) => {
                try {
                    const density = iframeWindow.calculateKeywordDensity(testCase.text, testCase.keyword);
                    const diff = Math.abs(density - testCase.expectedDensity);

                    if (diff < 1) {
                        results.test3.push({ pass: true, message: `âœ“ Test ${index + 1}: Density ${density.toFixed(2)}% (expected ~${testCase.expectedDensity}%)` });
                    } else {
                        results.test3.push({ pass: false, message: `âœ— Test ${index + 1}: Density ${density.toFixed(2)}% (expected ${testCase.expectedDensity}%)` });
                    }
                } catch (error) {
                    results.test3.push({ pass: false, message: `âœ— Test ${index + 1}: Error - ${error.message}` });
                }
            });

            displayResults('test3');
        }

        // Test 4: Real-time Analysis
        function runRealtimeTest() {
            results.test4 = [];
            const iframe = document.querySelector('iframe');

            if (!iframe) {
                results.test4.push({ pass: false, message: 'Iframe not found' });
                displayResults('test4');
                return;
            }

            const iframeWindow = iframe.contentWindow;
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Set test values
            const titleInput = iframeDoc.getElementById('postTitle');
            const metaTitleInput = iframeDoc.getElementById('postMetaTitle');
            const htmlEditor = iframeDoc.getElementById('htmlEditor');
            const focusKeywordInput = iframeDoc.getElementById('postFocusKeyword');

            if (!titleInput || !metaTitleInput || !htmlEditor || !focusKeywordInput) {
                results.test4.push({ pass: false, message: 'âœ— Required input fields not found' });
                displayResults('test4');
                return;
            }

            titleInput.value = 'Complete Guide to Math Worksheets for Kids';
            metaTitleInput.value = 'Complete Guide to Math Worksheets for Kids - Free Download';
            focusKeywordInput.value = 'math worksheets';
            htmlEditor.value = '<h1>Math Worksheets</h1><h2>Introduction</h2><p>Math worksheets are great tools for learning. Our math worksheets help kids practice essential skills. Download free math worksheets today and start learning!</p>';

            // Trigger SEO analysis
            try {
                iframeWindow.updateSEOAnalysis();

                setTimeout(() => {
                    const scoreElement = iframeDoc.getElementById('seoScoreValue');
                    if (scoreElement) {
                        const score = parseInt(scoreElement.textContent);
                        results.test4.push({ pass: true, message: `âœ“ Real-time analysis triggered. Score: ${score}/100` });
                    } else {
                        results.test4.push({ pass: false, message: 'âœ— SEO score element not updated' });
                    }

                    // Check if preview cards updated
                    const googlePreviewTitle = iframeDoc.getElementById('googlePreviewTitle');
                    if (googlePreviewTitle && googlePreviewTitle.textContent.includes('Math Worksheets')) {
                        results.test4.push({ pass: true, message: 'âœ“ Preview cards updated' });
                    } else {
                        results.test4.push({ pass: false, message: 'âœ— Preview cards not updated' });
                    }

                    displayResults('test4');
                }, 500);
            } catch (error) {
                results.test4.push({ pass: false, message: `âœ— Error: ${error.message}` });
                displayResults('test4');
            }
        }

        // Test 5: Database Persistence
        async function runPersistenceTest() {
            results.test5 = [];

            try {
                // Test 1: Create a test post
                const testSlug = 'seo-test-' + Date.now();
                const testData = {
                    slug: testSlug,
                    translations: {
                        en: {
                            title: 'SEO Test Post',
                            content: '<p>Test content for SEO</p>',
                            excerpt: 'Test excerpt',
                            metaTitle: 'SEO Test Post - Meta Title',
                            metaDescription: 'This is a meta description for SEO testing purposes. It should be between 150-160 characters long for optimal search engine results.',
                            focusKeyword: 'seo test',
                            author: 'Test Author'
                        }
                    },
                    category: 'teaching-resources',
                    keywords: ['seo', 'test'],
                    status: 'draft'
                };

                const createResponse = await fetch('http://localhost:3001/api/admin/blog/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer dev-bypass',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (createResponse.ok) {
                    results.test5.push({ pass: true, message: 'âœ“ Test post created successfully' });

                    // Test 2: Retrieve the post
                    const getResponse = await fetch(`http://localhost:3001/api/admin/blog/posts/${testSlug}`, {
                        headers: { 'Authorization': 'Bearer dev-bypass' }
                    });

                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        const post = data.post;

                        // Verify SEO fields
                        if (post.translations.en.metaTitle === testData.translations.en.metaTitle) {
                            results.test5.push({ pass: true, message: 'âœ“ Meta title persisted correctly' });
                        } else {
                            results.test5.push({ pass: false, message: 'âœ— Meta title not persisted' });
                        }

                        if (post.translations.en.focusKeyword === testData.translations.en.focusKeyword) {
                            results.test5.push({ pass: true, message: 'âœ“ Focus keyword persisted correctly' });
                        } else {
                            results.test5.push({ pass: false, message: 'âœ— Focus keyword not persisted' });
                        }

                        if (post.translations.en.metaDescription === testData.translations.en.metaDescription) {
                            results.test5.push({ pass: true, message: 'âœ“ Meta description persisted correctly' });
                        } else {
                            results.test5.push({ pass: false, message: 'âœ— Meta description not persisted' });
                        }

                        // Test 3: Delete the test post
                        const deleteResponse = await fetch(`http://localhost:3001/api/admin/blog/posts/${testSlug}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer dev-bypass' }
                        });

                        if (deleteResponse.ok) {
                            results.test5.push({ pass: true, message: 'âœ“ Test post deleted successfully' });
                        } else {
                            results.test5.push({ pass: false, message: 'âœ— Failed to delete test post' });
                        }
                    } else {
                        results.test5.push({ pass: false, message: 'âœ— Failed to retrieve test post' });
                    }
                } else {
                    const error = await createResponse.text();
                    results.test5.push({ pass: false, message: `âœ— Failed to create test post: ${error}` });
                }
            } catch (error) {
                results.test5.push({ pass: false, message: `âœ— Error: ${error.message}` });
            }

            displayResults('test5');
        }

        function displayResults(testId) {
            const container = document.getElementById(`${testId}-results`);
            container.innerHTML = results[testId].map(result =>
                `<div class="test-result ${result.pass ? 'pass' : 'fail'}">${result.message}</div>`
            ).join('');
        }

        // Run tests on page load
        window.onload = function() {
            setTimeout(() => {
                test1();
                setTimeout(() => {
                    test2();
                    test3();
                }, 1000);
            }, 1000);
        };
    </script>
</body>
</html>
