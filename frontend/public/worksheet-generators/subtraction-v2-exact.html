<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Subtraction Worksheet - Exact Addition Pattern</title>
  <script src="js/translations.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <style>
    :root {
      --app-font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --app-bg-dark: #2c2c2e;
      --app-surface-dark: #3a3a3e;
      --app-border-dark: #4a4a4a;
      --app-text-primary-dark-theme: #e0e0e0;
      --app-text-secondary-dark-theme: #a0a0a0;
      --app-bg-light: #f0f2f5;
      --app-surface-light: #ffffff;
      --app-border-light: #dce1e6;
      --app-text-primary-light-theme: #1c1c1e;
      --app-text-secondary-light-theme: #545458;
      --app-accent-primary: #007aff;
      --sidebar-width: 340px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--app-font-stack);
      display: flex;
      margin: 0;
      height: 100vh;
      background-color: var(--app-bg-light);
      overflow: hidden;
      color: var(--app-text-primary-light-theme);
    }
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: 100vh;
    }
    .panel {
      width: var(--sidebar-width);
      background-color: var(--app-bg-dark);
      color: var(--app-text-primary-dark-theme);
      display: flex;
      flex-direction: column;
      overflow-y: hidden;
    }
    .panel-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--app-border-dark);
    }
    .panel-header h2 {
      font-size: 22px;
      color: var(--app-text-primary-dark-theme);
      margin: 0;
    }
    .panel-content {
      overflow-y: auto;
      flex-grow: 1;
      padding: 0;
    }
    .accordion-item {
      border-bottom: 1px solid var(--app-border-dark);
    }
    .accordion-button {
      background-color: transparent;
      color: var(--app-text-primary-dark-theme);
      width: 100%;
      border: none;
      text-align: left;
      padding: 18px 20px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-button::after {
      content: '\f078';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      font-size: 12px;
      transition: transform 0.2s;
    }
    .accordion-button.active::after {
      transform: rotate(-180deg);
    }
    .accordion-content {
      padding: 10px 15px 20px 15px;
      display: none;
      background: transparent;
    }
    .accordion-content.active {
      display: block;
    }
    .accordion-content label {
      display: block;
      font-size: 13px;
      color: var(--app-text-secondary-dark-theme);
      margin-bottom: 6px;
    }
    .accordion-content input[type="text"],
    .accordion-content input[type="number"],
    .accordion-content select {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 5px;
      border: 1px solid var(--app-border-dark);
      background-color: var(--app-surface-dark);
      color: var(--app-text-primary-dark-theme);
      margin-bottom: 12px;
    }
    .accordion-content h4 {
      font-size: 13px;
      color: var(--app-text-secondary-dark-theme);
      margin-top: 15px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--app-border-dark);
      padding-bottom: 6px;
    }
    .main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--app-bg-light);
    }
    .canvas-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel">
      <div class="panel-header">
        <h2>Subtraction Worksheet</h2>
      </div>
      <div class="panel-content">
        <!-- Page Setup - EXACTLY LIKE ADDITION APP -->
        <div class="accordion-item">
          <button class="accordion-button">Page Setup</button>
          <div class="accordion-content active">
            <label>Page Size:</label>
            <select id="pageSizeSelect">
              <option value="letter">Letter (8.5" x 11")</option>
              <option value="a4">A4</option>
            </select>

            <h4>Background</h4>
            <label for="backgroundThemeSelect">Background Theme:</label>
            <select id="backgroundThemeSelect">
              <option value="none" data-translate="none">None</option>
            </select>

            <h4>Border</h4>
            <label for="borderThemeSelect">Border Theme:</label>
            <select id="borderThemeSelect">
              <option value="none" data-translate="none">None</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="canvas-container">
        <canvas id="worksheetCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- SECOND SCRIPT TAG FOR ACCORDION SETUP -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const accordionButtons = document.querySelectorAll('.accordion-button');
      accordionButtons.forEach(button => {
        button.addEventListener('click', () => {
          const content = button.nextElementSibling;
          button.classList.toggle('active');
          content.classList.toggle('active');
        });
      });
      // Make first accordion active if none are
      if (accordionButtons.length > 0 && !document.querySelector('.accordion-button.active')) {
        accordionButtons[0].classList.add('active');
        if(accordionButtons[0].nextElementSibling) {
          accordionButtons[0].nextElementSibling.classList.add('active');
        }
      }
    });
  </script>

  <!-- MAIN SCRIPT TAG WITH ALL APP LOGIC -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // ALL CONST REFERENCES AT TOP
      const borderThemeSelect = document.getElementById('borderThemeSelect');
      const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');

      let worksheetCanvas;

      // Initialize canvas
      worksheetCanvas = new fabric.Canvas('worksheetCanvas', {
        width: 816,
        height: 1056,
        backgroundColor: 'white'
      });

      // EXACT COPY OF ADDITION APP'S loadBorderThemes
      async function loadBorderThemes() {
        try {
          // First option is always None
          borderThemeSelect.innerHTML = `<option value="none">${t('none')}</option>`;

          // Fetch actual themes from the filesystem API
          const response = await fetch('/api/borders/themes');
          if (!response.ok) {
            console.error('Failed to load border themes');
            return;
          }

          const themes = await response.json();

          // Add each theme as an option
          themes.forEach(theme => {
            // Handle both object format {value, displayName} and string format
            const themeValue = typeof theme === 'string' ? theme : theme.value;
            const displayName = typeof theme === 'string'
                ? theme.charAt(0).toUpperCase() + theme.slice(1)
                : theme.displayName;
            borderThemeSelect.innerHTML += `<option value="${themeValue}">${displayName}</option>`;
          });

          console.log('Loaded border themes:', borderThemeSelect.options.length);
        } catch (error) {
          console.error('Error loading border themes:', error);
        }
      }

      // EXACT COPY OF ADDITION APP'S loadBackgroundThemes
      async function loadBackgroundThemes() {
        try {
          // First option is always None
          backgroundThemeSelect.innerHTML = `<option value="none">${t('none')}</option>`;

          // Fetch actual themes from the filesystem API
          const response = await fetch('/api/backgrounds/themes');
          if (!response.ok) {
            console.error('Failed to load background themes');
            return;
          }

          const themes = await response.json();

          // Add each theme as an option
          themes.forEach(theme => {
            // Handle both object format {value, displayName} and string format
            const themeValue = typeof theme === 'string' ? theme : theme.value;
            const displayName = typeof theme === 'string'
                ? theme.charAt(0).toUpperCase() + theme.slice(1)
                : theme.displayName;
            backgroundThemeSelect.innerHTML += `<option value="${themeValue}">${displayName}</option>`;
          });

          console.log('Loaded background themes:', backgroundThemeSelect.options.length);
        } catch (error) {
          console.error('Error loading background themes:', error);
        }
      }

      // CALL FUNCTIONS EXACTLY LIKE ADDITION APP
      loadBorderThemes();
      loadBackgroundThemes();
    });
  </script>
</body>
</html>