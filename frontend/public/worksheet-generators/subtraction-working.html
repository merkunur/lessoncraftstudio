<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Subtraction Worksheet - Working Version</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .layout { display: flex; height: 100vh; }
    .panel { width: 380px; background: #2c2c2e; color: white; padding: 20px; overflow-y: auto; }
    .content { flex: 1; padding: 40px; background: #f5f5f5; }
    label { display: block; margin: 10px 0 5px; }
    select { width: 100%; padding: 8px; margin-bottom: 10px; }
    .dictionary { min-height: 100px; background: #3a3a3e; padding: 10px; margin-top: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="panel">
      <h2>Subtraction Worksheet</h2>

      <label>Border Theme:</label>
      <select id="borderThemeSelect">
        <option value="none">None</option>
      </select>
      <div id="borderDictionary" class="dictionary">Select a theme to see borders.</div>

      <label>Background Theme:</label>
      <select id="backgroundThemeSelect">
        <option value="none">None</option>
      </select>
      <div id="backgroundDictionary" class="dictionary">Select a theme for backgrounds.</div>
    </div>

    <div class="content">
      <h1>Subtraction Worksheet</h1>
      <canvas id="worksheetCanvas"></canvas>
    </div>
  </div>

  <script>
    // EXACTLY LIKE ADDITION.HTML - EVERYTHING INSIDE DOMContentLoaded
    document.addEventListener("DOMContentLoaded", function() {
      // ALL CONST REFERENCES AT THE TOP - EXACTLY LIKE ADDITION.HTML
      const borderThemeSelect = document.getElementById('borderThemeSelect');
      const borderDictionary = document.getElementById('borderDictionary');
      const backgroundThemeSelect = document.getElementById('backgroundThemeSelect');
      const backgroundDictionary = document.getElementById('backgroundDictionary');

      // Initialize canvas
      const worksheetCanvas = new fabric.Canvas('worksheetCanvas', {
        width: 816,
        height: 1056,
        backgroundColor: 'white'
      });

      // EXACT COPY OF ADDITION.HTML's loadBorderThemes
      async function loadBorderThemes() {
        try {
          // First option is always None
          borderThemeSelect.innerHTML = '<option value="none">None</option>';

          // Fetch actual themes from the filesystem API
          const response = await fetch('/api/borders/themes');
          if (!response.ok) {
            console.error('Failed to load border themes');
            return;
          }

          const themes = await response.json();

          // Add each theme as an option
          themes.forEach(theme => {
            // Handle both object format {value, displayName} and string format
            const themeValue = typeof theme === 'string' ? theme : theme.value;
            const displayName = typeof theme === 'string'
              ? theme.charAt(0).toUpperCase() + theme.slice(1)
              : theme.displayName;
            borderThemeSelect.innerHTML += `<option value="${themeValue}">${displayName}</option>`;
          });
        } catch (error) {
          console.error('Error loading border themes:', error);
        }
      }

      // EXACT COPY OF ADDITION.HTML's loadBackgroundThemes
      async function loadBackgroundThemes() {
        try {
          // First option is always None
          backgroundThemeSelect.innerHTML = '<option value="none">None</option>';

          // Fetch actual themes from the filesystem API
          const response = await fetch('/api/backgrounds/themes');
          if (!response.ok) {
            console.error('Failed to load background themes');
            return;
          }

          const themes = await response.json();

          // Add each theme as an option
          themes.forEach(theme => {
            // Handle both object format {value, displayName} and string format
            const themeValue = typeof theme === 'string' ? theme : theme.value;
            const displayName = typeof theme === 'string'
              ? theme.charAt(0).toUpperCase() + theme.slice(1)
              : theme.displayName;
            backgroundThemeSelect.innerHTML += `<option value="${themeValue}">${displayName}</option>`;
          });
        } catch (error) {
          console.error('Error loading background themes:', error);
        }
      }

      // Load border images when theme changes
      async function loadBorderImages() {
        const theme = borderThemeSelect.value;

        if (theme === 'none') {
          borderDictionary.innerHTML = 'Select a theme to see borders.';
          return;
        }

        borderDictionary.innerHTML = 'Loading borders...';

        try {
          const response = await fetch(`/api/borders/images?theme=${theme}`);
          const data = await response.json();
          const images = data.images || data;

          borderDictionary.innerHTML = '';

          images.forEach(border => {
            const img = document.createElement('img');
            img.src = border.path;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.margin = '5px';
            img.style.cursor = 'pointer';
            borderDictionary.appendChild(img);
          });
        } catch (error) {
          console.error('Error loading borders:', error);
          borderDictionary.innerHTML = 'Error loading borders.';
        }
      }

      // Load background images when theme changes
      async function loadBackgroundImages() {
        const theme = backgroundThemeSelect.value;

        if (theme === 'none') {
          backgroundDictionary.innerHTML = 'Select a theme for backgrounds.';
          return;
        }

        backgroundDictionary.innerHTML = 'Loading backgrounds...';

        try {
          const response = await fetch(`/api/backgrounds/images?theme=${theme}`);
          const data = await response.json();
          const images = data.images || data;

          backgroundDictionary.innerHTML = '';

          images.forEach(bg => {
            const img = document.createElement('img');
            img.src = bg.path;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.margin = '5px';
            img.style.cursor = 'pointer';
            backgroundDictionary.appendChild(img);
          });
        } catch (error) {
          console.error('Error loading backgrounds:', error);
          backgroundDictionary.innerHTML = 'Error loading backgrounds.';
        }
      }

      // Set up event listeners
      borderThemeSelect.addEventListener('change', loadBorderImages);
      backgroundThemeSelect.addEventListener('change', loadBackgroundImages);

      // INITIALIZE - CALL EXACTLY LIKE ADDITION.HTML
      loadBorderThemes();
      loadBackgroundThemes();
    });
  </script>
</body>
</html>